package org.opentestsystem.rdw.ingest.tasking.service.impl;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.security.oauth2.client.OAuth2RestTemplate;
import org.springframework.web.client.RestTemplate;

import org.opentestsystem.rdw.common.status.Rating;
import org.opentestsystem.rdw.common.status.UnitStatus;
import org.opentestsystem.rdw.ingest.common.model.RdwImport;
import org.opentestsystem.rdw.ingest.tasking.UpdateOrganizationsConfiguration;
import org.opentestsystem.rdw.ingest.tasking.service.ImportServiceClient;
import org.opentestsystem.rdw.multitenant.task.ImportServiceClientProperties;

/**
 * An {@link ImportServiceClient} that uses REST API.<br/>
 *
 * This is instantiated explicitly by {@link UpdateOrganizationsConfiguration} so it is not
 * annotated as an autowired service.<br/>
 *
 * The import service properties are expected to be tenant-aware, resolving to the current
 * tenant. That's why the rest template must be created for each call.
 */
public class RestImportServiceClient implements ImportServiceClient {
    private static final Logger logger = LoggerFactory.getLogger(RestImportServiceClient.class);

    private final ImportServiceClientProperties properties;

    public RestImportServiceClient(final ImportServiceClientProperties properties) {
        this.properties = properties;
    }

    @Override
    public void postOrganizationPayload(final byte[] payload) {
        final RestTemplate restTemplate = new OAuth2RestTemplate(properties.getOauth2());

        final HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        final HttpEntity<byte[]> request = new HttpEntity<>(payload, headers);

        final RdwImport rdwImport = restTemplate.postForObject(properties.getOrganizationsImportsUrl(), request, RdwImport.class);
        if (rdwImport.getStatus().getValue() < 0) {
            logger.warn("organization import not accepted, id: {}, status: {}", rdwImport.getId(), rdwImport.getStatus());
        } else {
            logger.info("posted organizations import, id: {}, status: {}", rdwImport.getId(), rdwImport.getStatus());
        }
    }

    @Override
    public Rating getDiagnosticRating() {
        final RestTemplate restTemplate = new OAuth2RestTemplate(properties.getOauth2());

        final UnitStatus status = restTemplate.getForObject(properties.getStatusUrl(), UnitStatus.class);
        return Rating.valueOf(status.getStatusText());
    }
}
