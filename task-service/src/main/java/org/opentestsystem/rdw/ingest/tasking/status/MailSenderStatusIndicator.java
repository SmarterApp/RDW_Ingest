package org.opentestsystem.rdw.ingest.tasking.status;

import org.opentestsystem.rdw.ingest.common.status.AbstractStatusIndicator;
import org.opentestsystem.rdw.ingest.common.status.DiagnosticLevel;
import org.opentestsystem.rdw.ingest.common.status.Rating;
import org.opentestsystem.rdw.ingest.common.status.Status;
import org.opentestsystem.rdw.ingest.common.status.StatusIndicator;
import org.opentestsystem.rdw.ingest.tasking.service.impl.LoggingJavaMailSender;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.JavaMailSenderImpl;
import org.springframework.stereotype.Component;

import javax.mail.MessagingException;

/**
 * A {@link StatusIndicator} for email status.
 * <p>
 * Verifies the spring mail cloud settings are configured correctly.
 * </p>
 */
@Component
public class MailSenderStatusIndicator extends AbstractStatusIndicator {
    private final JavaMailSender javaMailSender;

    @Autowired
    public MailSenderStatusIndicator(final JavaMailSender javaMailSender) {
        this.javaMailSender = javaMailSender;
    }

    @Override
    public String name() {
        return "mail-sender";
    }

    @Override
    protected void doStatusCheck(final Status.Builder builder, final int level) {
        final Status status = getMailStatus();
        builder.detail("mail-status", status).rating(Rating.valueOf(status.getStatusText()));
    }

    private Status getMailStatus() {
        if (javaMailSender instanceof LoggingJavaMailSender) {
            return warning("The mail sender has been configured to write to the logs.  This only OK in Development.");
        }

        final JavaMailSenderImpl springMailSender = (JavaMailSenderImpl) javaMailSender;
        if (springMailSender == null) {
           return warning("Failed to load the Spring implementation of JavaMailSender");
        }

        try {
            springMailSender.testConnection();
            return Status.builder().detail("info", "Successfully connected to the configured SMTP host").rating(Rating.Ideal).build();
        } catch (final MessagingException e) {
            return Status.builder().detail("error", "Failed to connect to the configured SMTP host: " + e.getMessage()).rating(Rating.Failed).build();
        }
    }

    private Status warning(final String message) {
        return Status
                .builder()
                .detail("warning", message)
                .rating(Rating.Warning)
                .build();
    }

    @Override
    protected boolean doLevelCheck(final int level) {
        return DiagnosticLevel.ExternalDependencies.isLessThanOrEqualTo(level);
    }
}
