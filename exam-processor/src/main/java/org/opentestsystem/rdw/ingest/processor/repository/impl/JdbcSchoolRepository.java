package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.opentestsystem.rdw.ingest.processor.model.School;
import org.opentestsystem.rdw.ingest.processor.repository.SchoolRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.stereotype.Repository;

@Repository
class JdbcSchoolRepository implements SchoolRepository {

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    JdbcSchoolRepository(final JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    @Cacheable(value = "school", key = "#school")
    public int upsert(final School school, final long importId) {
        return (int) new SimpleJdbcCall(jdbcTemplate)
                .withProcedureName("school_upsert").execute(new MapSqlParameterSource()
                        .addValue("p_district_natural_id", school.getDistrict().getNaturalId())
                        .addValue("p_district_name", school.getDistrict().getName())
                        .addValue("p_name", school.getName())
                        .addValue("p_natural_id", school.getNaturalId())
                        .addValue("p_import_id", importId)).get("p_id");
    }
}
