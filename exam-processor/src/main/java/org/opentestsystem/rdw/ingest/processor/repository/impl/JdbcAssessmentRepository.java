package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.SubjectClaimScore;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Map;

import static com.google.common.collect.Maps.newHashMap;

@Repository
class JdbcAssessmentRepository implements AssessmentRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.assessment.findOneByNaturalId}")
    private String sqlFindOneByNaturalId;

    @Value("${sql.assessment.subjectClaimScore.findBySubjectAndAsmtType}")
    private String sqlfindSubjectClaimScores;

    @Value("${sql.assessment.item.findAllForAssessment}")
    private String sqlfindAllItemsForAssessment;

    @Autowired
    JdbcAssessmentRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Transactional(readOnly = true)
    @Override
    public Assessment findOneByNaturalId(final String id) {

        final List<Assessment.Builder> assessmentList = jdbcTemplate.query(sqlFindOneByNaturalId, new MapSqlParameterSource("natural_id", id), new AssessmentRowMapper());
        if (assessmentList.size() == 1) {
            final Assessment partiallyBuiltAssessment = assessmentList.get(0).build();
            return appendItemData(assessmentList.get(0)
                    .claims(findSubjectClaimScores(partiallyBuiltAssessment)), partiallyBuiltAssessment)
                    .build();
        }
        return null;
    }

    private List<SubjectClaimScore> findSubjectClaimScores(final Assessment assessment) {
        return jdbcTemplate.query(sqlfindSubjectClaimScores,
                new MapSqlParameterSource()
                        .addValue("subject_id", assessment.getSubjectId())
                        .addValue("asmt_type_id", assessment.getTypeId()),
                new ClaimRowMapper());
    }

    private Assessment.Builder appendItemData(final Assessment.Builder builder, final Assessment assessment) {
        final Map<String, Integer> idsByNaturalId = newHashMap();
        final Map<String, Integer> targetCodeToId = newHashMap();
        jdbcTemplate.query(
                sqlfindAllItemsForAssessment,
                new MapSqlParameterSource("asmt_id", assessment.getId()),
                (rs, rowNum) -> {
                    idsByNaturalId.put(rs.getString("natural_id"), rs.getInt("id"));
                    targetCodeToId.putIfAbsent(rs.getString("target_code"), rs.getInt("target_id"));
                    return rs;
                });

        return builder
                .items(idsByNaturalId)
                .targetCodeToId(targetCodeToId);
    }

    private static class AssessmentRowMapper implements RowMapper<Assessment.Builder> {
        @Override
        public Assessment.Builder mapRow(final ResultSet rs, final int rowNum) throws SQLException {
            return Assessment.builder()
                    .id(rs.getInt("id"))
                    .naturalId(rs.getString("natural_id"))
                    .gradeCode(rs.getString("grade_code"))
                    .typeId(rs.getInt("type_id"))
                    .subjectId(rs.getInt("subject_id"))
                    .subjectCode(rs.getString("subject_code"));
        }
    }

    private static class ClaimRowMapper implements RowMapper<SubjectClaimScore> {
        @Override
        public SubjectClaimScore mapRow(final ResultSet rs, final int rowNum) throws SQLException {
            return new SubjectClaimScore(rs.getString("code"), rs.getInt("id"));
        }
    }
}
