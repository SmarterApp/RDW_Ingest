package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.opentestsystem.rdw.ingest.model.ImportException;
import org.opentestsystem.rdw.ingest.processor.model.StudentExamAttributes;
import org.opentestsystem.rdw.ingest.processor.repository.SchoolRepository;
import org.opentestsystem.rdw.ingest.processor.repository.StudentRepository;
import org.opentestsystem.rdw.ingest.processor.service.ParsedExaminee;
import org.opentestsystem.rdw.ingest.processor.service.ParsedExamineeProcessor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class DefaultParsedExamineeProcessor implements ParsedExamineeProcessor {

    private final SchoolRepository schoolRepository;
    private final StudentRepository studentRepository;

    @Autowired
    public DefaultParsedExamineeProcessor(final SchoolRepository schoolRepository,
                                          final StudentRepository studentRepository) {
        this.schoolRepository = schoolRepository;
        this.studentRepository = studentRepository;
    }

    @Override
    public StudentExamAttributes process(final ParsedExaminee parsedExaminee) throws ImportException {
        final int schoolId = schoolRepository.upsert(parsedExaminee.getSchool());
        final long studentId = studentRepository.upsert(parsedExaminee.getStudent());

        return parsedExaminee.getStudentExamAttributeBuilder()
                .withResponsibleSchoolId(schoolId)
                .withStudentId(studentId)
                .build();
    }
}
