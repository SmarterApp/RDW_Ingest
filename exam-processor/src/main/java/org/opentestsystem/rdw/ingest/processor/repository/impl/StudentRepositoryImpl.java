package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.repository.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.simple.SimpleJdbcCall;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

@Repository
class StudentRepositoryImpl implements StudentRepository {

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    public StudentRepositoryImpl(final JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Transactional
    @Override
    public long upsert(final Student student) {
        return (long) new SimpleJdbcCall(jdbcTemplate)
                .withProcedureName("student_upsert")
                .execute(new MapSqlParameterSource()
                        .addValue("p_ssid", student.getSsid())
                        .addValue("p_last_or_surname", student.getLastOrSurname())
                        .addValue("p_first_name", student.getFirstName())
                        .addValue("p_middle_name", student.getMiddleName())
                        .addValue("p_gender_id", student.getGenderId())
                        .addValue("p_ethnicity_id", student.getEthnicityId())
                        .addValue("p_first_entry_into_us_school_at", student.getFirsEntryIntoUSSchoolAt())
                        .addValue("p_lep_entry_at", student.getLepEntryAt())
                        .addValue("p_lep_exit_at", student.getLepExitAt())
                        .addValue("p_birthday", student.getBirthday()))
                .get("p_id");
    }
}
