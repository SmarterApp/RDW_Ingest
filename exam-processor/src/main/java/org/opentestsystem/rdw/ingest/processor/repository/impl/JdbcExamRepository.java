package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.opentestsystem.rdw.ingest.processor.model.Exam;
import org.opentestsystem.rdw.ingest.processor.model.ExamClaim;
import org.opentestsystem.rdw.ingest.processor.model.ExamItem;
import org.opentestsystem.rdw.ingest.processor.model.ExamItemSubScore;
import org.opentestsystem.rdw.ingest.processor.model.StudentExamAttributes;
import org.opentestsystem.rdw.ingest.processor.repository.ExamRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.sql.Timestamp;
import java.util.List;

import static org.opentestsystem.rdw.ingest.common.repository.JdbcUtils.safeText;

@Repository
class JdbcExamRepository implements ExamRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.exam.examClaimScore.create}")
    private String sqlExamClaimScoreCreate;

    @Value("${sql.exam.examStudent.create}")
    private String sqlExamStudentCreate;

    @Value("${sql.exam.examItem.create}")
    private String sqlExamItemCreate;

    @Value("${sql.exam.create}")
    private String sqlCreate;

    @Value("${sql.exam.accommodation.create}")
    private String sqlExamAccommodationCreate;

    @Autowired
    JdbcExamRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    @Transactional
    public long create(final Exam exam, final long importId) {

        final long studentExamId = create(exam.getStudentExamAttributes(), exam.getStudentId());

        final KeyHolder keyHolder = new GeneratedKeyHolder();
        final SqlParameterSource parameterSource = new MapSqlParameterSource()
                .addValue("exam_student_id", studentExamId)
                .addValue("type_id", exam.getTypeId())
                .addValue("school_year", exam.getSchoolYear())
                .addValue("import_id", importId)
                .addValue("update_import_id", importId)
                .addValue("asmt_id", exam.getAssessmentId())
                .addValue("asmt_version", exam.getAsmtVersion())
                .addValue("opportunity", exam.getOpportunity())
                .addValue("completeness_id", exam.getCompletenessId())
                .addValue("administration_condition_id", exam.getAdministrationConditionId())
                .addValue("session_id", exam.getSessionId())
                .addValue("scale_score", exam.getScaleScore())
                .addValue("scale_score_std_err", exam.getScaleScoreStdErr())
                .addValue("performance_level", exam.getPerformanceLevel())
                .addValue("completed_at", Timestamp.from(exam.getCompletedAt()));

        jdbcTemplate.update(sqlCreate, parameterSource, keyHolder);
        final Long id = keyHolder.getKey().longValue();
        batchCreateExamClaims(exam.getExamClaims(), id);
        batchCreateExamItems(exam.getExamItems(), id);
        batchAddAccommodations(exam.getAccommodationIds(), id);
        return id;
    }

    private void batchCreateExamClaims(final List<ExamClaim> examClaims, final long examId) {
        if (examClaims.isEmpty()) return;

        final SqlParameterSource[] batchParameters = examClaims.stream()
                .map(examClaim -> new MapSqlParameterSource("exam_id", examId)
                        .addValue("subject_claim_score_id", examClaim.getClaimId())
                        .addValue("scale_score", examClaim.getScaleScore())
                        .addValue("scale_score_std_err", examClaim.getScaleScoreStdErr())
                        .addValue("category", examClaim.getCategory()))
                .toArray(MapSqlParameterSource[]::new);

        jdbcTemplate.batchUpdate(sqlExamClaimScoreCreate, batchParameters);
    }

    private long create(final StudentExamAttributes studentExamAttributes, final long studentId) {
        final KeyHolder keyHolder = new GeneratedKeyHolder();
        final SqlParameterSource parameterSource = new MapSqlParameterSource()
                .addValue("grade_id", studentExamAttributes.getGradeId())
                .addValue("student_id", studentId)
                .addValue("school_id", studentExamAttributes.getResponsibleSchoolId())
                .addValue("iep", studentExamAttributes.getIdeaIndicator())
                .addValue("lep", studentExamAttributes.getLep())
                .addValue("section504", studentExamAttributes.getSection504())
                .addValue("economic_disadvantage", studentExamAttributes.getEconomicDisadvantage())
                .addValue("migrant_status", studentExamAttributes.getMigrantStatus())
                .addValue("eng_prof_lvl", studentExamAttributes.getEngProfLvl())
                .addValue("t3_program_type", studentExamAttributes.getT3ProgramType())
                .addValue("language_code", studentExamAttributes.getLanguageCode())
                .addValue("prim_disability_type", studentExamAttributes.getPrimDisabilityType());

        jdbcTemplate.update(sqlExamStudentCreate, parameterSource, keyHolder);
        return keyHolder.getKey().longValue();
    }

    private void batchCreateExamItems(final List<ExamItem> examItems, final long examId) {
        if (examItems.isEmpty()) return;

        final MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[examItems.size()];
        for (int i = 0; i < examItems.size(); i++) {
            final ExamItem examItem = examItems.get(i);
            batchParameters[i] = new MapSqlParameterSource("exam_id", examId)
                    .addValue("item_id", examItem.getItemId())
                    .addValue("response", safeText(examItem.getResponse()))
                    .addValue("score_status", examItem.getScoreStatus())
                    .addValue("score", examItem.getScore())
                    .addValue("position", examItem.getPosition());

            final ExamItemSubScore evidenceElaborationScore = examItem.getEvidenceAndElaborationSubScore();
            batchParameters[i].addValue("trait_evidence_elaboration_score", evidenceElaborationScore == null ? null : evidenceElaborationScore.getScore())
                    .addValue("trait_evidence_elaboration_score_status", evidenceElaborationScore == null ? null : evidenceElaborationScore.getScoreStatus());

            final ExamItemSubScore organizationPurposeSubScore = examItem.getOrganizationAndPurposeSubScore();
            batchParameters[i].addValue("trait_organization_purpose_score", organizationPurposeSubScore == null ? null : organizationPurposeSubScore.getScore())
                    .addValue("trait_organization_purpose_score_status", organizationPurposeSubScore == null ? null : organizationPurposeSubScore.getScoreStatus());

            final ExamItemSubScore conventionsSubScore = examItem.getConventionsSubScore();
            batchParameters[i].addValue("trait_conventions_score", conventionsSubScore == null ? null : conventionsSubScore.getScore())
                    .addValue("trait_conventions_score_status", conventionsSubScore == null ? null : conventionsSubScore.getScoreStatus());
        }

        jdbcTemplate.batchUpdate(sqlExamItemCreate, batchParameters);
    }

    private void batchAddAccommodations(final List<Integer> accommodationIds, final long examId) {
        if (accommodationIds.isEmpty()) return;

        final MapSqlParameterSource[] batchParameters = new MapSqlParameterSource[accommodationIds.size()];
        for (int i = 0; i < accommodationIds.size(); i++) {
            final Integer accommodationId = accommodationIds.get(i);
            batchParameters[i] = new MapSqlParameterSource("exam_id", examId)
                    .addValue("accommodation_id", accommodationId);
        }

        jdbcTemplate.batchUpdate(sqlExamAccommodationCreate, batchParameters);
    }

}
