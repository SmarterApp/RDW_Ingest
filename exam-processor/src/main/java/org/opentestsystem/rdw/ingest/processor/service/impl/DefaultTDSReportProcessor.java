package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.opentestsystem.rdw.common.model.AssessmentType;
import org.opentestsystem.rdw.common.model.trt.Examinee;
import org.opentestsystem.rdw.common.model.trt.Opportunity;
import org.opentestsystem.rdw.common.model.trt.TDSReport;
import org.opentestsystem.rdw.common.model.trt.Test;
import org.opentestsystem.rdw.ingest.common.model.ImportException;
import org.opentestsystem.rdw.ingest.common.repository.SchoolRepository;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Exam;
import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.repository.StubbedOutAssessmentRepository;
import org.opentestsystem.rdw.ingest.processor.repository.SubjectRepository;
import org.opentestsystem.rdw.ingest.processor.service.AssessmentService;
import org.opentestsystem.rdw.ingest.processor.service.ExamineeProcessor;
import org.opentestsystem.rdw.ingest.processor.service.StudentExamProcessor;
import org.opentestsystem.rdw.ingest.processor.service.StudentExamWriter;
import org.opentestsystem.rdw.ingest.processor.service.TDSReportProcessor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Map;

import static com.google.common.collect.Maps.newHashMap;
import static org.opentestsystem.rdw.ingest.common.model.ImportStatus.BAD_DATA;

@Service
class DefaultTDSReportProcessor implements TDSReportProcessor {

    private final StudentExamProcessor studentExamProcessor;
    private final AssessmentService assessmentService;
    private final ExamineeProcessor examineeProcessor;
    private final SchoolRepository schoolRepository;
    private final StudentExamWriter writer;
    //TODO: remove the stubbed out repository dependency once we can ingest assessment packages
    private final StubbedOutAssessmentRepository stubbedOutAssessmentRepository;
    private final SubjectRepository subjectRepository;

    @Autowired
    DefaultTDSReportProcessor(final StudentExamProcessor studentExamProcessor,
                              final AssessmentService assessmentService,
                              final ExamineeProcessor examineeProcessor,
                              final StudentExamWriter writer,
                              final SchoolRepository schoolRepository,
                              final SubjectRepository subjectRepository,
                              final StubbedOutAssessmentRepository stubbedOutAssessmentRepository) {
        this.studentExamProcessor = studentExamProcessor;
        this.assessmentService = assessmentService;
        this.examineeProcessor = examineeProcessor;
        this.schoolRepository = schoolRepository;
        this.writer = writer;

        this.subjectRepository = subjectRepository;
        this.stubbedOutAssessmentRepository = stubbedOutAssessmentRepository;

    }

    @Override
    public void process(final TDSReport report, final long importId) throws ImportException {
        try {
            final Examinee examinee = report.getExaminee();
            if (examinee == null) throw new IllegalArgumentException("Examinee may not be null");

            final Assessment assessment = findOrCreateAssessment(report, importId);
            //TODO: remove the upsert here when we stop supporting the stubbed out schools
            final int schoolId = schoolRepository.upsert(examineeProcessor.parseExamineeRelationship(examinee), importId);

            final Exam exam = studentExamProcessor.parseExam(report, schoolId, assessment);
            final Student student = examineeProcessor.parseStudent(examinee, exam.getSchoolYear(), schoolId);

            writer.saveNewExam(student, exam, importId);

        } catch (final IllegalArgumentException e) {
            throw new ImportException(BAD_DATA, e.getMessage());
        }
    }

    private Assessment findOrCreateAssessment(final TDSReport report, final long importId) {
        try {
            return assessmentService.findOneForTest(report.getTest());
        } catch (final ImportException ex) {
            //TODO: remove this error handling when we stop supporting the stubbed out asmt
            final Test test = report.getTest();

            final Map<String, Integer> items = newHashMap();
            for (final Opportunity.Item item : report.getOpportunity().getItem()) {
                final String naturalId = Long.toString(item.getBankKey()) + "-" + item.getKey();
                items.put(naturalId, null);
            }
            return stubbedOutAssessmentRepository.create(Assessment.builder()
                    .naturalId(test.getName())
                    .name(test.getTestId())
                    .label(test.getTestId())
                    .schoolYear((int) test.getAcademicYear())
                    .gradeId(3)
                    .subjectId(subjectRepository.findIdByCode(test.getSubject()))
                    .typeId(test.getTestId().contains("IAB") ? AssessmentType.IAB.id() : AssessmentType.ICA.id())
                    .items(items)
                    .build(), importId);
        }
    }
}
