package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.opentestsystem.rdw.ingest.processor.model.Exam;
import org.opentestsystem.rdw.ingest.processor.model.ExamSchool;
import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.model.StudentGroup;
import org.opentestsystem.rdw.ingest.processor.repository.ExamRepository;
import org.opentestsystem.rdw.ingest.processor.repository.StudentGroupRepository;
import org.opentestsystem.rdw.ingest.processor.repository.StudentRepository;
import org.opentestsystem.rdw.ingest.processor.service.StudentExamWriter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;

@Service
class DefaultStudentExamWriter implements StudentExamWriter {
    private static final Logger logger = LoggerFactory.getLogger(DefaultStudentExamWriter.class);

    private final ExamRepository examRepository;
    private final StudentGroupRepository studentGroupRepository;
    private final StudentRepository studentRepository;

    @Autowired
    DefaultStudentExamWriter(final ExamRepository examRepository,
                             final StudentGroupRepository studentGroupRepository,
                             final StudentRepository studentRepository) {
        this.examRepository = examRepository;
        this.studentGroupRepository = studentGroupRepository;
        this.studentRepository = studentRepository;

    }

    @Override
    public void upsert(final Student student, final Exam exam, final long importId) {
        if (exam.isDeleted()) {
            logger.info("Deleting Exam. Import: {}, AssessmentId: {}, OpportunityId: {}",
                    importId, exam.getAssessmentId(), exam.getOppId());
            // must delete the exam before updating student so upsert can properly infer school for the student
            examRepository.delete(exam, importId);
            studentRepository.upsert(student, importId);
        } else {
            // take school and competed at date from the given exam
            student.setSchool(new ExamSchool(exam.getStudentExamAttributes().getResponsibleSchoolId(), exam.getCompletedAt()));
            final int studentId = studentRepository.upsert(student, importId);
            exam.getStudentExamAttributes().setStudentId(studentId);
            examRepository.upsert(exam, importId);

            final List<Integer> groupIds = newArrayList();
            // deal with student groups: create and add student to them if needed
            for (final StudentGroup group : student.getGroups()) {
                final Integer groupId = studentGroupRepository.findIdByNameAndSchoolAndYear(group.getName(), group.getSchoolId(), group.getSchoolYear());
                if (groupId == null) groupIds.add(studentGroupRepository.upsert(group, importId).getId());
                else if (!studentGroupRepository.existsStudentInGroup(studentId, groupId)) groupIds.add(groupId);
            }
            if (!groupIds.isEmpty()) studentGroupRepository.addStudentToGroups(studentId, groupIds, importId);
        }
    }
}