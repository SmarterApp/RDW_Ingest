package org.opentestsystem.rdw.ingest.processor.repository.impl;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Claim;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;

//TODO: this should be a read only repository once we have an assessment loader
@Repository
class AssessmentRepositoryImpl implements AssessmentRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.assessment.findOneByNaturalId}")
    private String slqFindOneByNaturalId;

    @Value("${sql.assessment.create}")
    private String sqlCreate;

    @Value("${sql.assessment.claim.findForAsmt}")
    private String sqlClaimFindForAsmt;

    @Value("${sql.assessment.claim.createForAsmt}")
    private String sqlClaimCreateForAsmt;

    @Autowired
    public AssessmentRepositoryImpl(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    public Assessment findOneByNaturalId(final String id) {

        final List<Assessment.Builder> assessmentList = jdbcTemplate.query(slqFindOneByNaturalId, new MapSqlParameterSource("natural_id", id), new AssessmentRowMapper());
        if (assessmentList.size() == 1) {
            return assessmentList
                    .get(0)
                    .withClaims(jdbcTemplate.query(sqlClaimFindForAsmt,
                            new MapSqlParameterSource("asmt_id", assessmentList.get(0).build().getId()),
                            new ClaimRowMapper()))
                    .build();

        }
        //TODO
        return null;
    }

    @Override
    public Assessment create(final Assessment assessment) {

        KeyHolder keyHolder = new GeneratedKeyHolder();
        SqlParameterSource parameterSource = new MapSqlParameterSource()
                .addValue("natural_id", assessment.getNaturalId())
                .addValue("grade_id", assessment.getGradeId())
                .addValue("type_id", assessment.getTypeId())
                .addValue("subject_id", assessment.getSubjectId())
                .addValue("academic_year", assessment.getAcademicYear())
                .addValue("name", assessment.getName())
                .addValue("label", assessment.getLabel())
                .addValue("version", assessment.getVersion());

        jdbcTemplate.update(sqlCreate, parameterSource, keyHolder);
        final Integer asmtId = keyHolder.getKey().intValue();
        batchCreateClaims(assessment.getClaims(), asmtId);
        return Assessment.builder().withCopy(assessment).withClaims(jdbcTemplate.query(sqlClaimFindForAsmt, new MapSqlParameterSource("asmt_id", asmtId), new ClaimRowMapper())).withId(asmtId).build();

    }

    protected void batchCreateClaims(final List<Claim> claims, final long assessmentId) {
        SqlParameterSource[] batchParameters = claims.stream()
                .map(claim -> new MapSqlParameterSource("asmt_id", assessmentId)
                        .addValue("min_score", claim.getMinScore())
                        .addValue("max_score", claim.getMaxScore())
                        .addValue("code", claim.getCode()))
                .toArray(MapSqlParameterSource[]::new);

        jdbcTemplate.batchUpdate(sqlClaimCreateForAsmt, batchParameters);

    }

    private static class AssessmentRowMapper implements RowMapper<Assessment.Builder> {
        @Override
        public Assessment.Builder mapRow(ResultSet rs, int rowNum) throws SQLException {
            return Assessment.builder()
                    .withId(rs.getInt("id"))
                    .withNaturalId(rs.getString("natural_id"))
                    .withGradeId(rs.getInt("grade_id"))
                    .withTypeId(rs.getInt("type_id"))
                    .withSubjectId(rs.getInt("subject_id"))
                    .withAcademicYear(rs.getInt("academic_year"))
                    .withName(rs.getString("name"))
                    .withLabel(rs.getString("label"))
                    .withVersion(rs.getString("version"));

        }
    }

    private static class ClaimRowMapper implements RowMapper<Claim> {
        @Override
        public Claim mapRow(ResultSet rs, int rowNum) throws SQLException {
            return Claim.builder()
                    .withCode(rs.getString("code"))
                    .withMaxScore(rs.getFloat("max_score"))
                    .withMinScore(rs.getFloat("min_score"))
                    .withId(rs.getInt("id"))
                    .build();

        }
    }
}
