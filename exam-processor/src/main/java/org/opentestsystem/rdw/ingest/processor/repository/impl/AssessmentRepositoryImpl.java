package org.opentestsystem.rdw.ingest.processor.repository.impl;

import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.SubjectClaimScore;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

@Repository
class AssessmentRepositoryImpl implements AssessmentRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.assessment.findOneByNaturalId}")
    private String slqFindOneByNaturalId;

    @Value("${sql.assessment.subjectClaimScore.findBySubjectAndAsmtType}")
    private String sqlfindSubjectClaimScores;

    @Autowired
    public AssessmentRepositoryImpl(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Transactional(readOnly = true)
    @Override
    //TODO: consider caching here
    public Assessment findOneByNaturalId(final String id) {

        final List<Assessment.Builder> assessmentList = jdbcTemplate.query(slqFindOneByNaturalId, new MapSqlParameterSource("natural_id", id), new AssessmentRowMapper());
        if (assessmentList.size() == 1) {
            return assessmentList
                    .get(0)
                    .withClaims(findSubjectClaimScores(assessmentList.get(0).build()))
                    .build();
        }
        return null;
    }

    private List<SubjectClaimScore> findSubjectClaimScores(final Assessment assessment) {
        return jdbcTemplate.query(sqlfindSubjectClaimScores,
                new MapSqlParameterSource()
                        .addValue("subject_id", assessment.getSubjectId())
                        .addValue("asmt_type_id", assessment.getTypeId()),
                new ClaimRowMapper());
    }

    private static class AssessmentRowMapper implements RowMapper<Assessment.Builder> {
        @Override
        public Assessment.Builder mapRow(final ResultSet rs, final int rowNum) throws SQLException {
            return Assessment.builder()
                    .withId(rs.getInt("id"))
                    .withNaturalId(rs.getString("natural_id"))
                    .withGradeId(rs.getInt("grade_id"))
                    .withTypeId(rs.getInt("type_id"))
                    .withSubjectId(rs.getInt("subject_id"))
                    .withAcademicYear(rs.getInt("academic_year"));
        }
    }

    private static class ClaimRowMapper implements RowMapper<SubjectClaimScore> {
        @Override
        public SubjectClaimScore mapRow(final ResultSet rs, final int rowNum) throws SQLException {
            return new SubjectClaimScore(rs.getString("code"), rs.getInt("id"));
        }
    }
}
