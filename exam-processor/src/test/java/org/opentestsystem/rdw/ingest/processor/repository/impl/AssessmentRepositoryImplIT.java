package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Claim;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import static java.util.stream.Collectors.toList;
import static org.assertj.core.api.Assertions.assertThat;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class AssessmentRepositoryImplIT {

    @Autowired
    private AssessmentRepository repository;

    @Test
    @Sql(statements = "INSERT INTO asmt (id, natural_id, grade_id, type_id, subject_id, academic_year, name, label, version) VALUES " +
            "(22, 'exam natural id', 4, 2, 1, 2016, 'SBAC-IAB-FIXED-G4M-OA-MATH-4', 'MTH IAB G4 OperationsAlgebraicThinking', '9835'); " +
            "INSERT INTO claim (id, asmt_id, min_score, max_score, code) VALUES\n" +
            "  (1, 22, null, null, 'SBAC-2-W'),\n" +
            "  (2, 22, null, null, 'SBAC-4-CR'),\n" +
            "  (3, 22, null, null, 'SOCK_LS'),\n" +
            "  (4, 22, null, null, 'SOCK_R');")
    public void itShouldFindAssessmentByNaturalId() {
        final Assessment assessment = repository.findOneByNaturalId("exam natural id");

        assertThat(assessment.getId()).isEqualTo(22);
        assertThat(assessment.getAcademicYear()).isEqualTo(2016);
        assertThat(assessment.getGradeId()).isEqualTo(4);
        assertThat(assessment.getLabel()).isEqualTo("MTH IAB G4 OperationsAlgebraicThinking");
        assertThat(assessment.getName()).isEqualTo("SBAC-IAB-FIXED-G4M-OA-MATH-4");
        assertThat(assessment.getNaturalId()).isEqualTo("exam natural id");
        assertThat(assessment.getSubjectId()).isEqualTo(1);
        assertThat(assessment.getTypeId()).isEqualTo(2);
        assertThat(assessment.getVersion()).isEqualTo("9835");
        assertThat(assessment.getClaims().stream().map(Claim::getCode).collect(toList())).containsExactlyInAnyOrder("SBAC-2-W", "SBAC-4-CR", "SOCK_LS", "SOCK_R");
    }

    @Test
    public void itShouldReturnNullWhenNotFound() {
        assertThat(repository.findOneByNaturalId("exam natural id")).isNull();
    }
}