package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.processor.model.StudentGroup;
import org.opentestsystem.rdw.ingest.processor.repository.StudentGroupRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import java.time.Instant;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTable;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
@ActiveProfiles("test")
@Sql(statements = {
        "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
        "INSERT INTO subject (id, name) VALUES (-11, 'SCIENCE');",
        "INSERT INTO district (id, natural_id, name) VALUES (-20, 'DS009', 'District 9');",
        "INSERT INTO school (id, district_id, natural_id, name, import_id) VALUES (-21, -20, 'S001', 'School 1', -99);",
        "INSERT INTO student (id, ssid, last_or_surname, first_name, gender_id, birthday, import_id) VALUES " +
                "(-100, '100', 'Smith', 'Alice', 2, '2004-09-02', -99), " +
                "(-101, '101', 'Jones', 'Bob', 1, '2004-03-02', -99)"
})
public class StudentGroupRepositoryImplIT {

    @Autowired
    private StudentGroupRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private final long importId = -99;

    @Test
    public void itShouldCreateAndFindGroups() {
        repository.create(createTestGroup("one"), importId);
        repository.create(createTestGroup("two"), importId);

        assertThat(repository.findIdByNameAndSchoolAndYear("one", -21, 2017)).isNotNull();
        assertThat(repository.findIdByNameAndSchoolAndYear("one", -21, 2016)).isNull();
        assertThat(repository.findIdByNameAndSchoolAndYear("three", -21, 2017)).isNull();
    }

    @Test
    public void itShouldAddStudentMembership() {
        final int membershipRows = countRowsInTable(jdbcTemplate, "student_group_membership");

        final StudentGroup group1 = repository.create(createTestGroup("one"),importId);
        final StudentGroup group2 = repository.create(createTestGroup("two"),importId);

        repository.addStudentToGroups(-100, newArrayList(group1.getId(), group2.getId()));
        repository.addStudentToGroups(-101, newArrayList(group1.getId()));
        assertThat(countRowsInTable(jdbcTemplate, "student_group_membership")).isEqualTo(membershipRows+3);

        // it should tolerate adding the same membership again, by doing nothing
        repository.addStudentToGroups(-100, newArrayList(group2.getId()));
        assertThat(countRowsInTable(jdbcTemplate, "student_group_membership")).isEqualTo(membershipRows+3);
    }

    private StudentGroup createTestGroup(final String name) {
        return StudentGroup.builder()
                .name(name)
                .schoolId(-21)
                .schoolYear(2017)
                .subjectId(-11)
                .active(true)
                .creator("test")
                .created(Instant.now())
                .build();
    }

    private void assertTestGroup(final StudentGroup group, final String name) {
        assertThat(group.getId()).isNotNull();
        assertThat(group.getName()).isEqualTo(name);
        assertThat(group.getSchoolId()).isEqualTo(-21);
        assertThat(group.getSchoolYear()).isEqualTo(2017);
        assertThat(group.getSubjectId()).isEqualTo(-11);
        assertThat(group.isActive()).isTrue();
        assertThat(group.getCreator()).isEqualTo("test");
        assertThat(group.getCreated()).isNotNull();
    }
}