package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.rdw.common.model.trt.Examinee;
import org.opentestsystem.rdw.common.model.trt.Opportunity;
import org.opentestsystem.rdw.common.model.trt.TDSReport;
import org.opentestsystem.rdw.ingest.common.model.District;
import org.opentestsystem.rdw.ingest.common.model.ImportException;
import org.opentestsystem.rdw.ingest.common.model.School;
import org.opentestsystem.rdw.ingest.common.repository.SchoolRepository;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Exam;
import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.repository.StubbedOutAssessmentRepository;
import org.opentestsystem.rdw.ingest.processor.repository.SubjectRepository;
import org.opentestsystem.rdw.ingest.processor.service.AssessmentService;
import org.opentestsystem.rdw.ingest.processor.service.ExamineeProcessor;
import org.opentestsystem.rdw.ingest.processor.service.StudentExamProcessor;
import org.opentestsystem.rdw.ingest.processor.service.StudentExamWriter;
import org.opentestsystem.rdw.ingest.processor.service.TDSReportProcessor;

import java.text.ParseException;

import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

public class DefaultTDSReportProcessorTest {

    private TDSReportProcessor processor;

    private StudentExamProcessor studentExamProcessor;
    private AssessmentService assessmentService;
    private ExamineeProcessor examineeProcessor;
    private SchoolRepository schoolRepository;
    private StudentExamWriter writer;
    //TODO: remove the stubbed out repository dependency once we can ingest assessment packages
    private StubbedOutAssessmentRepository stubbedOutAssessmentRepository;
    private SubjectRepository subjectRepository;

    private TDSReport tdsReport;
    private Examinee examinee;
    private School school;
    private long importId;

    @Before
    public void setUp() {
        studentExamProcessor = mock(StudentExamProcessor.class);
        assessmentService = mock(AssessmentService.class);
        examineeProcessor = mock(ExamineeProcessor.class);
        writer = mock(StudentExamWriter.class);
        schoolRepository = mock(SchoolRepository.class);
        stubbedOutAssessmentRepository = mock(StubbedOutAssessmentRepository.class);
        subjectRepository = mock(SubjectRepository.class);

        processor = new DefaultTDSReportProcessor(studentExamProcessor, assessmentService, examineeProcessor, writer, schoolRepository, subjectRepository, stubbedOutAssessmentRepository);

        tdsReport = mock(TDSReport.class);
        examinee = mock(Examinee.class);
        when(tdsReport.getExaminee()).thenReturn(examinee);

        school = School.builder()
                .name("Sample School 1")
                .naturalId("30664640124743")
                .district(District.builder().naturalId("01247430000000").name("Sample District 1").stateCode("SC").build())
                .build();

        importId = 1;
    }

    @Test
    public void itShouldProcessTDSReport() throws ParseException {

        final org.opentestsystem.rdw.common.model.trt.Test test = mock(org.opentestsystem.rdw.common.model.trt.Test.class);
        final Opportunity opportunity = mock(Opportunity.class);
        when(tdsReport.getTest()).thenReturn(test);
        when(tdsReport.getOpportunity()).thenReturn(opportunity);
        when(tdsReport.getExaminee()).thenReturn(examinee);

        when(examineeProcessor.parseExamineeRelationship(examinee)).thenReturn(school);

        when(schoolRepository.upsert(school, importId)).thenReturn(99);
        final Exam exam = mock(Exam.class);
        when(exam.getSchoolYear()).thenReturn(2016);

        final Assessment assessment = mock(Assessment.class);
        when(assessment.getSubjectId()).thenReturn(1);
        when(assessmentService.findOneForTest(test)).thenReturn(assessment);
        when(studentExamProcessor.parseExam(tdsReport, 99, assessment)).thenReturn(exam);

        final Student student = mock(Student.class);
        when(examineeProcessor.parseStudent(examinee, 2016, 99)).thenReturn(student);

        processor.process(tdsReport, importId);
        verify(writer, times((1))).saveNewExam(student, exam, importId);
    }

    @Test(expected = ImportException.class)
    public void itShouldThrowExceptionForNullExaminee() throws ParseException {
        when(tdsReport.getExaminee()).thenReturn(null);

        processor.process(tdsReport, importId);
    }

    @Test(expected = ImportException.class)
    public void itShouldConvertIllegalArgumentExceptionIntoImportException() throws ParseException {

        when(tdsReport.getExaminee()).thenThrow(mock(IllegalArgumentException.class));

        processor.process(tdsReport, importId);
    }
}