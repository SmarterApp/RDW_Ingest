package org.opentestsystem.rdw.ingest.processor.repository.impl;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.List;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.repository.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.jdbc.JdbcTestUtils;
import org.springframework.transaction.annotation.Transactional;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
public class StudentRepositoryIT {
    @Autowired
    private StudentRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Test
    @Sql(statements = {
            "INSERT INTO student (id, ssid, last_or_surname, first_name, middle_name, gender_id, first_entry_into_us_school_at, lep_entry_at, lep_exit_at, birthday) VALUES\n" +
                    "  (999, '6666666669', 'LastName6', 'FirstName6', 'MiddleName6', 1, '2015-09-01', null, null, '2006-01-01');"
    })
    public void itShouldFindExisting() throws ParseException {
        final List<Integer> ethnicity = newArrayList();
        ethnicity.add(4);
        ethnicity.add(6);

        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id = '999'")).isZero();

        assertThat(repository.upsert(Student.builder()
                .withSsid("6666666669")
                .withFirstName("FirstName6")
                .withLastOrSurname("LastName6")
                .withMiddleName("MiddleName6")
                .withBirthday(new SimpleDateFormat("yyyyy-mm-dd").parse("2006-01-01"))
                .withGenderId(1)
                .withEthnicityIds(ethnicity)
                .build())).isEqualTo(999);

        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id = '999'")).isEqualTo(2);

        //test that ethnicity is removed
        assertThat(repository.upsert(Student.builder()
                .withSsid("6666666669")
                .withFirstName("FirstName6")
                .withLastOrSurname("LastName6")
                .withMiddleName("MiddleName6")
                .withBirthday(new SimpleDateFormat("yyyyy-mm-dd").parse("2006-01-01"))
                .withGenderId(1)
                .withEthnicityIds(newArrayList())
                .build())).isEqualTo(999);
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id = '999'")).isZero();


    }

    @Test
    public void itShouldCreateNew() throws ParseException {
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "ssid = '6666666669'")).isZero();
        repository.upsert(Student.builder()
                .withSsid("6666666669")
                .withFirstName("FirstName6")
                .withLastOrSurname("LastName6")
                .withMiddleName("MiddleName6")
                .withBirthday(new SimpleDateFormat("yyyyy-mm-dd").parse("2007-01-01"))
                .withGenderId(1)
                .build());
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "ssid = '6666666669'")).isEqualTo(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO student (id, ssid, last_or_surname, first_name, middle_name, gender_id, first_entry_into_us_school_at, lep_entry_at, lep_exit_at, birthday) VALUES\n" +
                    "  (999, '6666666669', 'LastName6', 'FirstName6', 'MiddleName6', 1, '2015-09-01', null, null, '2006-01-01');"
    })
    public void itShouldFindAndUpdateExisting() throws ParseException {
        assertThat(countRowsInTableWhere(jdbcTemplate, "student", "id=999 and first_name ='FirstName - New Name' and " +
                "last_or_surname = 'LastName - New Name' and middle_name='MiddleName - New Name' and birthday='2007-01-01' and " +
                "gender_id=0")).isZero();

        assertThat(repository.upsert(Student.builder()
                .withSsid("6666666669")
                .withFirstName("FirstName - New Name")
                .withLastOrSurname("LastName - New Name")
                .withMiddleName("MiddleName - New Name")
                .withBirthday(new SimpleDateFormat("yyyyy-mm-dd").parse("2007-01-01"))
                .withGenderId(0)
                .build())).isEqualTo(999);

        assertThat(countRowsInTableWhere(jdbcTemplate, "student", "id=999 and first_name ='FirstName - New Name' and " +
                "last_or_surname = 'LastName - New Name' and middle_name='MiddleName - New Name' and birthday='2007-01-01' and " +
                "gender_id=0")).isEqualTo(1);
    }
}