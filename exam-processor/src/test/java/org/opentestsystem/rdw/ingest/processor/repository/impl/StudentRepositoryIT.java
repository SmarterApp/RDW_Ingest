package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.processor.model.InferredSchool;
import org.opentestsystem.rdw.ingest.processor.model.Student;
import org.opentestsystem.rdw.ingest.processor.repository.StudentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.jdbc.JdbcTestUtils;
import org.springframework.transaction.annotation.Transactional;

import java.text.ParseException;
import java.time.Instant;
import java.time.LocalDate;
import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
@ActiveProfiles("test")
public class StudentRepositoryIT {

    @Autowired
    private StudentRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private Student.Builder studentBuilder;

    private final int studentId = -999;
    private final String studentSQL = "INSERT INTO student (id, ssid, last_or_surname, first_name, middle_name, gender_id, first_entry_into_us_school_at, lep_entry_at, lep_exit_at, birthday, import_id, update_import_id) " +
            "VALUES  (-999, '6666666669', 'LastName6', 'FirstName6', 'MiddleName6', 1, '2015-09-02', null, null, '2006-07-08', -99, -99)";

    @Before
    public void setUp() throws ParseException {
        studentBuilder = Student.builder()
                .ssid("6666666669")
                .firstName("FirstName6")
                .lastOrSurname("LastName6")
                .middleName("MiddleName6")
                .birthday(LocalDate.parse("2006-07-08"))
                .firsEntryIntoUSSchoolAt(LocalDate.parse("2015-09-02"))
                .lepEntryAt(null)
                .lepExitAt(null)
                .genderId(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
            studentSQL,
            "INSERT INTO student_ethnicity (student_id, ethnicity_id) VALUES (-999, 6), (-999, 4)"
    })
    public void itShouldFindExisting() throws ParseException {
        final int countRowInStudentBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student");
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id = " + studentId)).isEqualTo(2);

        final List<Integer> ethnicity = newArrayList();
        ethnicity.add(4);
        ethnicity.add(6);

        assertThat(repository.upsert(studentBuilder.ethnicityIds(ethnicity).build(), -100)).isEqualTo(studentId);

        //verify that number of rows has not changed
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id =" + studentId)).isEqualTo(2);
        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore);

        //verify that import id has not changed
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -99 and inferred_school_id is null and inferred_effective_date is null")).isEqualTo(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest'),( -100, 0, 1, 'type', 'digest')",
            studentSQL,
            "INSERT INTO district (id, name, natural_id) VALUES (-22, 'Sample District 1', 'DistrictNaturalId');",
            "INSERT INTO school (id, district_id, name, natural_id, import_id, update_import_id) VALUES " +
                    "(-27, -22, 'Sample School 1', 'SchoolNaturalId', -99, -99)," +
                    "(-26, -22, 'Sample School 2', 'SchoolNaturalId2', -99, -99)," +
                    "(-25, -22, 'Sample School 3', 'SchoolNaturalId3', -99, -99);",
            "INSERT INTO asmt (id, natural_id, grade_id,type_id, subject_id, school_year, name, label, version, import_id, update_import_id) VALUES\n" +
                    "  (-1, '(SBAC)SBAC-ICA-FIXED-G5E-COMBINED-2017', 5, 1, 2, 2016, 'SBAC-ICA-FIXED-G5E-COMBINED-2017', 'Grade 5 ELA', '9831', -99, -99);\n",
            "INSERT INTO  exam ( id, type_id, school_year, asmt_id, asmt_version, opportunity, completeness_id,\n" +
                    "                    administration_condition_id, session_id, performance_level, scale_score, scale_score_std_err, completed_at,\n" +
                    "                    import_id, update_import_id, deleted, created, updated,\n" +
                    "                    grade_id, student_id, school_id, iep, lep, section504, economic_disadvantage,\n" +
                    "                    migrant_status, eng_prof_lvl, t3_program_type, language_code, prim_disability_type) VALUES\n" +
                    "  (-88, 1, 2016, -1,  null, 1, 1, 1, 'session', 1, 2145, 0.17, '2016-08-14 19:05:33.000000', -99, -99, 1, '2017-05-18 19:05:33.967000', '2017-07-18 19:06:07.966000', 3, -999, -27, 1, 1, 0, 0, 1, 'eng_prof_lvl', 't3_program_type', 'eng', null),\n" +
                    "  (-87, 1, 2016, -1,  null, 1, 1, 1, 'session', 1, null, null, '2016-07-14 19:05:33.000000', -99, -99, 0, '2017-07-18 19:06:07.966000', '2017-07-18 19:06:07.966000', 3, -999, -27, 1, 1, 0, 0, 1, 'eng_prof_lvl', 't3_program_type', 'eng', null),\n" +
                    "  (-86, 2, 2016, -1,  null, 1, 1, 1, 'session', 1, null, null, '2016-06-14 19:05:33.000000', -99, -99, 0, '2017-07-18 19:06:07.966000', '2017-07-18 19:06:07.966000', 3, -999, -27, 1, 1, 0, 0, 1, 'eng_prof_lvl', 't3_program_type', 'eng', null),\n" +
                    "  (-85, 1, 2016, -1,  null, 1, 1, 1, 'session', 1, 2145, 0.17, '2016-07-14 19:05:33.000000', -99, -99, 0, '2017-07-18 19:06:07.966000', '2017-07-18 19:06:07.966000', 3, -999, -26, 1, 1, 0, 0, 1, 'eng_prof_lvl', 't3_program_type', 'eng', null);\n"
    })
    public void itShouldFindExistingAndUpdateSchoolBasedOnExams() throws ParseException {

        final Student student = studentBuilder.build();
        student.setSchool(null);
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -99 and inferred_school_id IS NULL and inferred_effective_date IS NULL")).isEqualTo(1);

        repository.upsert(student, -100);
        //derived the school from exams by taking the one that is not deleted, has the latest completed_at and the highest id
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -100 and inferred_school_id = -26 and inferred_effective_date = convert_tz(timestamp('2016-07-14T19:05:33:00Z'), '+00:00', @@session.time_zone)")).isEqualTo(1);

        //force the inferred school date to be past all the exams
        jdbcTemplate.execute("UPDATE student SET inferred_school_id = -25, inferred_effective_date = '2017-07-14 19:05:33.000000' WHERE id = -999");
        repository.upsert(student, -99);
        //verify that the school has not been updated
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -100 and inferred_school_id = -25 and inferred_effective_date = convert_tz(timestamp('2017-07-14T19:05:33:00Z'), '+00:00', @@session.time_zone) ")).isEqualTo(1);

        //remove all exams and make sure that the inferred school is deleted. NOTE that it happens regardless of the school inferred date
        jdbcTemplate.execute("DELETE FROM exam WHERE student_id = " + studentId);
        repository.upsert(student, -99);
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -99 and inferred_school_id IS NULL and inferred_effective_date IS NULL")).isEqualTo(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
            "INSERT INTO district (id, name, natural_id) VALUES (-22, 'Sample District 1', 'DistrictNaturalId');",
            "INSERT INTO school (id, district_id, name, natural_id, import_id, update_import_id) VALUES (-27, -22, 'Sample School 1', 'SchoolNaturalId', -99, -99);",
    })
    public void itShouldCreateNew() throws ParseException {

        final int countRowInStudentBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student");
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "ssid = '6666666669'")).isZero();

        final Student student = studentBuilder.build();
        student.setSchool(new InferredSchool(-27, Instant.parse("2007-01-02T14:30:00Z")));
        repository.upsert(student, -99);

        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "ssid = '6666666669' and import_id = -99 and update_import_id = -99  and inferred_school_id = -27 and inferred_effective_date = convert_tz(timestamp('2007-01-02T14:30:00Z'), '+00:00', @@session.time_zone)")).isEqualTo(1);
        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore + 1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -100, 0, 1, 'type', 'digest')",
            studentSQL,
            "INSERT INTO student_ethnicity (student_id, ethnicity_id) VALUES (-999, 6), (-999, 4)"

    })
    public void itShouldFindAndUpdateExistingWithNoChangeToEthnicity() throws ParseException {
        final String newStudentSQL = "id=" + studentId + " and first_name ='FirstName - New Name' and " +
                "last_or_surname = 'LastName - New Name' and middle_name='MiddleName - New Name' and birthday='1999-05-01' and " +
                "gender_id=0";

        assertThat(countRowsInTableWhere(jdbcTemplate, "student", newStudentSQL)).isZero();
        final int countRowInStudentBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student");

        final List<Integer> ethnicity = newArrayList();
        ethnicity.add(4);
        ethnicity.add(6);

        assertThat(repository.upsert(Student.builder()
                .ssid("6666666669")
                .firstName("FirstName - New Name")
                .lastOrSurname("LastName - New Name")
                .middleName("MiddleName - New Name")
                .birthday(LocalDate.parse("1999-05-01"))
                .ethnicityIds(ethnicity)
                .genderId(0)
                .build(), -100)).isEqualTo(-999);

        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore);
        assertThat(countRowsInTableWhere(jdbcTemplate, "student", newStudentSQL)).isEqualTo(1);

        //verify that import id has changed
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and import_id = -99 and update_import_id = -100")).isEqualTo(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -100, 0, 1, 'type', 'digest')",
            studentSQL,
            "INSERT INTO student_ethnicity (student_id, ethnicity_id) VALUES (-999, 6), (-999, 4)"
    })
    public void itShouldFindAndUpdateExistingIfOnlyEthnicityChanges() throws ParseException {

        final int countRowInStudentBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student");
        final int countRowInEthnBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student_ethnicity");

        final List<Integer> ethnicity = newArrayList();
        ethnicity.add(4);
        ethnicity.add(5);

        assertThat(repository.upsert(studentBuilder.ethnicityIds(ethnicity).build(), -100)).isEqualTo(studentId);

        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore);
        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student_ethnicity")).isEqualTo(countRowInEthnBefore);
        //verify that import id has changed
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -100")).isEqualTo(1);

        assertThat(repository.upsert(studentBuilder.ethnicityIds(newArrayList()).build(), -99)).isEqualTo(studentId);

        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore);
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student_ethnicity", "student_id = -999 and ethnicity_id in (4,5)")).isEqualTo(countRowInEthnBefore - 2);
        //verify that import id has changed
        assertThat(JdbcTestUtils.countRowsInTableWhere(jdbcTemplate, "student", "id =" + studentId + " and update_import_id = -99")).isEqualTo(1);
    }

    @Test
    @Sql(statements = {
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
            "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -100, 0, 1, 'type', 'digest')",
            studentSQL
    })
    public void itShouldHandleNullableDatesComparison() throws ParseException {

        final int countRowInStudentBefore = JdbcTestUtils.countRowsInTable(jdbcTemplate, "student");

        assertThat(repository.upsert(studentBuilder.firsEntryIntoUSSchoolAt(null).build(), -100)).isEqualTo(studentId);

        assertThat(JdbcTestUtils.countRowsInTable(jdbcTemplate, "student")).isEqualTo(countRowInStudentBefore);
        assertThat(countRowsInTableWhere(jdbcTemplate, "student",
                "id = " + studentId + " and first_entry_into_us_school_at is null and lep_entry_at is null and lep_exit_at is null and update_import_id = -100")).isEqualTo(1);

        assertThat(repository.upsert(studentBuilder.lepExitAt(LocalDate.parse("2017-05-03")).build(), -99)).isEqualTo(studentId);
        assertThat(countRowsInTableWhere(jdbcTemplate, "student",
                "id = " + studentId + " and first_entry_into_us_school_at is null and lep_entry_at is null and lep_exit_at = '2017-05-03' and update_import_id = -99")).isEqualTo(1);

        assertThat(repository.upsert(studentBuilder.lepEntryAt(LocalDate.parse("2017-05-03")).build(), -100)).isEqualTo(studentId);
        assertThat(countRowsInTableWhere(jdbcTemplate, "student",
                "id = " + studentId + " and first_entry_into_us_school_at is null and lep_entry_at = '2017-05-03' and lep_exit_at = '2017-05-03' and update_import_id = -100")).isEqualTo(1);
    }
}