package org.opentestsystem.rdw.ingest.processor.multithreaded;

import org.opentestsystem.rdw.ingest.processor.repository.DataSourceConfiguration;
import org.opentestsystem.rdw.utils.YamlPropertiesConfigurator;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.context.ConfigurableApplicationContext;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Import;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;

/**
 * A console application that runs all available {@link MultiThreadedTest}s
 * The exist status 0 indicates a success.
 * The exist status > 0 indicates a number of failed tests
 */
@ComponentScan({
        "org.opentestsystem.rdw.ingest.processor.service",
        "org.opentestsystem.rdw.ingest.processor.service.impl",
        "org.opentestsystem.rdw.ingest.processor.repository",
        "org.opentestsystem.rdw.ingest.processor.repository.impl",
        "org.opentestsystem.rdw.ingest.processor.model",
        "org.opentestsystem.rdw.ingest.processor.multithreaded"
})
@Import({YamlPropertiesConfigurator.class,
        DataSourceAutoConfiguration.class,
        JdbcTemplateAutoConfiguration.class,
        DataSourceConfiguration.class})
//@Profile("test")
public class MultiThreadedApplicationTest {
    private static final Logger logger = LoggerFactory.getLogger(MultiThreadedApplicationTest.class);
    private final static int TestThreadCount = 10;

    public static void main(final String[] args) throws Exception {
        final ConfigurableApplicationContext ctx =
                new SpringApplicationBuilder(MultiThreadedApplicationTest.class)
                        .web(false)
                        .run(args);

        final List<Integer> failed = newArrayList();
        final String[] beans = ctx.getBeanNamesForType(MultiThreadedTest.class);
        logger.info("Found {} beans", beans.length);
        for (final String test : beans) {
            logger.info("Running test for [" + test + "] with thread count =" + TestThreadCount);
            final boolean passed = ctx.getBean(test, MultiThreadedTest.class).run(TestThreadCount);
            logger.info(test + " " + (passed ? "passed" : "failed"));

            failed.add(passed ? 0 : 1);
        }

        System.exit(failed.stream().mapToInt(Integer::intValue).sum());
    }
}