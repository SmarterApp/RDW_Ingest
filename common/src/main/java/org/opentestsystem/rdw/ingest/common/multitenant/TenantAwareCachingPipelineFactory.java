package org.opentestsystem.rdw.ingest.common.multitenant;

import java.util.HashMap;
import java.util.Map;
import org.opentestsystem.rdw.script.Pipeline;
import org.opentestsystem.rdw.script.PipelineBuildException;
import org.opentestsystem.rdw.script.PipelineFactory;

/**
 * Getting a pipeline is expensive so cache the pipelines.
 * TODO - eventually this will deal with whatever is needed for tenant awareness
 */
public class TenantAwareCachingPipelineFactory implements PipelineFactory {

    private final PipelineFactory wrappedFactory;
    private final Map<String, Pipeline> pipelines = new HashMap<>();

    public TenantAwareCachingPipelineFactory(final PipelineFactory wrapped) {
        this.wrappedFactory = wrapped;
    }

    @Override
    public Pipeline getPipeline(final String pipelineName, final String pipelineVersion) throws PipelineBuildException {
        final String key = pipelineName + "_" + pipelineVersion;
        return pipelines.computeIfAbsent(key, k -> wrappedFactory.getPipeline(pipelineName, pipelineVersion));
    }

    @Override
    public Pipeline getDevelopmentPipeline(final String scriptBody) throws PipelineBuildException {
        return wrappedFactory.getDevelopmentPipeline(scriptBody);
    }
}
