package org.opentestsystem.rdw.ingest.script

import org.codehaus.groovy.control.CompilationFailedException
import org.codehaus.groovy.control.CompilerConfiguration

/**
 * Compiles a script into a class and provides methods to get instances.
 */
class ScriptCompiler {
    final Class<DSLScriptBase> scriptClass

    ScriptCompiler(String script) throws CompilationFailedException {
        CompilerConfiguration compilerConfig = new CompilerConfiguration()
        compilerConfig.setScriptBaseClass(DSLScriptBase.class.getName())

        GroovyClassLoader groovyClassLoader =
                new GroovyClassLoader(this.getClass().getClassLoader(), compilerConfig)
        scriptClass = groovyClassLoader.parseClass(script)
    }

    DSLScriptBase getInstance(InputStream input) {
        return getInstance(input, Collections.emptyMap())
    }

    DSLScriptBase getInstance(InputStream input, Map<String,Object> properties) {
        return scriptClass.getConstructor().newInstance()
                    .bindProperties(properties)
                    .bindInput(input)
    }
}
