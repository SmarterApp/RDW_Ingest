package org.opentestsystem.rdw.ingest.script;

import java.io.Reader;
import java.io.StringReader;
import java.util.List;

/**
 * A Pipeline is a series of precompiled scripts that run against input in order to
 * transform, filter, and validated it.
 */
public class Pipeline {
    private final PipelineDefinition pipelineDefinition;
    private final List<ScriptDefinition> scriptDefinitions;

    public Pipeline(final PipelineDefinition pipelineDefinition, final List<ScriptDefinition> scriptDefinitions) {
        this.pipelineDefinition = pipelineDefinition;
        this.scriptDefinitions = scriptDefinitions;
    }

    public PipelineDefinition getPipelineDefinition() {
        return pipelineDefinition;
    }

    public String runPipeline(final String inputString)  {
        String results = inputString;

        for (final ScriptDefinition sd : scriptDefinitions) {

            try (final Reader input = new StringReader(results)) {
                final PipelineScript script = sd.getInstance(input);
                if (pipelineDefinition.getOptions().contains("xml")) {
                    script.enableXmlExtensions();
                }

                results = (String)script.run();
            } catch (final Exception e) {
                throw new RuntimeException("Runtime error in script: " + sd, e);
            }
        }

        return results;
    }
}
