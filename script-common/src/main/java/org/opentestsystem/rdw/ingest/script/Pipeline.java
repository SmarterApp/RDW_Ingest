package org.opentestsystem.rdw.ingest.script;

import java.util.List;

/**
 * A Pipeline is a series of precompiled scripts that run against input in order to
 * transform, filter, and validated it.
 */
public class Pipeline {
    private final PipelineDefinition pipelineDefinition;
    private final List<ScriptDefinition> scriptDefinitions;

    public Pipeline(final PipelineDefinition pipelineDefinition, final List<ScriptDefinition> scriptDefinitions) {
        this.pipelineDefinition = pipelineDefinition;
        this.scriptDefinitions = scriptDefinitions;
    }

    public PipelineDefinition getPipelineDefinition() {
        return pipelineDefinition;
    }

    public PipelineResults run(Object input)  {

        if (input instanceof String) {
            input = ((String)input).getBytes();
        }

        for (ScriptDefinition sd : scriptDefinitions) {

            try {
                PipelineScript script = sd.getInstance(input);
                if (pipelineDefinition.getOptions().contains("xml")) {
                    script.enableXmlExtensions();
                }

                input = script.run();
            } catch (Exception e) {
                throw new RuntimeException("Runtime error in script: " + sd, e);
            }
        }

        return new PipelineResults(input);
    }
}
