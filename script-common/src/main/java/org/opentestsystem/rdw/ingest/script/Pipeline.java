package org.opentestsystem.rdw.ingest.script;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import org.opentestsystem.rdw.ingest.common.model.ImportException;

/**
 * A Pipeline is a series of precompiled scripts that run against input in order to
 * transform, filter, and validated it.
 */
public class Pipeline {
    private static final Logger logger = LoggerFactory.getLogger(Pipeline.class);

    private final PipelineDefinition pipelineDefinition;
    private final List<ScriptDefinition> scriptDefinitions;

    public Pipeline(final PipelineDefinition pipelineDefinition, final List<ScriptDefinition> scriptDefinitions) {
        this.pipelineDefinition = pipelineDefinition;
        this.scriptDefinitions = scriptDefinitions;
    }

    public PipelineDefinition getPipelineDefinition() {
        return pipelineDefinition;
    }

    public PipelineResults run(final Object input)  {
        Object lastValidTransformation = input;

        for (ScriptDefinition sd : scriptDefinitions) {
            try {
                final PipelineScript script = sd.getInstance(lastValidTransformation);

                final Object results = script.run();

                if (results == null) {
                    // (A script always returns the value of its last expression, so this is unlikely to happen.)
                    throw new RuntimeException("Script " + sd.toString() + " returned null results.");
                }

                lastValidTransformation = results;
            } catch (ImportException ie) {
                ie.fillInStackTrace();
                throw ie;
            } catch (Exception e) {
                logger.warn("Pipeline runtime error", e);
                throw new RuntimeException("Runtime error in script: " + sd + ": " + e.getMessage(), e);
            }
        }

        return new PipelineResults(lastValidTransformation);
    }
}
