package org.opentestsystem.rdw.ingest.script;

import java.io.Reader;
import java.io.StringReader;

/**
 * A Pipeline is a series of precompiled scripts that run against input in order to
 * transform, filter, and validated it.
 */
public class Pipeline {
    private final PipelineDefinition pipelineDefinition;

    public Pipeline(final PipelineDefinition pipelineDefinition) {
        this.pipelineDefinition = pipelineDefinition;
    }

    public PipelineDefinition getPipelineDefinition() {
        return pipelineDefinition;
    }

    public String runPipeline(String inputString)  {
        String results = inputString;

        for (ScriptDefinition sd : pipelineDefinition.getScriptDefinitions()) {

            try (Reader input = new StringReader(results)) {
                PipelineScript script = sd.getInstance(input);
                if (pipelineDefinition.getOptions().contains("xml")) {
                    script.enableXmlExtensions();
                }

                results = (String)script.run();
            } catch (Exception e) {
                throw new RuntimeException("Runtime error in script: " + sd, e);
            }
        }

        return results;
    }
}
