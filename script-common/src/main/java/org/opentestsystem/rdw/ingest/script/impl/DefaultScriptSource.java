package org.opentestsystem.rdw.ingest.script.impl;

import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Reader;
import org.opentestsystem.rdw.ingest.script.PipelineDefinition;
import org.opentestsystem.rdw.ingest.script.ScriptInfo;
import org.opentestsystem.rdw.ingest.script.ScriptSource;
import org.opentestsystem.rdw.ingest.script.VersionedResource;

import static java.util.Collections.emptyMap;

/**
 * TODO: This is a stub. It must be replaced with a real implementation that loads scripts from an s3 bucket,
 * a private GitHub repo, or other source.
 */
public class DefaultScriptSource implements ScriptSource {
    private static final ObjectMapper objectMapper = new ObjectMapper()
            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);

    @Override
    public String loadScriptBaseClass() {
        return loadFromResourceFile("/scripts/DSLScriptBase.groovy");
    }

    @Override
    public PipelineDefinition loadPipelineDefinition(final String pipelineName, final String pipelineVersion) {
        try {
            String json = loadFromResourceFile("/scripts/" + pipelineName + ".json");
            return objectMapper.readValue(json, PipelineDefinition.PipelineDefinitionBuilder.class).build();
        } catch (Exception e) {
            throw new RuntimeException("Cannot create Pipeline Definition", e);
        }
    }

    @Override
    public ScriptInfo loadScript(final VersionedResource nodeDefinition) {
        final String code = loadFromResourceFile("/scripts/" + nodeDefinition.getName() + ".groovy");
        return new ScriptInfo(code, emptyMap());
    }

    private String loadFromResourceFile(String name) {
        try {
            final InputStream input = this.getClass().getResourceAsStream(name);
            if (input == null) {
                throw new FileNotFoundException("Resource " + name + " not found.");
            }
            Reader scriptReader = new InputStreamReader(input);
            return readFully(scriptReader);
        } catch (IOException e) {
            throw new RuntimeException("Failed to load " + name, e);
        }
    }

    private String readFully(Reader reader) throws IOException {
        char[] arr = new char[8 * 1024];
        StringBuilder buffer = new StringBuilder();
        int numCharsRead;
        while ((numCharsRead = reader.read(arr, 0, arr.length)) != -1) {
            buffer.append(arr, 0, numCharsRead);
        }
        reader.close();
        return buffer.toString();
    }
}
