package org.opentestsystem.rdw.ingest.script;

import java.io.IOException;
import java.io.InputStreamReader;
import java.io.Reader;
import java.util.Collections;
import java.util.Optional;

/**
 * TODO: This is a stub. It must be replaced with a real implementation that loads scripts from an s3 bucket,
 * a private GitHub repo, or other source.
 */
public class ScriptSourceImpl implements ScriptSource {
    @Override
    public String loadScriptBaseClass() {
        return loadFromResourceFile("/scripts/DSLScriptBase.groovy");
    }

    @Override
    public PipelineDefinition loadPipelineDefinition(final String pipelineName, final String pipelineVersion) {
        PipelineDefinition definition = new PipelineDefinition(
                pipelineName,
                pipelineVersion,
                Optional.empty(),
                Collections.singletonList("xml"),
                Collections.emptyList());
        return definition;
    }

    @Override
    public ScriptDefinition loadScriptCodeAndConfig(final ScriptDefinition scriptDefinition) {
        return scriptDefinition;
    }

    private String loadFromResourceFile(String name) {
        try {
            Reader scriptReader = new InputStreamReader(this.getClass().getResourceAsStream(name));
            return readFully(scriptReader);
        } catch (IOException e) {
            throw new RuntimeException("Failed to load " + name, e);
        }
    }

    private String readFully(Reader reader) throws IOException {
        char[] arr = new char[8 * 1024];
        StringBuilder buffer = new StringBuilder();
        int numCharsRead;
        while ((numCharsRead = reader.read(arr, 0, arr.length)) != -1) {
            buffer.append(arr, 0, numCharsRead);
        }
        reader.close();
        return buffer.toString();
    }
}
