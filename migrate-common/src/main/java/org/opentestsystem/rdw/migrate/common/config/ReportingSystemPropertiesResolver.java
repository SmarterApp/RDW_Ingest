package org.opentestsystem.rdw.migrate.common.config;

import org.opentestsystem.rdw.multitenant.TenantKeyResolver;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Optional;

public class ReportingSystemPropertiesResolver implements ReportingSystemProperties {

    private static final Logger logger = LoggerFactory.getLogger(ReportingSystemPropertiesResolver.class);

    private final TenantKeyResolver tenantKeyResolver;
    private final ReportingSystemSettings reportingSystemSettings;

    public ReportingSystemPropertiesResolver(
            final TenantKeyResolver tenanKeyResolver,
            final ReportingSystemSettings reportingSystemSettings) {
        this.tenantKeyResolver = tenanKeyResolver;
        this.reportingSystemSettings = reportingSystemSettings;
        logger.debug("ReportingSystemSettings {}", reportingSystemSettings);
    }

    private Optional<ReportingSystemProperties> getResolvedReportingSystemProperties() {
        return tenantKeyResolver.getTenantKey()
                .flatMap(k -> Optional.ofNullable(reportingSystemSettings.getTenants().get(k)));
    }

    @Override
    public Integer getSchoolYear() {
        return getResolvedReportingSystemProperties()
                .map(ReportingSystemProperties::getSchoolYear)
                .orElse(reportingSystemSettings.getSchoolYear());
    }

}
