package org.opentestsystem.rdw.migrate.common;

import org.springframework.jdbc.core.JdbcOperations;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

/**
 * A helper class that counts rows in a table before the test and
 * can be later used to compare the results after the test
 */
public class TableTestCountHelper {
    final private String tableName;
    final private String where;
    final private int countBefore;
    final private int expectedCountChangeAfterTest;
    final private JdbcOperations jdbcOperations;

    /**
     * Constructor
     *
     * @param jdbcOperations               the {@link JdbcOperations}
     * @param tableName                    the name of the table to count rows
     * @param expectedCountChangeAfterTest the expected change to the count after a test
     * @param where                        the where clause to use in the count. It is the same clause that is used in the before and after a test
     */
    public TableTestCountHelper(final JdbcOperations jdbcOperations,
                                final String tableName,
                                final int expectedCountChangeAfterTest,
                                final String where) {
        this.where = where;
        this.tableName = tableName;
        this.expectedCountChangeAfterTest = expectedCountChangeAfterTest;
        this.jdbcOperations = jdbcOperations;
        this.countBefore = countRowsInTableWhere(this.jdbcOperations, this.tableName, where);
    }

    public void verify() {
        assertThat(countRowsInTableWhere(jdbcOperations, tableName, where))
                .as("check TABLE: %s WHERE: %s", tableName, where).isEqualTo(countBefore + expectedCountChangeAfterTest);
    }

    /**
     * A helper method to verify all counts
     *
     * @param counts
     */
    public static void verifyTableCountsAfterTest(final List<TableTestCountHelper> counts) {
        for (final TableTestCountHelper tableTestCount : counts) {
            tableTestCount.verify();
        }
    }

    static private Integer countRowsInTableWhere(final JdbcOperations jdbcTemplate, final String table, final String where) {
        return jdbcTemplate.queryForObject("SELECT COUNT(0) FROM " + table + " WHERE " + where, Integer.class);
    }
}
