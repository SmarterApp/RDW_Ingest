package org.opentestsystem.rdw.ingest.group.repository;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.common.model.ImportStatus;
import org.opentestsystem.rdw.ingest.group.RepositoryBackedIT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.test.context.jdbc.Sql;

import java.util.HashMap;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

@Import(JdbcStudentGroupBatchRepository.class)
@Sql(scripts = {
        "classpath:WarehouseImportSetup.sql",
        "classpath:WarehouseCodesSetup.sql",
        "classpath:WarehouseEntitiesSetup.sql",
        "classpath:WarehouseBatchRepositorySetup.sql"
})
public class JdbcStudentGroupBatchRepositoryIT extends RepositoryBackedIT {

    @Autowired
    public StudentGroupBatchRepository repository;

    @Autowired
    public NamedParameterJdbcTemplate template;

    @Test
    public void itShouldUpdateBatchStatusAndMessage() {
        repository.updateBatchStatus(33, ImportStatus.FAILED, "some message");

        final Map<String, Object> batch = template.queryForMap(
                "SELECT * from upload_student_group_batch WHERE id = 33",
                new HashMap<>());

        assertThat(batch.get("status")).isEqualTo(ImportStatus.FAILED.getValue());
        assertThat(batch.get("message")).isEqualTo("some message");
    }
}