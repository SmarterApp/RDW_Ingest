package org.opentestsystem.rdw.ingest.group.service.impl;

import org.opentestsystem.rdw.ingest.group.repository.SchoolBatchRepository;
import org.opentestsystem.rdw.ingest.group.service.BatchingGroupImportService;
import org.opentestsystem.rdw.ingest.group.service.ProcessingGroupImportService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Set;

/**
 * This service processes group imports and modifications for a Group upload
 * while grouping imports together by school.
 */
@Service
public class SchoolBatchingGroupImportService implements BatchingGroupImportService {

    private final ProcessingGroupImportService importService;
    private final SchoolBatchRepository repository;

    @Autowired
    public SchoolBatchingGroupImportService(final ProcessingGroupImportService importService,
                                           final SchoolBatchRepository repository) {
        this.importService = importService;
        this.repository = repository;
    }

    @Override
    public void processBatch(final long batchId) {
        final Set<Integer> schoolIds = repository.findSchoolIdsForBatch(batchId);

        for (final int schoolId : schoolIds) {
            importService.createImports(batchId, schoolId);
            importService.insertMissingGroups(batchId, schoolId);
            importService.updateDeletedGroups(batchId, schoolId);
            importService.updateModifiedGroups(batchId, schoolId);
            importService.updateModifiedGroupUsers(batchId, schoolId);
            importService.updateModifiedGroupStudents(batchId, schoolId);
            importService.triggerImport(batchId, schoolId);
        }

        importService.cleanupBatch(batchId);
    }
}
