package org.opentestsystem.rdw.ingest.group.service.impl;

import org.opentestsystem.rdw.ingest.group.repository.SchoolBatchRepository;
import org.opentestsystem.rdw.ingest.group.service.BatchingUserImportService;
import org.opentestsystem.rdw.ingest.group.service.ProcessingUserImportService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.Set;

/**
 * This service processes user imports and modifications for a Group upload
 * while grouping imports together by school.
 */
@Service
public class SchoolBatchingUserImportService implements BatchingUserImportService {

    private final ProcessingUserImportService importService;
    private final SchoolBatchRepository repository;

    @Autowired
    public SchoolBatchingUserImportService(final ProcessingUserImportService importService,
                                           final SchoolBatchRepository repository) {
        this.importService = importService;
        this.repository = repository;
    }

    @Override
    public void processBatch(final long batchId) {
        final Set<Integer> schoolIds = repository.findSchoolIdsForBatch(batchId);

        for (final int schoolId : schoolIds) {
            importService.createImports(batchId, schoolId);
            importService.insertMissingStudents(batchId, schoolId);
            importService.updateDeletedStudents(batchId, schoolId);
            importService.triggerImport(batchId, schoolId);
        }

        importService.cleanupBatch(batchId);
    }
}
