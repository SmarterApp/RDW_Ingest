package org.opentestsystem.rdw.ingest.group.service.impl;

import org.opentestsystem.rdw.ingest.common.model.GroupMessage;
import org.opentestsystem.rdw.ingest.group.service.GroupProcessor;
import org.opentestsystem.rdw.ingest.group.service.ProcessingLoadService;
import org.opentestsystem.rdw.ingest.group.service.ProcessingReferenceService;
import org.opentestsystem.rdw.ingest.group.service.ProcessingStandardizationService;
import org.opentestsystem.rdw.ingest.group.service.ProcessingUserImportService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class DefaultGroupProcessor implements GroupProcessor {
    private static final Logger logger = LoggerFactory.getLogger(DefaultGroupProcessor.class);

    private final ProcessingStandardizationService standardizationService;
    private final ProcessingReferenceService referenceService;
    private final ProcessingUserImportService userImportService;
    private final ProcessingLoadService loadService;

    @Autowired
    public DefaultGroupProcessor(final ProcessingStandardizationService standardizationService,
                                 final ProcessingReferenceService referenceService,
                                 final ProcessingUserImportService userImportService,
                                 final ProcessingLoadService loadService) {
        this.standardizationService = standardizationService;
        this.referenceService = referenceService;
        this.userImportService = userImportService;
        this.loadService = loadService;
    }

    /**
     * Processes an upload message
     *
     * @param message A message sent after successful upload from RDW_Admin for a groups CSV
     */
    @Override
    public void process(final GroupMessage message) {

        // todo: Need to design message that RDW_Admin will publish to queue
        final String jsonMessage = message.toJson();
        logger.debug("Received upload message: " + (jsonMessage.length() > 80 ? jsonMessage.substring(0, 80) + "..." : jsonMessage));

        final long batchId = message.getUploadId();
        try {
            loadService.loadBatch(message.getDigest(), batchId);
        } catch (final Exception e) {
            logger.error("Problem loading data for: {}", message.getDigest(), e);
        }

        // TODO once CSV is loaded into DB
        try {
            standardizationService.standardizeBatch(batchId);
            referenceService.lookupBatchReferences(batchId);
            userImportService.createImports(batchId);
            userImportService.insertMissingStudents(batchId);
            userImportService.updateDeletedStudents(batchId);
            userImportService.triggerImport(batchId);
        } catch (final Exception e) {
            logger.error("Problem processing batch: {}", batchId, e);
        }
    }

}
