package org.opentestsystem.rdw.ingest.impsvc.multitenant;

import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;

import java.util.Optional;
import org.opentestsystem.rdw.ingest.impsvc.auth.SbacUser;
import org.opentestsystem.rdw.multitenant.TenantIdResolver;

/**
 * The import {@link TenantIdResolver} gets the tenant id from current user.
 */
public class ImportTenantIdResolver implements TenantIdResolver {

    @Override
    public Optional<String> getTenantId() {
        try {
            return Optional.of(getCurrentUser().getTenantId());
        } catch (final IllegalStateException | ClassCastException e) {
            // expected exceptions, fall thru for no tenant handling
        }
        return Optional.empty();
    }

    /**
     * Helper to get the current {@link SbacUser} from the security context.
     *
     * @return current SbacUser
     * @throws IllegalStateException if there is no current auth
     * @throws ClassCastException if current principal is not an SbacUser
     */
    public static SbacUser getCurrentUser() {
        final SecurityContext context = SecurityContextHolder.getContext();
        final Authentication authentication = context.getAuthentication();
        if (authentication == null) {
            throw new IllegalStateException("user not authenticated");
        }
        if (!(authentication.getPrincipal() instanceof SbacUser)) {
            throw new ClassCastException("authentication principal must be of type " + SbacUser.class.getName());
        }
        return (SbacUser) authentication.getPrincipal();
    }
}
