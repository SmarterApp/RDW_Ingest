package org.opentestsystem.rdw.ingest.auth;

import org.junit.Test;
import org.opentestsystem.rdw.security.Permission;
import org.opentestsystem.rdw.security.PermissionScope;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;

public class SbacUserTest {

    // returns a test user with the same defaults as WithMockSbacUser
    public static SbacUser testUser() {
        return SbacUser.builder()
                .username("test@example.com")
                .password("password")
                .authorities(newArrayList(new SimpleGrantedAuthority("ASMTDATALOAD")))
                .tenancyChain("|SBAC|ASMTDATALOAD|CLIENT|SBAC||||||||||||||")
                .sbacUuid("57e3ed3de4b0e3b75702f3a0")
                .permission(new Permission("ASMTDATALOAD", PermissionScope.STATEWIDE))
                .build();
    }

    @Test
    public void itShouldPreserveConstructorValues() {
        final SbacUser user = testUser();
        assertThat(user.getUsername()).isEqualTo("test@example.com");
        assertThat(user.getTenancyChain().toString()).isEqualTo("|SBAC|ASMTDATALOAD|CLIENT|SBAC||||||||||||||");
    }

    @Test
    public void itShouldRequireOnlyUsernameAndHaveADefaultPassword() {
        final SbacUser user = SbacUser.builder().username("alice").build();
        assertThat(user.getPassword()).isNotBlank();
        assertThat(user.getAuthorities()).isNotNull().isEmpty();
    }

    @Test
    public void itShouldFindPermissionsOrNot() {
        final SbacUser user = testUser();
        assertThat(user.getPermissionScope("ASMTDATALOAD").isStatewide()).isTrue();
        // there is no isEmpty() method on PermissionScope, so go through the builder and use isValid() instead
        assertThat(user.getPermissionScope("GROUP_WRITE").copy().isValid()).isFalse();
    }
}
