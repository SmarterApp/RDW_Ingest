package org.opentestsystem.rdw.ingest.impsvc.repository;

import org.springframework.security.authentication.TestingAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.test.context.TestContext;
import org.springframework.test.context.support.AbstractTestExecutionListener;

import org.opentestsystem.rdw.ingest.impsvc.auth.SbacUserTest;

/**
 * The purpose of this class is to inject a test user into the security context BEFORE the
 * transaction listener kicks in. Using a listener is necessary because of the combination of
 * the test framework wiping out the security context after every test, and the precedence of
 * the listeners being higher than the @Before annotation for a test suite.
 */
public class TenantTestExecutionListener extends AbstractTestExecutionListener {
    @Override
    public void beforeTestMethod(final TestContext testContext) {
        SecurityContextHolder.getContext()
                .setAuthentication(new TestingAuthenticationToken(SbacUserTest.testUser(), null));
    }

    @Override
    public int getOrder() {
        // something less than TransactionalTestExecutionListener's order of 4000
        return 3000;
    }
}
