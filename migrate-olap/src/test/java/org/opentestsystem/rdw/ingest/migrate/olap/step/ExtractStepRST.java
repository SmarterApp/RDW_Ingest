package org.opentestsystem.rdw.ingest.migrate.olap.step;

import org.junit.After;
import org.junit.Before;
import org.opentestsystem.rdw.archive.ArchiveService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;

public abstract class ExtractStepRST extends MigrateStepRST {

    @Autowired
    protected ArchiveService archiveService;

    @Value("${migrate.aws.location}")
    protected String location;

    @Before
    public void prepareExtractLocation() {
        // The extract steps assume that the extract location is created by previous
        // steps and is clean, so we have to simulate that here. Doing it both
        // @Before and @After is just being cautious.
        if (archiveService.exists(location)) {
            doLocationCleanUp();
        } else {
            // use a test file to force the creation of the extract location
            archiveService.writeResource(location + "/test", "olap-migrate".getBytes(), null);
        }
    }

    @After
    public void cleanUpExtractLocation() {
        doLocationCleanUp();
    }

    protected void doLocationCleanUp() {
        for (final String resource : archiveService.listResources(location + "/")) {
            archiveService.delete(resource);
        }
    }
}
