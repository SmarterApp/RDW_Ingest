package org.opentestsystem.rdw.ingest.migrate.olap.step;

import com.google.common.collect.Lists;
import org.opentestsystem.rdw.ingest.common.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.common.util.SqlListBuilder;
import org.opentestsystem.rdw.ingest.migrate.olap.repository.SqlListExecutionWithMigrateRepository;
import org.opentestsystem.rdw.migrate.common.config.MigrateStagingToReportingSqlConfiguration;
import org.opentestsystem.rdw.migrate.common.config.MigrateWarehouseToStagingSqlConfiguration;
import org.opentestsystem.rdw.migrate.common.step.SqlListCodesExecutionStep;
import org.opentestsystem.rdw.migrate.common.step.SqlListExecutionStep;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;

/**
 * Configuration for batch steps responsible for moving the data from S3 to OLAP reporting
 */
@Configuration
public class OlapReportingMigrateStepsConfig {
    private final StepBuilderFactory stepBuilderFactory;

    private final SqlListExecutionWithMigrateRepository warehouseCopyRepository;
    private final SqlListExecutionRepository warehouseSqlListExecutionRepository;
    private final SqlListExecutionRepository reportingSqlListExecutionRepository;

    private final MigrateStagingToReportingSqlConfiguration stagingToReportingSqlConfiguration;
    private final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration;

    static final String stepTruncateStageName = "stepTruncateStage";
    static final String extractEntitiesStep = "extractEntitiesStep";
    static final String extractCodesStep = "extractCodesStep";
    static final String extractEmbargoStep = "extractEmbargoStep";
    static final String loadCodesToStagingStep = "loadCodesToStagingStep";
    static final String loadEmbargoToStagingStep = "loadEmbargoToStagingStep";
    static final String loadEntitiesToStagingStep = "loadEntitiesToStagingStep";
    static final String deriveActiveAsmtStep = "deriveActiveAsmtStep";

    static final String deleteCodesStepName = "deleteCodesStep";
    static final String upsertCodesStepName = "upsertCodesStep";
    static final String deleteEntitiesStepName = "deleteEntitiesStep";
    static final String upsertStudentsStepName = "upsertStudentsStep";
    static final String upsertOrganizationsStepName = "upsertOrganizationsStep";
    static final String upsertAsmtsStepName = "upsertAsmtsStep";
    static final String upsertFactStudentExamStepName = "upsertFactStudentExamStep";
    static final String updateEmbargoStepName = "updateEmbargoStep";

    public static final List<String> codes = newArrayList("administration_condition", "completeness", "ethnicity", "gender", "grade", "school_year");
    static final List<String> warehouseEntities = newArrayList("asmt", "district_group", "school_group", "school", "district", "student", "student_ethnicity", "exam", "exam_claim_score");

    @Autowired
    public OlapReportingMigrateStepsConfig(final StepBuilderFactory stepBuilderFactory,
                                           final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration,
                                           final MigrateStagingToReportingSqlConfiguration stagingToReportingSqlConfiguration,
                                           @Qualifier("jdbcOlapSqlListExecutionRepository") final SqlListExecutionRepository reportingSqlListExecutionRepository,
                                           @Qualifier("jdbcWarehouseSqlListExecutionRepository") final SqlListExecutionRepository warehouseSqlListExecutionRepository,
                                           final SqlListExecutionWithMigrateRepository warehouseCopyRepository) {
        this.stepBuilderFactory = stepBuilderFactory;
        this.stagingToReportingSqlConfiguration = stagingToReportingSqlConfiguration;
        this.warehouseToStagingSqlConfiguration = warehouseToStagingSqlConfiguration;
        this.reportingSqlListExecutionRepository = reportingSqlListExecutionRepository;
        this.warehouseSqlListExecutionRepository = warehouseSqlListExecutionRepository;
        this.warehouseCopyRepository = warehouseCopyRepository;
    }

    @Bean
    public Step deleteEntitiesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder
                .addNext("fact_student_exam", "delete")
                .addNext("asmt", "delete")
                .addNext("school", "delete")
                .addNext("district", "delete")
                .addNext("school_group", "delete")
                .addNext("district_group", "delete")
                .addNext("student_ethnicity", "delete")
                .addNext("student", "delete");

        return stepBuilderFactory.get(deleteEntitiesStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertStudentsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder
                .addNext("student", "update")
                .addNext("student", "insert")
                .addNext("student_ethnicity", "insert")
                .addNext("student_ethnicity", "deleteAsPartOfParentUpdate");

        return stepBuilderFactory.get(upsertStudentsStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertOrganizationsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("district_group", "update")
                .addNext("district_group", "insert")
                .addNext("district", "update")
                .addNext("district", "insert")
                .addNext("school_group", "update")
                .addNext("school_group", "insert")
                .addNext("school", "update")
                .addNext("school", "insert");

        return stepBuilderFactory.get(upsertOrganizationsStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertAsmtsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("asmt", "update")
                .addNext("asmt", "insert");

        return stepBuilderFactory.get(upsertAsmtsStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertFactStudentExamStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("fact_student_exam", "updateStagingLatestExam")
                .addNext("fact_student_exam", "update")
                .addNext("fact_student_exam", "insert");

        return stepBuilderFactory.get(upsertFactStudentExamStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step deriveActiveAsmtStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities())
                .addNext("asmt_active_year", "delete")
                .addNext("asmt_active_year", "insert");

        return stepBuilderFactory.get(deriveActiveAsmtStep)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step truncateBeforeStageStep() {
        return stepBuilderFactory.get(stepTruncateStageName + "Before")
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        warehouseToStagingSqlConfiguration.getTruncateStageList())).build();
    }

    @Bean
    public Step truncateAfterStageStep() {
        return stepBuilderFactory.get(stepTruncateStageName + "After")
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        warehouseToStagingSqlConfiguration.getTruncateStageList())).build();
    }

    @Bean
    public Step upsertCodesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        for (final String entity : codes) {
            sqlsBuilder.addNext(entity, "update").addNext(entity, "insert");
        }
        return stepBuilderFactory.get(upsertCodesStepName)
                .tasklet(new SqlListCodesExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step deleteCodesStep() {
        //delete has to be in the reverse order from the insert
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        for (final String entity : Lists.reverse(codes)) {
            sqlsBuilder.addNext(entity, "delete");
        }
        return stepBuilderFactory.get(deleteCodesStepName)
                .tasklet(new SqlListCodesExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step extractCodesStep() {
        final List<String> sql = newArrayList();

        for (final String entity : codes) {
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity).getSql().get("warehouseRead"));
        }
        return stepBuilderFactory.get(extractCodesStep)
                .tasklet(new SqlListCodesExecutionStep(warehouseSqlListExecutionRepository, sql))
                .build();
    }

    @Bean
    public Step extractEmbargoStep() {
        final List<String> sql = newArrayList();
        sql.add(warehouseToStagingSqlConfiguration.getEntities().get("district_embargo").getSql().get("warehouseRead"));
        sql.add(warehouseToStagingSqlConfiguration.getEntities().get("state_embargo").getSql().get("warehouseRead"));
        return stepBuilderFactory.get(extractEmbargoStep)
                .tasklet(new SqlListEmbargoWithParamExecutionStep(warehouseCopyRepository, sql))
                .build();
    }

    @Bean
    public Step loadEmbargoToStagingStep() {
        final List<String> sql = newArrayList();
        sql.add(warehouseToStagingSqlConfiguration.getEntities().get("district_embargo").getSql().get("stagingInsert"));
        sql.add(warehouseToStagingSqlConfiguration.getEntities().get("state_embargo").getSql().get("stagingInsert"));
        return stepBuilderFactory.get(loadEmbargoToStagingStep)
                .tasklet(new SqlListEmbargoExecutionStep(reportingSqlListExecutionRepository, sql))
                .build();
    }

    @Bean
    public Step updateEmbargoStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("school_embargo", "update");
        sqlsBuilder.addNext("state_embargo", "delete");
        sqlsBuilder.addNext("state_embargo", "insert");

        return stepBuilderFactory.get(updateEmbargoStepName)
                .tasklet(new SqlListExecutionStep(
                        reportingSqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step loadCodesToStagingStep() {
        final List<String> sql = newArrayList();

        for (final String entity : codes) {
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity).getSql().get("stagingInsert"));
        }
        return stepBuilderFactory.get(loadCodesToStagingStep)
                .tasklet(new SqlListCodesExecutionStep(reportingSqlListExecutionRepository, sql))
                .build();
    }

    @Bean
    public Step extractEntitiesStep() {
        final List<String> sql = newArrayList();

        for (final String entity : warehouseEntities) {
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity).getSql().get("warehouseRead"));
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity + "_update").getSql().get("warehouseRead"));
        }
        return stepBuilderFactory.get(extractEntitiesStep)
                .tasklet(new SqlListWithParamExecutionStep(warehouseCopyRepository, sql))
                .build();
    }

    @Bean
    public Step loadEntitiesToStagingStep() {
        final List<String> sql = newArrayList();

        for (final String entity : warehouseEntities) {
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity).getSql().get("stagingInsert"));
            sql.add(warehouseToStagingSqlConfiguration.getEntities().get(entity + "_update").getSql().get("stagingInsert"));
        }
        return stepBuilderFactory.get(loadEntitiesToStagingStep)
                .tasklet(new SqlListExecutionStep(reportingSqlListExecutionRepository, sql))
                .build();
    }
}
