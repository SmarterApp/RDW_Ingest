sql:
  warehouseToStage:
  # ------------ Truncate ------------------------------------------------------------------
    truncateStageList:
      - delete from staging_administration_condition
      - delete from staging_completeness
      - delete from staging_elas
      - delete from staging_ethnicity
      - delete from staging_gender
      - delete from staging_grade
      - delete from staging_language
      - delete from staging_military_connected
      - delete from staging_school_year
      - delete from staging_subject
      - delete from staging_subject_score
      - delete from staging_subject_asmt_type
      - delete from staging_subject_asmt_scoring
      - delete from staging_target
      - delete from staging_school
      - delete from staging_district
      - delete from staging_district_group
      - delete from staging_school_group
      - delete from staging_district_embargo
      - delete from staging_state_embargo
      - delete from staging_student
      - delete from staging_student_ethnicity
      - delete from staging_asmt
      - delete from staging_asmt_target
      - delete from staging_asmt_target_exclusion
      - delete from staging_exam
      - delete from staging_exam_score
      - delete from staging_exam_target_score

    entities:
        # ------------ administration_condition  -------------------------------------------------------------------
        administration_condition:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM administration_condition
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/administration_condition'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_administration_condition (id, code)
                FROM '$[migrateLocationPlaceholder]/administration_condition.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ completeness  -------------------------------------------------------------------
        completeness:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM completeness
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/completeness'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_completeness (id, code)
                FROM '$[migrateLocationPlaceholder]/completeness.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ elas  -------------------------------------------------------------------
        elas:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM elas
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/elas'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_elas (id, code)
                FROM '$[migrateLocationPlaceholder]/elas.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ ethnicity  -------------------------------------------------------------------
        ethnicity:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM ethnicity
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/ethnicity'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_ethnicity (id, code)
                FROM '$[migrateLocationPlaceholder]/ethnicity.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ gender  -------------------------------------------------------------------
        gender:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM gender
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/gender'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_gender (id, code)
                FROM '$[migrateLocationPlaceholder]/gender.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ grade  -------------------------------------------------------------
        grade:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code,
                sequence
              FROM grade
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/grade'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_grade (id, code, sequence)
                FROM '$[migrateLocationPlaceholder]/grade.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ language  -------------------------------------------------------------------
        language:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM language
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/language'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_language (id, code)
                FROM '$[migrateLocationPlaceholder]/language.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ military_connected  -------------------------------------------------------------------
        military_connected:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code
              FROM military_connected
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/military_connected'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_military_connected (id, code)
                FROM '$[migrateLocationPlaceholder]/military_connected.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ school_year  -------------------------------------------------------------------
        school_year:
          sql:
            warehouseRead: >-
              SELECT
                year
              FROM school_year
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/year'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_school_year (year)
                FROM '$[migrateLocationPlaceholder]/year.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ subject  -------------------------------------------------------------------
        #  a subject entity once created cannot be updated or deleted, only its slaved entities could be modified
        subject:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM subject ws
                WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject(
                id,
                code,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/subject.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        subject_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                code,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM subject ws
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject(
                id,
                code,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/subject_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ target  -------------------------------------------------------------------
        # For Smarter Balanced Math, only the Concepts and Procedures targets are included
        target:
          sql:
            warehouseRead: >-
              SELECT wt.id, ws.id, wt.natural_id, wc.code, :migrate_id as migrate_id
              FROM target wt
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
              WHERE ( ws.code <> 'Math' OR wc.code='1' ) AND  ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/target'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_target (id, subject_id, natural_id, claim_code, migrate_id)
                FROM '$[migrateLocationPlaceholder]/target.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        target_update:
          sql:
            warehouseRead: >-
              SELECT wt.id, ws.id, wt.natural_id, wc.code, :migrate_id as migrate_id
              FROM target wt
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
              WHERE ( ws.code <> 'Math' OR wc.code='1' ) AND ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/target_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_target (id, subject_id, natural_id, claim_code, migrate_id)
                FROM '$[migrateLocationPlaceholder]/target_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ subject_asmt_type  ---------------------------------------------------------------------------------------
        subject_asmt_type:
          sql:
            warehouseRead: >-
              SELECT wsat.subject_id, wsat.asmt_type_id, wsat.target_report, :migrate_id as migrate_id
              FROM subject_asmt_type wsat
                JOIN subject ws ON ws.id = wsat.subject_id
              WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_asmt_type'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_asmt_type (subject_id, asmt_type_id, target_report, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_asmt_type.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        subject_asmt_type_update:
          sql:
            warehouseRead: >-
              SELECT wsat.subject_id, wsat.asmt_type_id, wsat.target_report, :migrate_id as migrate_id
              FROM subject_asmt_type wsat
                JOIN subject ws ON ws.id = wsat.subject_id
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_asmt_type_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_asmt_type (subject_id, asmt_type_id, target_report, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_asmt_type_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ subject_asmt_scoring  ---------------------------------------------------------------------------------------
        subject_asmt_scoring:
          sql:
            warehouseRead: >-
              SELECT wsas.subject_id, wsas.asmt_type_id, wsas.score_type_id, wsas.min_score, wsas.max_score, wsas.performance_level_count, wsas.performance_level_standard_cutoff, :migrate_id as migrate_id
              FROM subject_asmt_scoring wsas
                JOIN subject ws ON ws.id = wsas.subject_id
              WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_asmt_scoring'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_asmt_scoring (subject_id, asmt_type_id, score_type_id, min_score, max_score, performance_level_count, performance_level_standard_cutoff, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_asmt_scoring.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        subject_asmt_scoring_update:
          sql:
            warehouseRead: >-
              SELECT wsas.subject_id, wsas.asmt_type_id, wsas.score_type_id, wsas.min_score, wsas.max_score, wsas.performance_level_count, wsas.performance_level_standard_cutoff, :migrate_id as migrate_id
              FROM subject_asmt_scoring wsas
                JOIN subject ws ON ws.id = wsas.subject_id
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_asmt_scoring_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_asmt_scoring (subject_id, asmt_type_id, score_type_id, min_score, max_score, performance_level_count, performance_level_standard_cutoff, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_asmt_scoring_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ subject_score ---------------------------------------------------------------------------
        subject_score:
          sql:
            warehouseRead: >-
              SELECT wss.id, wss.subject_id, wss.asmt_type_id, wss.score_type_id, wss.code, :migrate_id as migrate_id
              FROM subject_score wss
                JOIN subject ws ON ws.id = wss.subject_id
              WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_score'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_score (id, subject_id, asmt_type_id, score_type_id, code, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_score.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        subject_score_update:
          sql:
            warehouseRead: >-
              SELECT wss.id, wss.subject_id, wss.asmt_type_id, wss.score_type_id, wss.code, :migrate_id as migrate_id
              FROM subject_score wss
                JOIN subject ws ON ws.id = wss.subject_id
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/subject_score_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_subject_score (id, subject_id, asmt_type_id, score_type_id, code, migrate_id)
                FROM '$[migrateLocationPlaceholder]/subject_score_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ student  -------------------------------------------------------------------
        student:
          sql:
            warehouseRead: >-
              SELECT
                id,
                gender_id,
                deleted,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM student ws
                WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/student'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_student(
                id,
                gender_id,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/student.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        student_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                gender_id,
                deleted,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM student ws
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/student_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_student(
                id,
                gender_id,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/student_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ student_ethnicity  -------------------------------------------------------------------
        student_ethnicity:
          sql:
            warehouseRead: >-
              SELECT
                ethnicity_id,
                student_id,
                :migrate_id as migrate_id
              FROM student_ethnicity
                JOIN student ws ON ws.id = student_ethnicity.student_id
              WHERE ws.created > :first_at AND ws.created <= :last_at AND ws.deleted = 0
                INTO OUTFILE S3 '$[migrateLocationPlaceholder]/student_ethnicity'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_student_ethnicity(
                ethnicity_id,
                student_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/student_ethnicity.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        student_ethnicity_update:
          sql:
            warehouseRead: >-
              SELECT
                ethnicity_id,
                student_id,
                :migrate_id as migrate_id
              FROM student_ethnicity
                JOIN student ws ON ws.id = student_ethnicity.student_id
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created AND ws.deleted = 0
                INTO OUTFILE S3 '$[migrateLocationPlaceholder]/student_ethnicity_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_student_ethnicity (
                ethnicity_id,
                student_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/student_ethnicity_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ asmt -------------------------------------------------------------------
        # NOTE: "AND was.subject_score_id IS NULL" selects just the OVERALL score info
        asmt:
          sql:
            warehouseRead: >-
              SELECT
                wa.id,
                wa.grade_id,
                wa.type_id,
                wa.school_year,
                wa.subject_id,
                wa.name,
                wa.label,
                round(was.cut_point_1) AS cut_point_1,
                round(was.cut_point_2) AS cut_point_2,
                round(was.cut_point_3) AS cut_point_3,
                round(was.cut_point_4) AS cut_point_4,
                round(was.cut_point_5) AS cut_point_5,
                round(was.min_score) AS min_score,
                round(was.max_score) AS max_score,
                wa.deleted,
                wa.updated,
                wa.update_import_id,
                :migrate_id as migrate_id
              FROM asmt wa JOIN asmt_score was ON wa.id = was.asmt_id AND was.subject_score_id IS NULL
              WHERE wa.created > :first_at AND wa.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/asmt'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt(
                id,
                grade_id,
                type_id,
                school_year,
                subject_id,
                name,
                label,
                cut_point_1,
                cut_point_2,
                cut_point_3,
                cut_point_4,
                cut_point_5,
                min_score,
                max_score,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/asmt.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        asmt_update:
          sql:
            warehouseRead: >-
              SELECT
                wa.id,
                wa.grade_id,
                wa.type_id,
                wa.school_year,
                wa.subject_id,
                wa.name,
                wa.label,
                round(was.cut_point_1) AS cut_point_1,
                round(was.cut_point_2) AS cut_point_2,
                round(was.cut_point_3) AS cut_point_3,
                round(was.cut_point_4) AS cut_point_4,
                round(was.cut_point_5) AS cut_point_5,
                round(was.min_score) AS min_score,
                round(was.max_score) AS max_score,
                wa.deleted,
                wa.updated,
                wa.update_import_id,
                :migrate_id as migrate_id
              FROM asmt wa JOIN asmt_score was ON wa.id = was.asmt_id AND was.subject_score_id IS NULL
              WHERE wa.updated > :first_at AND wa.updated <= :last_at AND wa.updated <> wa.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/asmt_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt(
                id,
                grade_id,
                type_id,
                school_year,
                subject_id,
                name,
                label,
                cut_point_1,
                cut_point_2,
                cut_point_3,
                cut_point_4,
                cut_point_5,
                min_score,
                max_score,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/asmt_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ asmt_target_exclusion  -------------------------------------------------------------------
        # Only Summative target scores are included
        # For Smarter Balanced Math, only the Concepts and Procedures targets are included
        asmt_target_exclusion:
          sql:
            warehouseRead: >-
              SELECT
                wats.asmt_id,
                wats.target_id,
                :migrate_id as migrate_id
              FROM asmt_target_exclusion wats
                JOIN asmt wa ON wa.id = wats.asmt_id
                JOIN target wt ON wt.id = wats.target_id
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
              WHERE wa.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                 wa.created > :first_at AND wa.created <= :last_at AND wa.deleted = 0
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exclusion_asmt_target'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt_target_exclusion(
                asmt_id,
                target_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exclusion_asmt_target.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        asmt_target_exclusion_update:
          sql:
            warehouseRead: >-
              SELECT
                wats.asmt_id,
                wats.target_id,
                :migrate_id as migrate_id
              FROM asmt_target_exclusion wats
                 JOIN asmt wa ON wa.id = wats.asmt_id
                  JOIN target wt ON wt.id = wats.target_id
                  JOIN claim wc ON wc.id = wt.claim_id
                  JOIN subject ws ON ws.id = wc.subject_id
                WHERE wa.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                      wa.updated > :first_at AND wa.updated <= :last_at AND wa.updated <> wa.created AND wa.deleted = 0
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exclusion_asmt_target_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt_target_exclusion(
                asmt_id,
                target_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exclusion_asmt_target_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ asmt_target  -------------------------------------------------------------------
        # Only Summative target scores are included
        # For Smarter Balanced Math, only the Concepts and Procedures targets are included
        #
        # Note: while target data are 'slaves' of the subject master entity, in this case we are concerned only about targets in the context
        # of the assessment package and therefore making it dependant on it.
        asmt_target:
          sql:
            warehouseRead: >-
              SELECT DISTINCT
                wi.asmt_id,
                wi.target_id,
                :migrate_id as migrate_id
              FROM item wi JOIN asmt wa ON wa.id = wi.asmt_id
                  JOIN target wt ON wt.id = wi.target_id
                  JOIN claim wc ON wc.id = wt.claim_id
                  JOIN subject ws ON ws.id = wc.subject_id
                WHERE wa.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                      wa.created > :first_at AND wa.created <= :last_at AND wa.deleted = 0
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/asmt_target'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt_target(
                asmt_id,
                target_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/asmt_target.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        asmt_target_update:
          sql:
            warehouseRead: >-
              SELECT DISTINCT
                wi.asmt_id,
                wi.target_id,
                :migrate_id as migrate_id
              FROM item wi JOIN asmt wa ON wa.id = wi.asmt_id
                JOIN target wt ON wt.id = wi.target_id
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
                WHERE wa.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                  wa.updated > :first_at AND wa.updated <= :last_at AND wa.updated <> wa.created AND wa.deleted = 0
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/asmt_target_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_asmt_target(
                asmt_id,
                target_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/asmt_target_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ school  -------------------------------------------------------------------
        school:
          sql:
            warehouseRead: >-
              SELECT
                id,
                district_id,
                name,
                natural_id,
                external_id,
                school_group_id,
                district_group_id,
                deleted,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM school ws
              WHERE ws.created > :first_at AND ws.created <= :last_at
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/school'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_school(
                id,
                district_id,
                name,
                natural_id,
                external_id,
                school_group_id,
                district_group_id,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/school.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        school_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                district_id,
                name,
                natural_id,
                external_id,
                school_group_id,
                district_group_id,
                deleted,
                updated,
                update_import_id,
                :migrate_id as migrate_id
              FROM school ws
              WHERE ws.updated > :first_at AND ws.updated <= :last_at AND ws.updated <> ws.created
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/school_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_school(
                id,
                district_id,
                name,
                natural_id,
                external_id,
                school_group_id,
                district_group_id,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/school_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ district  -------------------------------------------------------------------
        district:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM district wd
              WHERE EXISTS( SELECT id FROM school  WHERE created > :first_at AND created <= :last_at AND deleted = 0 AND district_id = wd.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/district'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_district(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/district.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        district_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM district wd
              WHERE EXISTS( SELECT id FROM school WHERE updated > :first_at AND updated <= :last_at AND updated <> created AND deleted = 0 AND district_id = wd.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/district_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                             LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_district(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/district_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ district_group  -------------------------------------------------------------------
        district_group:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM district_group wdg
                WHERE EXISTS( SELECT id FROM school  WHERE created > :first_at AND created <= :last_at AND deleted = 0 AND district_group_id = wdg.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/dstrgroup'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_district_group(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/dstrgroup.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        district_group_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM district_group wdg
               WHERE EXISTS( SELECT id FROM school WHERE updated > :first_at AND updated <= :last_at AND updated <> created AND deleted = 0 AND district_group_id = wdg.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/dstrgroup_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_district_group(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/dstrgroup_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ school_group  -------------------------------------------------------------------
        school_group:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM school_group wsg
               WHERE EXISTS( SELECT id FROM school  WHERE created > :first_at AND created <= :last_at AND deleted = 0 AND school_group_id = wsg.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/schgroup'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_school_group(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/schgroup.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        school_group_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                name,
                natural_id,
                external_id,
                :migrate_id as migrate_id
              FROM school_group wdg
               WHERE EXISTS( SELECT id FROM school WHERE updated > :first_at AND updated <= :last_at AND updated <> created AND deleted = 0 AND school_group_id = wdg.id)
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/schgroup_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_school_group(
                id,
                name,
                natural_id,
                external_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/schgroup_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ exam  -------------------------------------------------------------------
        exam:
          sql:
            warehouseRead: >-
              SELECT
                id,
                student_id,
                grade_id,
                school_id,
                iep,
                lep,
                section504,
                economic_disadvantage,
                migrant_status,
                type_id,
                school_year,
                asmt_id,
                elas_id,
                language_id,
                completeness_id,
                administration_condition_id,
                military_connected_id,
                scale_score,
                performance_level,
                completed_at,
                deleted,
                updated,
                update_import_id,
               :migrate_id as migrate_id
              FROM exam we
                WHERE we.created > :first_at AND we.created <= :last_at AND we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam(
                id,
                student_id,
                grade_id,
                school_id,
                iep,
                lep,
                section504,
                economic_disadvantage,
                migrant_status,
                type_id,
                school_year,
                asmt_id,
                elas_id,
                language_id,
                completeness_id,
                administration_condition_id,
                military_connected_id,
                scale_score,
                performance_level,
                completed_at,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        exam_update:
          sql:
            warehouseRead: >-
              SELECT
                id,
                student_id,
                grade_id,
                school_id,
                iep,
                lep,
                section504,
                economic_disadvantage,
                migrant_status,
                type_id,
                school_year,
                asmt_id,
                elas_id,
                language_id,
                completeness_id,
                administration_condition_id,
                military_connected_id,
                scale_score,
                performance_level,
                completed_at,
                deleted,
                updated,
                update_import_id,
               :migrate_id as migrate_id
              FROM exam we
              WHERE we.updated > :first_at AND we.updated <= :last_at AND we.updated <> we.created AND we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam(
                id,
                student_id,
                grade_id,
                school_id,
                iep,
                lep,
                section504,
                economic_disadvantage,
                migrant_status,
                type_id,
                school_year,
                asmt_id,
                elas_id,
                language_id,
                completeness_id,
                administration_condition_id,
                military_connected_id,
                scale_score,
                performance_level,
                completed_at,
                deleted,
                updated,
                update_import_id,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              TIMEFORMAT 'auto'
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ exam_score  -------------------------------------------------------------------
        exam_score:
          sql:
            warehouseRead: >-
              SELECT
                ecs.id,
                ecs.exam_id,
                ecs.subject_score_id,
                ecs.performance_level,
                :migrate_id as migrate_id
              FROM exam_score ecs
                JOIN exam we ON we.id = ecs.exam_id
               WHERE we.created > :first_at AND we.deleted = 0 AND we.created <= :last_at
                AND we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL AND ecs.performance_level IS NOT NULL
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam_score'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam_score(
                id,
                exam_id,
                subject_score_id,
                performance_level,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam_score.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        exam_score_update:
          sql:
            warehouseRead: >-
              SELECT
                ecs.id,
                ecs.exam_id,
                ecs.subject_score_id,
                ecs.performance_level,
                :migrate_id as migrate_id
              FROM exam_score ecs
                JOIN exam we ON we.id = ecs.exam_id
              WHERE we.updated > :first_at AND we.deleted = 0 AND we.updated <= :last_at AND we.updated <> we.created
                AND we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL AND ecs.performance_level IS NOT NULL
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam_score_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"' LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam_score(
                id,
                exam_id,
                subject_score_id,
                performance_level,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam_score_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        # ------------ exam_target_score  -------------------------------------------------------------------
        # Only Summative target scores are included
        # For Smarter Balanced Math, only the Concepts and Procedures targets are included
        exam_target_score:
          sql:
            warehouseRead: >-
              SELECT
                wets.id,
                wets.exam_id,
                wets.target_id,
                wets.student_relative_residual_score,
                wets.standard_met_relative_residual_score,
                :migrate_id as migrate_id
              FROM exam_target_score wets
                JOIN exam we ON wets.exam_id = we.id
                JOIN target wt ON wt.id = wets.target_id
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
              WHERE we.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                  we.created > :first_at AND we.deleted = 0 AND we.created <= :last_at AND
                  we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL AND
                  wets.standard_met_relative_residual_score IS NOT NULL AND wets.student_relative_residual_score IS NOT NULL
                INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam_target_score'
                FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam_target_score(
                id,
                exam_id,
                target_id,
                student_relative_residual_score,
                standard_met_relative_residual_score,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam_target_score.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

        exam_target_score_update:
          sql:
            warehouseRead: >-
              SELECT
                wets.id,
                wets.exam_id,
                wets.target_id,
                wets.student_relative_residual_score,
                wets.standard_met_relative_residual_score,
                :migrate_id as migrate_id
              FROM exam_target_score wets
                JOIN exam we ON wets.exam_id = we.id
                JOIN target wt ON wt.id = wets.target_id
                JOIN claim wc ON wc.id = wt.claim_id
                JOIN subject ws ON ws.id = wc.subject_id
              WHERE we.type_id = 3 AND ( ws.code <> 'Math' OR wc.code='1' ) AND
                we.updated > :first_at AND we.deleted = 0 AND we.updated <= :last_at AND we.updated <> we.created AND
                we.scale_score IS NOT NULL AND we.performance_level IS NOT NULL AND
                wets.standard_met_relative_residual_score IS NOT NULL AND wets.student_relative_residual_score IS NOT NULL
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/exam_target_score_update'
              FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
              LINES TERMINATED BY '\n'

            stagingInsert: >-
              COPY staging_exam_target_score(
                id,
                exam_id,
                target_id,
                student_relative_residual_score,
                standard_met_relative_residual_score,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/exam_target_score_update.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

# ------------ district_embargo  -------------------------------------------------------------------
        district_embargo:
          sql:
            warehouseRead:
              SELECT
                e.district_id,
                e.aggregate,
                :migrate_id as migrate_id
              FROM (${sql.embargo}) e
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/embargo'
                FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                LINES TERMINATED BY '\n'

            stagingInsert:
              COPY staging_district_embargo (
                district_id,
                aggregate,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/embargo.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF

# ------------ district_embargo  -------------------------------------------------------------------
        state_embargo:
          sql:
            warehouseRead:
              SELECT
                IF(aggregate = 0, 0, 1) AS aggregate,
                :migrate_id as migrate_id
              FROM state_embargo
              WHERE school_year = :system_school_year
              INTO OUTFILE S3 '$[migrateLocationPlaceholder]/state_embargo'
                FIELDS TERMINATED BY ',' OPTIONALLY ENCLOSED BY '"'
                LINES TERMINATED BY '\n'

            stagingInsert:
              COPY staging_state_embargo (
                aggregate,
                migrate_id)
              FROM '$[migrateLocationPlaceholder]/state_embargo.part_00000'
              CREDENTIALS 'aws_iam_role=${migrate.aws.redshift.role}'
              FORMAT AS CSV
              DELIMITER ','
              COMPUPDATE OFF
