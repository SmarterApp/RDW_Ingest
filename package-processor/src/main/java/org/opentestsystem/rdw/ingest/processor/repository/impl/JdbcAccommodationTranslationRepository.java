package org.opentestsystem.rdw.ingest.processor.repository.impl;

import com.google.common.collect.Iterables;
import org.opentestsystem.rdw.ingest.processor.model.Accommodation;
import org.opentestsystem.rdw.ingest.processor.repository.AccommodationTranslationRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.SqlParameterSource;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;

/**
 * DefaultAccommodationTranslationRepository - Operates on the accommodation_translation table and inserts
 * the accommodation codes and their description translations
 */
@Repository
public class JdbcAccommodationTranslationRepository implements AccommodationTranslationRepository {
    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.accommodation.create}")
    private String accommodationCreate;

    @Value("${sql.accommodationTranslation.create}")
    private String accommodationTranslationCreate;

    @Autowired
    JdbcAccommodationTranslationRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
    /**
     * Creates an entry in the accommodation_translation table
     *
     * @param accommodations - Collection of accommodations with translation data to insert in to the database
     * @throws IllegalArgumentException
     */
    @Override
    @Transactional
    public void create(final Iterable<Accommodation> accommodations) {
        createAccommodations(accommodations);
        batchCreateTranslations(accommodations);
    }

    private void createAccommodations(Iterable<Accommodation> accommodations) {
        for (Accommodation acc : accommodations) {
            final SqlParameterSource parameterSource = new MapSqlParameterSource()
                    .addValue("code", acc.code());

            jdbcTemplate.update(accommodationCreate, parameterSource);
        }
    }

    private void batchCreateTranslations(final Iterable<Accommodation> accommodations) {
        if(Iterables.size(accommodations) == 0) return;

        ArrayList<MapSqlParameterSource> batchParameters = new ArrayList<>();

        for (Accommodation acc : accommodations) {
            for (Integer langId : acc.translations().keySet()) {
                batchParameters.add(new MapSqlParameterSource()
                        .addValue("accCode", acc.code())
                        .addValue("langId", langId)
                        .addValue("label", acc.translations().get(langId))
                );
            }
        }
        
        jdbcTemplate.batchUpdate(accommodationTranslationCreate,
                batchParameters.toArray(new MapSqlParameterSource[batchParameters.size()]));
    }
}
