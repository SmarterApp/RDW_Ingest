package org.opentestsystem.rdw.ingest.processor.repository.impl;

import com.google.common.collect.ImmutableList;
import org.opentestsystem.rdw.ingest.processor.model.WarehouseStandard;
import org.opentestsystem.rdw.ingest.processor.repository.StandardRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.Collection;
import java.util.List;
import java.util.stream.Collectors;

/**
 * JDBC implementation of a StandardRepository
 */
@Repository
class JdbcStandardRepository implements StandardRepository {

    private final NamedParameterJdbcTemplate template;

    @Value("${sql.standard.findBySubject}")
    private String sqlFindBySubject;

    @Value("${sql.standard.insert}")
    private String sqlCreate;

    @Value("${sql.standard.delete}")
    private String sqlDelete;

    @Value("${sql.standard.hasItem}")
    private String sqlHasItem;

    @Autowired
    public JdbcStandardRepository(final NamedParameterJdbcTemplate template) {
        this.template = template;
    }

    @Override
    public Collection<WarehouseStandard> findBySubject(final String subjectCode) {
        return template.query(sqlFindBySubject,
                new MapSqlParameterSource("subject_code", subjectCode),
                (row, rowNum) -> WarehouseStandard.builder()
                        .id(row.getInt("id"))
                        .code(row.getString("natural_id"))
                        .build());
    }

    @Override
    public void create(final String subjectCode, final Collection<String> standards) {
        if (standards.isEmpty()) return;

        final List<String> standardsList = ImmutableList.copyOf(standards);
        final int[] insertCounts = template.batchUpdate(sqlCreate, standards.stream().map(standard ->
                new MapSqlParameterSource("subject_code", subjectCode)
                        .addValue("standard_code", standard))
                .collect(Collectors.toList())
                .toArray(new MapSqlParameterSource[0]));

        for (int i = 0; i < insertCounts.length; i++) {
            if (insertCounts[i] != 1)
                throw new IllegalArgumentException("Unable to create standard: " + standardsList.get(i) +
                        " for  subject: " + subjectCode);
        }
    }

    @Override
    public void delete(final Collection<Integer> standardIds) {
        if (standardIds.isEmpty()) return;

        template.update(sqlDelete, new MapSqlParameterSource("ids", standardIds));
    }

    @Override
    public Integer hasItem(final Collection<Integer> standardIds) {
        if (standardIds.isEmpty()) return null;

        try {
            return template.queryForObject(sqlHasItem,
                    new MapSqlParameterSource("ids", standardIds),
                    Integer.class);
        } catch (final EmptyResultDataAccessException e) {
            return null;
        }
    }
}
