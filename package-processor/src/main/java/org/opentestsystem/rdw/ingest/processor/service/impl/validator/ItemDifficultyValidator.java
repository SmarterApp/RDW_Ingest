package org.opentestsystem.rdw.ingest.processor.service.impl.validator;

import org.opentestsystem.rdw.common.model.subject.ItemDifficulty;
import org.opentestsystem.rdw.common.model.subject.Subject;
import org.opentestsystem.rdw.ingest.common.util.LocationAwareErrorCollector;
import org.opentestsystem.rdw.ingest.processor.service.SubjectValidator;
import org.springframework.stereotype.Component;

import java.util.Set;

import static com.google.common.collect.Sets.newHashSet;

/**
 * This validator is responsible for ensuring valid {@link ItemDifficulty} models
 * within a {@link Subject} model.
 */
@Component
class ItemDifficultyValidator implements SubjectValidator {

    @Override
    public void validate(final LocationAwareErrorCollector context, final Subject subject) {
        if (subject.getItemDifficulties() == null) return;

        final Set<String> gradeCodes = newHashSet();
        for (final ItemDifficulty difficulty : subject.getItemDifficulties()) {
            final String code = difficulty.getGradeCode();
            context.push("ItemDifficulty", code);
            if (!gradeCodes.add(code)) {
                context.failure("Duplicate code found: " + code);
            }

            if (difficulty.getModerateLowEnd() > difficulty.getDifficultLowEnd()) {
                context.failure("Moderate low end cutpoint must be less than the difficult low end cutpoint");
            }
            context.pop();
        }

    }
}
