package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.apache.commons.csv.CSVFormat;
import org.apache.commons.csv.CSVRecord;
import org.opentestsystem.rdw.ingest.common.model.ImportException;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Item;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentRepository;
import org.opentestsystem.rdw.ingest.processor.service.AssessmentPackageProcessor;
import org.opentestsystem.rdw.ingest.processor.service.AssessmentParser;
import org.opentestsystem.rdw.ingest.processor.service.ItemParser;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import static org.opentestsystem.rdw.ingest.common.model.ImportStatus.BAD_DATA;
import static org.opentestsystem.rdw.ingest.common.model.ImportStatus.BAD_FORMAT;


@Service
public class DefaultAssessmentPackageProcessor implements AssessmentPackageProcessor {
    private static final Logger logger = LoggerFactory.getLogger(DefaultAssessmentPackageProcessor.class);

    private Set<Assessment> assessments;
    private List<Item> items;

    private final AssessmentParser assessmentParser;
    private final ItemParser itemParser;

    private final AssessmentRepository asmtRepository;

    @Autowired
    public DefaultAssessmentPackageProcessor(final AssessmentParser assessmentParser,
                                      final ItemParser itemParser,
                                      final AssessmentRepository asmtRepository) {
        this.assessments = new HashSet<Assessment>();
        this.items = new ArrayList<Item>();
        this.assessmentParser = assessmentParser;
        this.itemParser = itemParser;
        this.asmtRepository = asmtRepository;
    }

    @Override
    public void process(final String assessment) throws ImportException {
        try {
            Iterable<CSVRecord> records = CSVFormat.RFC4180.withFirstRecordAsHeader().parse(new StringReader(assessment));
            //Pass in a container for errors - keeping track of what line the errors are on.
            //If there are errors in the container, don't insert anything into the database
            //Throw bad data import exception
            for(CSVRecord record : records) {
                assessments.add(assessmentParser.parse(record));
                items.add(itemParser.parse(record));
            }
            //Insert into database
            for (Assessment asmt : assessments) {

            }
            logger.info(String.format("Processed %d assesssments and %d items", assessments.size(), items.size()));
        } catch (final IllegalArgumentException e) {
            throw new ImportException(BAD_DATA, e.toString());
        } catch (final IOException ioe) {
            throw new ImportException(BAD_FORMAT, ioe.toString());
        }

    }
}
