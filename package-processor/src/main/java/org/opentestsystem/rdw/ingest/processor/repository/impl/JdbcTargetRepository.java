package org.opentestsystem.rdw.ingest.processor.repository.impl;

import com.google.common.collect.ImmutableList;
import org.opentestsystem.rdw.ingest.processor.model.WarehouseTarget;
import org.opentestsystem.rdw.ingest.processor.repository.TargetRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.BatchPreparedStatementSetter;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.Collection;
import java.util.List;

@Repository
class JdbcTargetRepository implements TargetRepository {
    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.target.findIdByNaturalIdAndClaimId}")
    private String sqlFindIdByNaturalIdAndClaimId;

    @Value("${sql.target.findBySubject}")
    private String sqlFindBySubject;

    @Value("${sql.target.insert}")
    private String sqlCreateTarget;

    @Value("${sql.target.delete}")
    private String sqlDeleteTarget;

    @Value("${sql.target.hasItems}")
    private String sqlTargetHasItems;

    @Autowired
    JdbcTargetRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    @Cacheable(value = "target")
    public Integer findIdByNaturalIdAndClaimId(final String naturalId, final int claimId) {
        try {
            return jdbcTemplate.queryForObject(sqlFindIdByNaturalIdAndClaimId,
                    new MapSqlParameterSource()
                            .addValue("naturalId", naturalId)
                            .addValue("claimId", claimId), Integer.class);
        } catch (final EmptyResultDataAccessException ignore) {
            return null;
        }
    }

    @Override
    public Collection<WarehouseTarget> findBySubject(final String subjectCode) {
        return jdbcTemplate.query(sqlFindBySubject,
                new MapSqlParameterSource("subject_code", subjectCode),
                (row, rowNum) -> WarehouseTarget.builder()
                        .id(row.getInt("id"))
                        .claimCode(row.getString("claim_code"))
                        .naturalId(row.getString("natural_id"))
                        .build());
    }

    @Override
    public void create(final String subjectCode, final Collection<WarehouseTarget> targets) {
        if (targets.isEmpty()) return;

        final List<WarehouseTarget> targetList = ImmutableList.copyOf(targets);
        final int[] insertCounts = jdbcTemplate.getJdbcOperations().batchUpdate(sqlCreateTarget, new BatchPreparedStatementSetter() {
            @Override
            public void setValues(final PreparedStatement ps, final int i) throws SQLException {
                final WarehouseTarget target = targetList.get(i);
                ps.setString(1, target.getNaturalId());
                ps.setString(2, target.getClaimCode());
                ps.setString(3, subjectCode);
            }

            @Override
            public int getBatchSize() {
                return targets.size();
            }
        });

        for (int i = 0; i < insertCounts.length; i++) {
            if (insertCounts[i] != 1)
            throw new IllegalArgumentException("Unable to create target: " + targetList.get(i).getNaturalId() + " for claim: " + targetList.get(i).getClaimCode() + " subject: " + subjectCode);
        }
    }

    @Override
    public void delete(final Collection<Integer> targetIds) {
        if (targetIds.isEmpty()) return;

        jdbcTemplate.update(sqlDeleteTarget,
                new MapSqlParameterSource("target_ids", targetIds));
    }

    @Override
    public Integer hasItems(final Collection<Integer> targetIds) {
        if (targetIds.isEmpty()) return null;

        try {
            return jdbcTemplate.queryForObject(sqlTargetHasItems,
                    new MapSqlParameterSource("target_ids", targetIds),
                    Integer.class);
        } catch (final EmptyResultDataAccessException e) {
            return null;
        }
    }
}
