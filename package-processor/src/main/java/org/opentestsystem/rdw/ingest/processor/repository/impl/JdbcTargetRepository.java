package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.opentestsystem.rdw.ingest.processor.model.WarehouseTarget;
import org.opentestsystem.rdw.ingest.processor.repository.TargetRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.dao.EmptyResultDataAccessException;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

import java.util.Collection;

@Repository
class JdbcTargetRepository implements TargetRepository {
    private final NamedParameterJdbcTemplate jdbcTemplate;

    @Value("${sql.target.findIdByNaturalIdAndClaimId}")
    private String sqlFindIdByNaturalIdAndClaimId;

    @Value("${sql.target.findBySubject}")
    private String sqlFindBySubject;

    @Value("${sql.target.insert}")
    private String sqlCreateTarget;

    @Value("${sql.target.delete}")
    private String sqlDeleteTarget;

    @Value("${sql.target.hasItems}")
    private String sqlTargetHasItems;

    @Autowired
    JdbcTargetRepository(final NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    @Override
    @Cacheable(value = "target")
    public Integer findIdByNaturalIdAndClaimId(final String naturalId, final int claimId) {
        try {
            return jdbcTemplate.queryForObject(sqlFindIdByNaturalIdAndClaimId,
                    new MapSqlParameterSource()
                            .addValue("naturalId", naturalId)
                            .addValue("claimId", claimId), Integer.class);
        } catch (final EmptyResultDataAccessException ignore) {
            return null;
        }
    }

    @Override
    public Collection<WarehouseTarget> findBySubject(final String subjectCode) {
        return jdbcTemplate.query(sqlFindBySubject,
                new MapSqlParameterSource("subject_code", subjectCode),
                (row, rowNum) -> WarehouseTarget.builder()
                        .id(row.getInt("id"))
                        .claimCode(row.getString("claim_code"))
                        .naturalId(row.getString("natural_id"))
                        .build());
    }

    @Override
    public void create(final String subjectCode, final String claimCode, final String naturalId) {
        final int insertCount = jdbcTemplate.update(sqlCreateTarget,
                new MapSqlParameterSource("subject_code", subjectCode)
                        .addValue("claim_code", claimCode)
                        .addValue("natural_id", naturalId));

        if (insertCount != 1) {
            throw new IllegalArgumentException("Unable to create target: " + naturalId + " for claim: " + claimCode + " subject: " + subjectCode);
        }
    }

    @Override
    public void delete(final int targetId) {
        jdbcTemplate.update(sqlDeleteTarget,
                new MapSqlParameterSource("target_id", targetId));
    }

    @Override
    public boolean hasItems(final int targetId) {
        return jdbcTemplate.queryForObject(sqlTargetHasItems,
                new MapSqlParameterSource("target_id", targetId),
                Boolean.class);
    }
}
