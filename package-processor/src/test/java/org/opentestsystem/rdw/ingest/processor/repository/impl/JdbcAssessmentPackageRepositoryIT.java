package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.common.test.CachingTest;
import org.opentestsystem.rdw.ingest.processor.model.Assessment;
import org.opentestsystem.rdw.ingest.processor.model.Item;
import org.opentestsystem.rdw.ingest.processor.repository.AssessmentPackageRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import java.util.Map;

import static com.google.common.collect.Lists.newArrayList;
import static com.google.common.collect.Maps.newHashMap;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTable;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;

@RunWith(SpringRunner.class)
@SpringBootTest
@Transactional
@CachingTest
@ActiveProfiles("test")
@Sql(statements = {
        "INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
        "INSERT INTO common_core_standard (id, natural_id, subject_id, description) VALUES " +
                "(-99, 'natural-id-999', 1, 'test')," +
                "(-98, 'natural-id-998', 1, 'test')",
        "INSERT INTO claim (id, subject_id, code, name, description) VALUES \n" +
                "(-12, 1, '11', 'Concepts and Procedures', 'Concepts and Procedures - Students can explain and apply mathematical concepts and interpret and carry out mathematical procedures with precision and fluency.');",
        "INSERT INTO target (id, claim_id, natural_id, code, description) VALUES \n" +
                "(-1111, -12,'TA-APR', 'TA-APR', 'Test Arithmetic with Polynomials and Rational Expressions');",
        "INSERT INTO depth_of_knowledge (id, level, subject_id, description, reference) VALUES \n" +
                "(-11, -11, 1, 'Total recall of knowledge', 'reference');",
        "INSERT INTO math_practice (practice, description, code) VALUES \n" +
                "(-11, 'Makes no sense of problems and cannot persevere in solving them', '-11');"
})
public class JdbcAssessmentPackageRepositoryIT {
    @Autowired
    private AssessmentPackageRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private Item.Builder itemBuilder;
    private Assessment.Builder asmtBuilder;

    @Before
    public void setUp() {
        asmtBuilder = new Assessment.Builder();
        itemBuilder = new Item.Builder();
        asmtBuilder.cutPoint1(2.0e3)
                .cutPoint2(2.1e3)
                .cutPoint3(2.2e3)
                .schoolYear(2017)
                .gradeId(3)
                .label("label")
                .maxScore(2.4e3)
                .minScore(1.9e3)
                .name("My Assessment")
                .subjectId(1)
                .typeId(1)
                .version("version")
                .naturalId("(SBAC)SBAC-Winter-2016-2017");

        itemBuilder.mathPractice(-11)
                .targetId(-1111)
                .allowCalculator(false)
                .claimId(-12)
                .difficulty(0.23)
                .dokId(-11)
                .maxPoints(2.0)
                .naturalId("20-18943")
                .commonCoreStandards(newArrayList(-99, -98))
                .otherTargets(newArrayList(-1111));
    }

    @Test
    public void itShouldCreateAssessmentsAndScoresAndItems() {
        final int beforeAsmtCount = countRowsInTable(jdbcTemplate, "asmt");
        final int beforeItemCount = countRowsInTable(jdbcTemplate, "item");
        final int beforeItemWithDiffCodeCount = countRowsInTableWhere(jdbcTemplate, "item", "difficulty_code = 'D'");
        final int beforeItemCommonCoreCount = countRowsInTable(jdbcTemplate, "item_common_core_standard");
        final int beforeItemOtherTarget = countRowsInTable(jdbcTemplate, "item_other_target");
        final int beforeAsmScoreCount = countRowsInTable(jdbcTemplate, "asmt_score");

        asmtBuilder.item(itemBuilder.build());
        asmtBuilder.item(itemBuilder.naturalId("20-19999").build());
        asmtBuilder.item(itemBuilder.naturalId("20-18888").active(false)
                .answerKey("answerKey")
                .fieldTest(true)
                .optionsCount(0)
                .type("type").build());

        Map<String, Assessment> asmts = newHashMap();
        final Assessment assessment = asmtBuilder.build();
        asmts.put(assessment.getNaturalId(), assessment);

        repository.createPackage(asmts.values(), -99);

        assertThat(countRowsInTable(jdbcTemplate, "asmt")).isEqualTo(beforeAsmtCount + 1);
        assertThat(countRowsInTable(jdbcTemplate, "asmt_score")).isEqualTo(beforeAsmScoreCount + 1);
        assertThat(countRowsInTable(jdbcTemplate, "item")).isEqualTo(beforeItemCount + 3);
        assertThat(countRowsInTableWhere(jdbcTemplate, "item", "difficulty_code = 'D'")).isEqualTo(beforeItemWithDiffCodeCount + 3);
        assertThat(countRowsInTableWhere(jdbcTemplate, "item", "natural_id = '20-19999' and field_test is null -- and active is null and type is null and options_count is null and answer_key is null")).isEqualTo(1);
        assertThat(countRowsInTableWhere(jdbcTemplate, "item", "natural_id = '20-18888' and field_test = 1 and active = 0 and type = 'type' and options_count= 0 and answer_key = 'answerKey'")).isEqualTo(1);
        assertThat(countRowsInTable(jdbcTemplate, "item_common_core_standard")).isEqualTo(beforeItemCommonCoreCount + 6);
        assertThat(countRowsInTable(jdbcTemplate, "item_other_target")).isEqualTo(beforeItemOtherTarget + 3);
    }

}
