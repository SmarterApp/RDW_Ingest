package org.opentestsystem.rdw.ingest.processor.model;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.junit.Before;
import org.junit.Test;

import static org.assertj.core.api.Assertions.assertThat;
import static org.opentestsystem.rdw.ingest.processor.model.SubjectValidationContext.MaxMessageCount;

public class SubjectValidationContextTest {

    private SubjectValidationContext context;

    @Before
    public void setup() {
        context = new SubjectValidationContext();
    }

    @Test
    public void itShouldPushAndPopLocationsAndBindMessagesToTheCurrentLocation() {
        context.push("Parent_A");
        context.failure("Message A");

        context.push("Child_A");
        context.failure("Message A_A");
        context.pop();

        context.push("Child_B");
        context.failure("Message A_B");
        context.pop();

        context.pop();
        context.push("Parent_B");
        context.failure("Message B");
        context.pop();

        assertThat(context.getFailures())
                .usingRecursiveFieldByFieldElementComparator()
                .containsOnly(
                        new SubjectValidationFailure("Parent_A", "Message A"),
                        new SubjectValidationFailure("Parent_A:Child_A", "Message A_A"),
                        new SubjectValidationFailure("Parent_A:Child_B", "Message A_B"),
                        new SubjectValidationFailure("Parent_B", "Message B")
                );
    }

    @Test
    public void itShouldBeValidIfThereAreNoErrors() {
        assertThat(context.isValid()).isTrue();
        context.failure("Failure message");
        assertThat(context.isValid()).isFalse();
    }

    @Test
    public void itShouldProvideMessagesAsJson() throws Exception {
        context.push("parent", "code");
        context.failure("failure 1");
        context.push("child");
        context.failure("failure 2");

        final String json = context.toJson();
        final ArrayNode root = (ArrayNode) new ObjectMapper().readTree(json);
        assertThat(root).hasSize(2);

        final ObjectNode parentMessage = (ObjectNode) root.get(0);
        assertThat(parentMessage.get("location").asText()).isEqualTo("parent(code)");
        assertThat(parentMessage.get("message").asText()).isEqualTo("failure 1");

        final ObjectNode childMessage = (ObjectNode) root.get(1);
        assertThat(childMessage.get("location").asText()).isEqualTo("parent(code):child");
        assertThat(childMessage.get("message").asText()).isEqualTo("failure 2");
    }

    @Test
    public void itShouldLimitTheJsonMessageCount() throws Exception {
        context.push("location");
        for (int i = 0; i < MaxMessageCount * 2; i++) {
            context.failure("Failure " + i);
        }

        final ArrayNode root = (ArrayNode) new ObjectMapper().readTree(context.toJson());
        assertThat(root).hasSize(MaxMessageCount + 1);
    }
}