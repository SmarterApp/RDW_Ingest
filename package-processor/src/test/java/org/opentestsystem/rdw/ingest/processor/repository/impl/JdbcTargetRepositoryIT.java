package org.opentestsystem.rdw.ingest.processor.repository.impl;

import org.junit.Test;
import org.junit.runner.RunWith;
import org.opentestsystem.rdw.ingest.common.test.CachingTest;
import org.opentestsystem.rdw.ingest.processor.configuration.DataSourceConfiguration;
import org.opentestsystem.rdw.ingest.processor.model.WarehouseTarget;
import org.opentestsystem.rdw.ingest.processor.repository.TargetRepository;
import org.opentestsystem.rdw.utils.YamlPropertiesConfigurator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.cache.Cache;
import org.springframework.cache.CacheManager;
import org.springframework.cache.interceptor.SimpleKey;
import org.springframework.test.context.ActiveProfiles;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.transaction.annotation.Transactional;

import java.util.Collection;

import static com.google.common.collect.Iterables.getOnlyElement;
import static org.assertj.core.api.Assertions.assertThat;

@RunWith(SpringRunner.class)
@SpringBootTest(classes = {
        JdbcTargetRepository.class,
        DataSourceConfiguration.class,
        YamlPropertiesConfigurator.class
})
@Transactional
@CachingTest
@ActiveProfiles("test")
@Sql(statements = {
        "INSERT INTO subject (id, code) VALUES (-12, 'name1');",
        "INSERT INTO subject (id, code) VALUES (-13, 'name2');",
        "INSERT INTO subject (id, code) VALUES (-14, 'name3');",
        "INSERT INTO claim (id, subject_id, code, name, description) VALUES (-122, -12, 'ccode1', 'name1', 'description');",
        "INSERT INTO claim (id, subject_id, code, name, description) VALUES (-133, -13, 'ccode2', 'name2', 'description');",
        "INSERT INTO claim (id, subject_id, code, name, description) VALUES (-144, -14, 'ccode44','name3', 'description');",
        "INSERT INTO target (id, claim_id, natural_id, code, description) VALUES (-2222, -122, 'id-code22', 'code22', 'description');",
        "INSERT INTO target (id, claim_id, natural_id, code, description) VALUES (-2223, -133, 'id-code23', 'code23', 'description');",
        "INSERT INTO target (id, claim_id, natural_id, code, description) VALUES (-2224, -144, 'id-code24', 'code24', 'description');"
})
public class JdbcTargetRepositoryIT {

    @Autowired
    private TargetRepository repository;

    @Autowired
    private CacheManager cacheManager;

    @Test
    public void itShouldReturnId() {
        assertThat(repository.findIdByNaturalIdAndClaimId("id-code22", -122)).isEqualTo(-2222);
        assertThat(repository.findIdByNaturalIdAndClaimId("id-code23", -133)).isEqualTo(-2223);
    }

    @Test
    public void itShouldThrowExceptionWhenCodeIsUnknown() {
        assertThat(repository.findIdByNaturalIdAndClaimId("code66", -1)).isEqualTo(null);
    }

    @Test
    public void itShouldCacheReturnedId() {
        final Cache ids = this.cacheManager.getCache("target");
        assertThat(ids.get(new SimpleKey("id-code24", -144))).isNull();

        assertThat(repository.findIdByNaturalIdAndClaimId("id-code24", -144)).isEqualTo(-2224);

        assertThat(ids.get(new SimpleKey("id-code24", -144), Integer.class)).isEqualTo(-2224);
    }

    @Test
    public void itShouldFindTargetsBySubject() {
        final Collection<WarehouseTarget> targets = repository.findBySubject("name1");
        assertThat(targets).hasSize(1);
        final WarehouseTarget target = getOnlyElement(targets);
        assertThat(target.getId()).isEqualTo(-2222);
        assertThat(target.getClaimCode()).isEqualTo("ccode1");
        assertThat(target.getNaturalId()).isEqualTo("id-code22");
    }

    @Test
    public void itShouldCreateATarget() {
        repository.create("name1", "ccode1", "id-code23");
        final Collection<WarehouseTarget> targets = repository.findBySubject("name1");
        assertThat(targets).hasSize(2);
        assertThat(targets.stream().map(WarehouseTarget::getNaturalId))
                .containsOnly("id-code22", "id-code23");
    }

    @Test
    public void itShouldDeleteATarget() {
        repository.delete(-2222);
        assertThat(repository.findBySubject("name1")).isEmpty();
    }

    @Test
    @Sql("/PreloadAsmt.sql")
    public void itShouldDetectThatATargetIsReferenced() {
        assertThat(repository.hasItems(-2222)).isFalse();
        //Referenced by item
        assertThat(repository.hasItems(1)).isTrue();
        //Referenced by item_other_target
        assertThat(repository.hasItems(6)).isTrue();
    }
}