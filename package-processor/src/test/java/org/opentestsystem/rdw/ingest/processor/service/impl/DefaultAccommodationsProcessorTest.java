package org.opentestsystem.rdw.ingest.processor.service.impl;

import org.junit.Before;
import org.junit.Test;
import org.mockito.ArgumentCaptor;
import org.opentestsystem.rdw.ingest.common.model.ImportException;
import org.opentestsystem.rdw.ingest.processor.model.Accommodation;
import org.opentestsystem.rdw.ingest.processor.repository.AccommodationTranslationRepository;
import org.opentestsystem.rdw.ingest.processor.service.AccommodationsProcessor;

import java.io.IOException;
import java.util.List;
import java.util.stream.Collectors;

import static com.google.common.io.ByteStreams.toByteArray;
import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Fail.fail;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;

public class DefaultAccommodationsProcessorTest {

    private AccommodationsProcessor processor;
    private AccommodationTranslationRepository translationRepository;

    @Before
    public void createProcessor() {
        translationRepository = mock(AccommodationTranslationRepository.class);
        processor = new DefaultAccommodationsProcessor(translationRepository);
    }

    @Test
    public void itShouldProcessAccommodations() throws IOException {
        assertThat(processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.xml")), 1L))
                .isEqualTo("11 accommodations processed");
        final ArgumentCaptor<List<Accommodation>> captor = ArgumentCaptor.forClass(List.class);
        verify(translationRepository).upsert(captor.capture());
        final List<Accommodation> accommodations = captor.getValue();
        assertThat(accommodations).hasSize(11);
        assertThat(accommodations.stream().map(Accommodation::code).collect(Collectors.toSet())).containsOnly(
                "TDS_ASL0", "TDS_ASL1", "NEA0", "NEA_AR", "NEA_RA_Stimuli", "NEA_SC_WritItems",
                "NEA_STT", "NEA_Abacus", "NEA_Calc", "NEA_MT", "NEA_NumTbl"
        );
    }

    @Test(expected = ImportException.class)
    public void itShouldFailToProcessPayloadWithInvalidSchema() throws IOException {
        processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.schema.xml")), 1L);
    }

    @Test(expected = ImportException.class)
    public void itShouldFailToProcessPayloadWithInvalidSchemaMissingSchoolYear() throws IOException {
        processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.schoolyear.xml")), 1L);
    }

    @Test(expected = ImportException.class)
    public void itShouldFailToProcessPayloadWithBadXml() throws IOException {
        processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.badxml.xml")), 1L);
    }

    @Test
    public void itShouldFailToProcessPayloadWithBadData() throws IOException {
        try {
            processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.baddata.xml")), 1L);
            fail("it should have thrown exception for bad data");
        } catch (final ImportException e) {
            assertThat(e.getMessage()).isEqualTo("{\"messages\":[" +
                    "{\"elementName\":\"Translation\",\"value\":\"\",\"error\":\"value may not be blank\"}," +
                    "{\"elementName\":\"Accommodation code\",\"value\":\"NEA_RA_Stimuli_very_very_long_code\",\"error\":\"string is too long, max length is 25\"}," +
                    "{\"elementName\":\"Translation\",\"value\":\"Read Aloud CAT Reading Passages, with a value longer than the maximum allowed of 60\",\"error\":\"string is too long, max length is 60\"}" +
                    "]}");
        }
    }

    @Test
    public void itShouldProcess2019File() throws IOException {
        final String message = processor.process(toByteArray(this.getClass().getResourceAsStream("/AccessibilityConfig.2019.xml")), 1L);
        assertThat(message).contains("accommodations processed");
    }
}
