sql:
  migrate:
    entities:
        # ------------ grade  -------------------------------------------------------------------
        grade:
          sql:
            update:  >-
                UPDATE reporting.grade rg
                  JOIN staging.staging_grade sg ON sg.id = rg.id
                SET
                  rg.name = sg.name,
                  rg.code = sg.code;
            insert: >-
                INSERT INTO reporting.grade ( id, code, name)
                  SELECT
                    sg.id,
                    sg.code,
                    sg.name
                  FROM staging.staging_grade sg
                    LEFT JOIN reporting.grade rg ON rg.id = sg.id
                  WHERE rg.id IS NULL;
            delete: >-
                DELETE rg FROM reporting.grade rg
                  WHERE NOT EXISTS(SELECT id FROM staging.staging_grade WHERE id = rg.id);

        # ------------ completeness  -------------------------------------------------------------------
        completeness:
          sql:
            update:  >-
                UPDATE reporting.completeness rc
                   JOIN staging.staging_completeness sc ON sc.id = rc.id
                SET
                 rc.name = sc.name;

            insert:  >-
                INSERT INTO reporting.completeness ( id, name)
                  SELECT
                    sc.id,
                    sc.name
                  FROM staging.staging_completeness sc
                  LEFT JOIN reporting.completeness rc ON rc.id = sc.id
                  WHERE rc.id IS NULL;

            delete: >-
               DELETE rc FROM reporting.completeness rc
                WHERE NOT EXISTS(SELECT id FROM staging.staging_completeness WHERE id = rc.id);

        # ------------ Administration Condition ---------------------------------------------------------
        administration_condition:
          sql:
            update:  >-
              UPDATE reporting.administration_condition rac
                JOIN staging.staging_administration_condition sac ON sac.id = rac.id
              SET
                rac.name = sac.name;

            insert:  >-
              INSERT INTO reporting.administration_condition ( id, name)
                SELECT
                  sac.id,
                  sac.name
                FROM staging.staging_administration_condition sac
                  LEFT JOIN reporting.administration_condition rac ON rac.id = sac.id
                WHERE rac.id IS NULL;

            delete: >-
              DELETE rac FROM reporting.administration_condition rac
                WHERE NOT EXISTS(SELECT id FROM staging.staging_administration_condition WHERE id = rac.id);

       # ------------ Ethnicity ------------------------------------------------------------------------
        ethnicity:
          sql:
            update:  >-
              UPDATE reporting.ethnicity re
                JOIN staging.staging_ethnicity se ON se.id = re.id
              SET
                re.name = se.name;

            insert:  >-
              INSERT INTO reporting.ethnicity ( id, name)
                SELECT
                  se.id,
                  se.name
                FROM staging.staging_ethnicity se
                  LEFT JOIN reporting.ethnicity re ON re.id = se.id
                WHERE re.id IS NULL;
            delete: >-
                DELETE re FROM reporting.ethnicity re
                  WHERE NOT EXISTS(SELECT id FROM staging.staging_ethnicity WHERE id = re.id);

      # ------------ Gender ------------------------------------------------------------------------
        gender:
          sql:
            update:  >-
              UPDATE reporting.gender rg
                JOIN staging.staging_gender sg ON sg.id = rg.id
              SET
                rg.name = sg.name;

            insert:  >-
              INSERT INTO reporting.gender ( id, name)
                SELECT
                  sg.id,
                  sg.name
                FROM staging.staging_gender sg
                  LEFT JOIN reporting.gender rg ON rg.id = sg.id
                WHERE rg.id IS NULL;

            delete: >-
               DELETE rg FROM reporting.gender rg
                WHERE NOT EXISTS(SELECT id FROM staging.staging_gender WHERE id = rg.id);

      # ------------ Accommodation ------------------------------------------------------------------------
        accommodation:
          sql:
            update:  >-
              UPDATE reporting.accommodation ra
                JOIN staging.staging_accommodation sa ON sa.id = ra.id
              SET
                ra.code = sa.code;

            insert:  >-
              INSERT INTO reporting.accommodation ( id, code)
                SELECT
                  sa.id,
                  sa.code
                FROM staging.staging_accommodation sa
                  LEFT JOIN reporting.accommodation ra ON ra.id = sa.id
                WHERE ra.id IS NULL;

            delete: >-
               DELETE ra FROM reporting.accommodation ra
                WHERE NOT EXISTS(SELECT id FROM staging.staging_accommodation WHERE id = ra.id);

      # ------------ Claim ------------------------------------------------------------------------
        claim:
          sql:
            update:  >-
              UPDATE reporting.claim rc
                JOIN staging.staging_claim sc ON sc.id = rc.id
              SET
                rc.code = sc.code,
                rc.subject_id = sc.subject_id,
                rc.name = sc.name,
              rc.description = sc.description;

            insert:  >-
              INSERT INTO reporting.claim ( id, subject_id, code, name, description)
                SELECT
                  sc.id,
                  sc.subject_id,
                  sc.code,
                  sc.name,
                  sc.description
                FROM staging.staging_claim sc
                  LEFT JOIN reporting.claim rc ON rc.id = sc.id
                WHERE rc.id IS NULL;

            delete: >-
                DELETE rc FROM reporting.claim rc
                  WHERE NOT EXISTS(SELECT id FROM staging.staging_claim WHERE id = rc.id);

      #  ------------ Subject Claim Score --------------------------------------------------------------------
        subject_claim_score:
          sql:
            update:  >-
              UPDATE reporting.subject_claim_score rc
                JOIN staging.staging_subject_claim_score sc ON sc.id = rc.id
              SET
                rc.subject_id = sc.subject_id,
                rc.asmt_type_id = sc.asmt_type_id,
                rc.code = sc.code,
                rc.name = sc.name;

            insert:  >-
              INSERT INTO reporting.subject_claim_score ( id, subject_id, asmt_type_id, code, name)
                SELECT
                  sc.id,
                  sc.subject_id,
                  sc.asmt_type_id,
                  sc.code,
                  sc.name
                FROM staging.staging_subject_claim_score sc
                  LEFT JOIN reporting.subject_claim_score rc ON rc.id = sc.id
                WHERE rc.id IS NULL;

            delete: >-
              DELETE rc FROM reporting.subject_claim_score rc
                WHERE NOT EXISTS(SELECT id FROM staging.staging_subject_claim_score WHERE id = rc.id);

      # ------------ Target ---------------------------------------------------------------------------
        target:
          sql:
            update:  >-
              UPDATE reporting.target rt
                JOIN staging.staging_target st ON st.id = rt.id
              SET
                rt.claim_id = st.claim_id,
                rt.code = st.code,
                rt.description = st.description;

            insert:  >-
              INSERT INTO reporting.target ( id, claim_id, code, description)
                SELECT
                  st.id,
                  st.claim_id,
                  st.code,
                  st.description
                FROM staging.staging_target st
                  LEFT JOIN reporting.target rt ON rt.id = st.id
                WHERE rt.id IS NULL;

            delete:
              DELETE rt FROM reporting.target rt
                WHERE NOT EXISTS(SELECT id FROM staging.staging_target WHERE id = rt.id);

      # ------------ Depth of knowledge ---------------------------------------------------------------------------
        depth_of_knowledge:
          sql:
            update:  >-
              UPDATE reporting.depth_of_knowledge rdok
                JOIN staging.staging_depth_of_knowledge sdok ON sdok.id = rdok.id
              SET
                rdok.level = sdok.level,
                rdok.subject_id = sdok.subject_id,
                rdok.reference = sdok.reference,
                rdok.description = sdok.description;

            insert:  >-
              INSERT INTO reporting.depth_of_knowledge ( id, level, subject_id, description, reference)
                SELECT
                  sdok.id,
                  sdok.level,
                  sdok.subject_id,
                  sdok.description,
                  sdok.reference
                FROM staging.staging_depth_of_knowledge sdok
                  LEFT JOIN reporting.depth_of_knowledge rdok ON rdok.id = sdok.id
                WHERE rdok.id IS NULL;

            delete: >-
               DELETE rdok FROM reporting.depth_of_knowledge rdok
                WHERE NOT EXISTS(SELECT id FROM staging.staging_depth_of_knowledge WHERE id = rdok.id);

      # ------------ Math Practice ---------------------------------------------------------------------------
        math_practice:
          sql:
            update:  >-
              UPDATE reporting.math_practice rmp
                JOIN staging.staging_math_practice smp ON smp.practice = rmp.practice
              SET
                rmp.description = smp.description;

            insert:  >-
              INSERT INTO reporting.math_practice ( practice, description)
                SELECT
                  smp.practice,
                  smp.description
                FROM staging.staging_math_practice smp
                  LEFT JOIN reporting.math_practice rmp ON rmp.practice = smp.practice
                WHERE rmp.practice IS NULL;

            delete: >-
              DELETE rmp FROM reporting.math_practice rmp
                  WHERE NOT EXISTS(SELECT practice FROM staging.staging_math_practice WHERE practice = rmp.practice);

      # ------------ Item Trait Score ---------------------------------------------------------------------------
        item_trait_score:
          sql:
            update:  >-
              UPDATE reporting.item_trait_score rit
                JOIN staging.staging_item_trait_score sit ON sit.id = rit.id
              SET
                rit.dimension = sit.dimension;

            insert:  >-
              INSERT INTO reporting.item_trait_score ( id, dimension)
                SELECT
                  sit.id,
                  sit.dimension
                FROM staging.staging_item_trait_score sit
                  LEFT JOIN reporting.item_trait_score rit ON rit.id = sit.id
                WHERE rit.id IS NULL;

            delete: >-
               DELETE rit FROM reporting.item_trait_score rit
                  WHERE NOT EXISTS(SELECT id FROM staging.staging_item_trait_score WHERE id = rit.id);

      # ------------ Item Difficulty Cuts ---------------------------------------------------------------------------
        item_difficulty_cuts:
          sql:
            update:  >-
              UPDATE reporting.item_difficulty_cuts ridc
                JOIN staging.staging_item_difficulty_cuts sidc ON sidc.id = ridc.id
              SET
                ridc.asmt_type_id = sidc.asmt_type_id,
                ridc.subject_id = sidc.subject_id,
                ridc.grade_id = sidc.grade_id,
                ridc.moderate_low_end = sidc.moderate_low_end,
                ridc.difficult_low_end = sidc.difficult_low_end;

            insert:  >-
              INSERT INTO reporting.item_difficulty_cuts (id, asmt_type_id, subject_id, grade_id, moderate_low_end, difficult_low_end)
                SELECT
                  sidc.id,
                  sidc.asmt_type_id,
                  sidc.subject_id,
                  sidc.grade_id,
                  sidc.moderate_low_end,
                  sidc.difficult_low_end
                FROM staging.staging_item_difficulty_cuts sidc
                  LEFT JOIN reporting.item_difficulty_cuts ridc ON ridc.id = sidc.id
                WHERE ridc.id IS NULL;

            delete: >-
                DELETE ridc FROM reporting.item_difficulty_cuts ridc
                    WHERE NOT EXISTS(SELECT id FROM staging.staging_item_difficulty_cuts WHERE id = ridc.id);

      # ------------ Language ------------------------------------------------------------------------
              language:
                sql:
                  update:  >-
                    UPDATE reporting.accommodation ra
                      JOIN staging.staging_accommodation sa ON sa.id = ra.id
                    SET
                      ra.code = sa.code;

                  insert:  >-
                    INSERT INTO reporting.language ( id, code)
                      SELECT
                        sl.id,
                        sl.code
                      FROM staging.staging_language sl
                        LEFT JOIN reporting.language rl ON rl.id = sl.id
                      WHERE rl.id IS NULL;

                  delete: >-
                    DELETE rl FROM reporting.language rl
                      WHERE NOT EXISTS(SELECT id FROM staging.staging_language WHERE id = rl.id);

      # ------------ Accommodation Translation ------------------------------------------------------------------------
              accommodation_translation:
                sql:
                  update:  >-
                    UPDATE reporting.accommodation_translation rat
                      JOIN staging.staging_accommodation_translation sat
                        ON sat.accommodation_id = rat.accommodation_id AND
                          sat.language_id = rat.language_id
                    SET
                      rat.label = sat.label;

                  insert:  >-
                    INSERT INTO reporting.accommodation_translation (accommodation_id, language_id, label)
                      SELECT
                        sat.accommodation_id,
                        sat.language_id,
                        sat.label
                      FROM staging.staging_accommodation_translation sat
                        LEFT JOIN reporting.accommodation_translation rat
                          ON rat.accommodation_id = sat.accommodation_id AND
                            rat.language_id = sat.language_id
                      WHERE ra.id IS NULL;

                  delete: >-
                     DELETE rat FROM reporting.accommodation_translation rat
                        WHERE NOT EXISTS(SELECT accommodation_id, language_id FROM staging.staging_accommodation
                          WHERE accommodation_id = rat.accommodation_id AND
                            language_id = rat.language_id);

      # ############## IAB Exams #######################################################################
      # ------------ iab_exam_available_accommodation --------------------------------------------------
        iab_exam_available_accommodation:
          sql:
            insert: >-
              INSERT INTO reporting.iab_exam_available_accommodation ( iab_exam_id, accommodation_id)
                SELECT
                  s.iab_exam_id,
                  s.accommodation_id
                FROM staging.staging_iab_exam_available_accommodation s
                  LEFT JOIN reporting.iab_exam_available_accommodation r
                    ON (r.iab_exam_id = s.iab_exam_id AND r.accommodation_id = s.accommodation_id)
                WHERE r.iab_exam_id IS NULL;

            deleteAsPartOfParentUpdate: >-
                DELETE r FROM reporting.iab_exam_available_accommodation r
                   WHERE iab_exam_id in (select id from staging.staging_iab_exam where deleted = 0)
                      AND NOT EXISTS(SELECT iab_exam_id FROM staging.staging_iab_exam_available_accommodation
                                        WHERE iab_exam_id = r.iab_exam_id AND accommodation_id = r.accommodation_id);

            delete: >-
              DELETE FROM reporting.iab_exam_available_accommodation
                WHERE iab_exam_id IN
                      (SELECT id from staging.staging_iab_exam WHERE deleted = 1 );

        # ------------ iab_exam_item -------------------------------------------------------------------
        iab_exam_item:
          sql:
            insert:
              INSERT INTO reporting.iab_exam_item (id, iab_exam_id, item_id, score, score_status, position, response,
                                                   trait_evidence_elaboration_score, trait_evidence_elaboration_score_status,
                                                   trait_organization_purpose_score, trait_organization_purpose_score_status,
                                                   trait_conventions_score, trait_conventions_score_status)
                SELECT
                  si.id,
                  si.iab_exam_id,
                  si.item_id,
                  si.score,
                  si.score_status,
                  si.position,
                  si.response,
                  si.trait_evidence_elaboration_score,
                  si.trait_evidence_elaboration_score_status,
                  si.trait_organization_purpose_score,
                  si.trait_organization_purpose_score_status,
                  si.trait_conventions_score,
                  si.trait_conventions_score_status
                FROM staging.staging_iab_exam_item si
                  LEFT JOIN reporting.iab_exam_item ri ON ri.id = si.id
                WHERE ri.id IS NULL;

            update:
              UPDATE reporting.iab_exam_item ri
                JOIN staging.staging_iab_exam_item si ON ri.id = si.id
              SET
                ri.iab_exam_id                             = si.iab_exam_id,
                ri.item_id                                 = si.item_id,
                ri.score                                   = si.score,
                ri.score_status                            = si.score_status,
                ri.position                                = si.position,
                ri.response                                = si.response,
                ri.trait_evidence_elaboration_score        = si.trait_evidence_elaboration_score,
                ri.trait_evidence_elaboration_score_status = si.trait_evidence_elaboration_score_status,
                ri.trait_organization_purpose_score        = si.trait_organization_purpose_score,
                ri.trait_organization_purpose_score_status = si.trait_organization_purpose_score_status,
                ri.trait_conventions_score                 = si.trait_conventions_score,
                ri.trait_conventions_score_status          = si.trait_conventions_score_status,
                ri.trait_evidence_elaboration_score_status = si.trait_evidence_elaboration_score_status;

            deleteAsPartOfParentUpdate: >-
              DELETE ri FROM reporting.iab_exam_item ri
                WHERE ri.iab_exam_id in (select id from staging.staging_iab_exam where deleted = 0)
                      AND  NOT EXISTS(SELECT id FROM staging.staging_iab_exam_item WHERE id = ri.id);

            delete: >-
              DELETE FROM reporting.iab_exam_item
                WHERE iab_exam_id IN (SELECT id from staging.staging_iab_exam WHERE deleted = 1 );

        # ------------ iab_exam -------------------------------------------------------------------
        iab_exam:
          sql:
            insert: >-
              INSERT INTO reporting.iab_exam (id, grade_id, student_id, school_id, iep, lep, section504, economic_disadvantage,
                                              migrant_status, eng_prof_lvl, t3_program_type, language_code, prim_disability_type,
                                              school_year, asmt_id, asmt_version, opportunity, completeness_id,
                                              administration_condition_id, session_id, category, scale_score, scale_score_std_err,
                                              import_id)
                SELECT
                  sie.id,
                  sies.grade_id,
                  sies.student_id,
                  sies.school_id,
                  sies.iep,
                  sies.lep,
                  sies.section504,
                  sies.economic_disadvantage,
                  sies.migrant_status,
                  sies.eng_prof_lvl,
                  sies.t3_program_type,
                  sies.language_code,
                  sies.prim_disability_type,
                  sie.school_year,
                  sie.asmt_id,
                  sie.asmt_version,
                  sie.opportunity,
                  sie.completeness_id,
                  sie.administration_condition_id,
                  sie.session_id,
                  sie.category,
                  sie.scale_score,
                  sie.scale_score_std_err,
                  sie.import_id
                FROM staging.staging_iab_exam sie JOIN staging.staging_iab_exam_student sies ON sie.iab_exam_student_id = sies.id
                  LEFT JOIN reporting.iab_exam rie ON rie.id = sie.id
                WHERE rie.id IS NULL AND sie.deleted = 0;

            update: >-
              UPDATE reporting.iab_exam rie
                JOIN staging.staging_iab_exam sie ON sie.id = rie.id
                JOIN staging.staging_iab_exam_student sies ON sie.iab_exam_student_id = sies.id
              SET
                rie.grade_id = sies.grade_id,
                rie.student_id = sies.student_id,
                rie.school_id = sies.school_id,
                rie.iep = sies.iep,
                rie.lep = sies.lep,
                rie.section504 = sies.section504,
                rie.economic_disadvantage = sies.economic_disadvantage,
                rie.migrant_status = sies.migrant_status,
                rie.eng_prof_lvl = sies.eng_prof_lvl,
                rie.t3_program_type = sies.t3_program_type,
                rie.language_code = sies.language_code,
                rie.prim_disability_type = sies.prim_disability_type,
                rie.school_year = sie.school_year,
                rie.asmt_id = sie.asmt_id,
                rie.asmt_version = sie.asmt_version,
                rie.opportunity = sie.opportunity,
                rie.completeness_id = sie.completeness_id,
                rie.administration_condition_id = sie.administration_condition_id,
                rie.session_id = sie.session_id,
                rie.category = sie.category,
                rie.scale_score = sie.scale_score,
                rie.scale_score_std_err = sie.scale_score_std_err,
                rie.completed_at = sie.completed_at,
                rie.import_id = sie.import_id
              WHERE sie.deleted = 0;

            delete: >-
              DELETE FROM reporting.iab_exam
                WHERE id IN (SELECT id from staging.staging_iab_exam WHERE deleted = 1 );

        # ############## ICA and Summative Exams ####################################################################
        # ------------ exam_available_accommodation -------------------------------------------------------------------
        exam_available_accommodation:
          sql:
            insert: >-
              INSERT INTO reporting.exam_available_accommodation ( exam_id, accommodation_id)
                SELECT
                  s.exam_id,
                  s.accommodation_id
                FROM staging.staging_exam_available_accommodation s
                  LEFT JOIN reporting.exam_available_accommodation r
                    ON (r.exam_id = s.exam_id AND r.accommodation_id = s.accommodation_id)
                WHERE r.exam_id IS NULL;

            deleteAsPartOfParentUpdate: >-
              DELETE r FROM reporting.exam_available_accommodation r
                WHERE exam_id in (select id from staging.staging_exam where deleted = 0)
                    AND NOT EXISTS(SELECT exam_id FROM staging.staging_exam_available_accommodation
                          WHERE exam_id = r.exam_id AND accommodation_id = r.accommodation_id);

            delete: >-
              DELETE FROM reporting.exam_available_accommodation
                WHERE exam_id IN (SELECT id from staging.staging_exam WHERE deleted = 1 );

        # ------------ exam_item -------------------------------------------------------------------
        exam_item:
          sql:
            insert: >-
              INSERT INTO reporting.exam_item (id, exam_id, item_id, score, score_status, position, response,
                                               trait_evidence_elaboration_score, trait_evidence_elaboration_score_status,
                                               trait_organization_purpose_score, trait_organization_purpose_score_status,
                                               trait_conventions_score, trait_conventions_score_status)
                SELECT
                  si.id,
                  si.exam_id,
                  si.item_id,
                  si.score,
                  si.score_status,
                  si.position,
                  si.response,
                  si.trait_evidence_elaboration_score,
                  si.trait_evidence_elaboration_score_status,
                  si.trait_organization_purpose_score,
                  si.trait_organization_purpose_score_status,
                  si.trait_conventions_score,
                  si.trait_conventions_score_status
                FROM staging.staging_exam_item si
                  LEFT JOIN reporting.exam_item ri ON ri.id = si.id
                WHERE ri.id IS NULL;

            update: >-
              UPDATE reporting.exam_item ri
                JOIN staging.staging_exam_item si ON ri.id = si.id
              SET
                ri.exam_id                             = si.exam_id,
                ri.item_id                                 = si.item_id,
                ri.score                                   = si.score,
                ri.score_status                            = si.score_status,
                ri.position                                = si.position,
                ri.response                                = si.response,
                ri.trait_evidence_elaboration_score        = si.trait_evidence_elaboration_score,
                ri.trait_evidence_elaboration_score_status = si.trait_evidence_elaboration_score_status,
                ri.trait_organization_purpose_score        = si.trait_organization_purpose_score,
                ri.trait_organization_purpose_score_status = si.trait_organization_purpose_score_status,
                ri.trait_conventions_score                 = si.trait_conventions_score,
                ri.trait_conventions_score_status          = si.trait_conventions_score_status,
                ri.trait_evidence_elaboration_score_status = si.trait_evidence_elaboration_score_status;

            deleteAsPartOfParentUpdate: >-
              DELETE ri FROM reporting.exam_item ri
                  WHERE ri.exam_id in (select id from staging.staging_exam where deleted = 0)
                    AND  NOT EXISTS(SELECT id FROM staging.staging_exam_item WHERE id = ri.id);

            delete: >-
              DELETE FROM reporting.exam_item
                WHERE exam_id IN (SELECT id from staging.staging_exam WHERE deleted = 1 );

        # ------------ exam -------------------------------------------------------------------
        exam:
          sql:
            insert: >-
              INSERT INTO reporting.exam (id, grade_id, student_id, school_id, iep, lep, section504, economic_disadvantage,
                                          migrant_status, eng_prof_lvl, t3_program_type, language_code, prim_disability_type,
                                          school_year, asmt_id, asmt_version, opportunity, completeness_id,
                                          administration_condition_id, session_id, achievement_level, scale_score, scale_score_std_err,
                                          import_id,
                                          claim1_scale_score, claim1_scale_score_std_err, claim1_category,
                                          claim2_scale_score, claim2_scale_score_std_err, claim2_category,
                                          claim3_scale_score, claim3_scale_score_std_err, claim3_category,
                                          claim4_scale_score, claim4_scale_score_std_err, claim4_category)
                SELECT
                  se.id,
                  ses.grade_id,
                  ses.student_id,
                  ses.school_id,
                  ses.iep,
                  ses.lep,
                  ses.section504,
                  ses.economic_disadvantage,
                  ses.migrant_status,
                  ses.eng_prof_lvl,
                  ses.t3_program_type,
                  ses.language_code,
                  ses.prim_disability_type,
                  se.school_year,
                  se.asmt_id,
                  se.asmt_version,
                  se.opportunity,
                  se.completeness_id,
                  se.administration_condition_id,
                  se.session_id,
                  se.achievement_level,
                  se.scale_score,
                  se.scale_score_std_err,
                  se.import_id,
                  claim1.scale_score as claim1_scale_score,
                  claim1.scale_score_std_err as claim1_scale_score_std_err,
                  claim1.category as claim1_category,
                  claim2.scale_score as claim2_scale_score,
                  claim2.scale_score_std_err as claim2_scale_score_std_err,
                  claim2.category as claim2_category,
                  claim3.scale_score as claim3_scale_score,
                  claim3.scale_score_std_err as claim3_scale_score_std_err,
                  claim3.category as claim3_category,
                  claim4.scale_score as claim4_scale_score,
                  claim4.scale_score_std_err as claim4_scale_score_std_err,
                  claim4.category as claim4_category
                FROM staging.staging_exam se
                  JOIN staging.staging_exam_student ses ON se.exam_student_id = ses.id
                  LEFT JOIN (
                               SELECT exam_id
                                 ,scale_score
                                 ,scale_score_std_err
                                 ,category
                               FROM staging.staging_exam_claim_score s
                                 INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                    AND m.num = 1
                             ) AS claim1 ON claim1.exam_id = se.id
                  LEFT JOIN (
                               SELECT exam_id
                                 ,scale_score
                                 ,scale_score_std_err
                                 ,category
                               FROM staging.staging_exam_claim_score s
                                 INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                    AND m.num = 2
                             ) AS claim2 ON claim2.exam_id = se.id
                  LEFT JOIN (
                               SELECT exam_id
                                 ,scale_score
                                 ,scale_score_std_err
                                 ,category
                               FROM staging.staging_exam_claim_score s
                                 INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                    AND m.num = 3
                             ) AS claim3 ON claim3.exam_id = se.id
                  LEFT JOIN (
                              SELECT exam_id
                                ,scale_score
                                ,scale_score_std_err
                                ,category
                              FROM staging.staging_exam_claim_score s
                                INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                   AND m.num = 4
                            ) AS claim4 ON claim4.exam_id = se.id
                  LEFT JOIN reporting.exam re ON re.id = se.id
                WHERE re.id IS NULL AND se.deleted = 0;

            update: >-
              UPDATE reporting.exam re
                JOIN staging.staging_exam se ON se.id = re.id
                JOIN staging.staging_exam_student ses ON se.exam_student_id = ses.id
                LEFT JOIN (
                             SELECT exam_id
                               ,scale_score
                               ,scale_score_std_err
                               ,category
                             FROM staging.staging_exam_claim_score s
                               INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                  AND m.num = 1
                           ) AS claim1 ON claim1.exam_id = se.id
                LEFT JOIN (
                             SELECT exam_id
                               ,scale_score
                               ,scale_score_std_err
                               ,category
                             FROM staging.staging_exam_claim_score s
                               INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                  AND m.num = 2
                           ) AS claim2 ON claim2.exam_id = se.id
                LEFT JOIN (
                             SELECT exam_id
                               ,scale_score
                               ,scale_score_std_err
                               ,category
                             FROM staging.staging_exam_claim_score s
                               INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                  AND m.num = 3
                           ) AS claim3 ON claim3.exam_id = se.id
                LEFT JOIN (
                            SELECT exam_id
                              ,scale_score
                              ,scale_score_std_err
                              ,category
                            FROM staging.staging_exam_claim_score s
                              INNER JOIN reporting.exam_claim_score_mapping m ON m.subject_claim_score_id = s.subject_claim_score_id
                                                                                 AND m.num = 4
                          ) AS claim4 ON claim4.exam_id = se.id
              SET
                re.grade_id = ses.grade_id,
                re.student_id = ses.student_id,
                re.school_id = ses.school_id,
                re.iep = ses.iep,
                re.lep = ses.lep,
                re.section504 = ses.section504,
                re.economic_disadvantage = ses.economic_disadvantage,
                re.migrant_status = ses.migrant_status,
                re.eng_prof_lvl = ses.eng_prof_lvl,
                re.t3_program_type = ses.t3_program_type,
                re.language_code = ses.language_code,
                re.prim_disability_type = ses.prim_disability_type,
                re.school_year = se.school_year,
                re.asmt_id = se.asmt_id,
                re.asmt_version = se.asmt_version,
                re.opportunity = se.opportunity,
                re.completeness_id = se.completeness_id,
                re.administration_condition_id = se.administration_condition_id,
                re.session_id = se.session_id,
                re.achievement_level = se.achievement_level,
                re.scale_score = se.scale_score,
                re.scale_score_std_err = se.scale_score_std_err,
                re.completed_at = se.completed_at,
                re.import_id = se.import_id,
                re.claim1_scale_score = claim1.scale_score,
                re.claim1_scale_score_std_err = claim1.scale_score_std_err,
                re.claim1_category = claim1.category,
                re.claim2_scale_score  = claim2.scale_score,
                re.claim2_scale_score_std_err = claim2.scale_score_std_err,
                re.claim2_category = claim2.category,
                re.claim3_scale_score = claim3.scale_score,
                re.claim3_scale_score_std_err = claim3.scale_score_std_err,
                re.claim3_category = claim3.category,
                re.claim4_scale_score = claim4.scale_score,
                re.claim4_scale_score_std_err = claim4.scale_score_std_err,
                re.claim4_category = claim4.category
              WHERE se.deleted = 0;

            delete: >-
              DELETE FROM reporting.exam WHERE id IN (SELECT id from staging.staging_exam WHERE deleted = 1 );

      # ############## Student Group #######################################################################
      # ------------ iab_exam_available_accommodation --------------------------------------------------
        student_group_membership:
          sql:
            insert: >-
              INSERT INTO reporting.student_group_membership ( student_group_id, student_id)
                SELECT
                  ssgm.student_group_id,
                  ssgm.student_id
                FROM staging.staging_student_group_membership ssgm
                  LEFT JOIN reporting.student_group_membership rsgm
                    ON (rsgm.student_group_id = ssgm.student_group_id AND rsgm.student_id = ssgm.student_id)
                WHERE rsgm.student_group_id IS NULL;

            deleteAsPartOfParentUpdate: >-
              DELETE rsgm FROM reporting.student_group_membership rsgm
              WHERE student_group_id in (select id from staging.staging_student_group where deleted = 0 and active = 1)
                    AND NOT EXISTS(SELECT student_group_id FROM staging.staging_student_group_membership
              WHERE student_group_id = rsgm.student_group_id AND student_id = rsgm.student_id);

            delete: >-
              DELETE from reporting.student_group_membership
                WHERE student_group_id IN
                  (SELECT id FROM staging.staging_student_group WHERE deleted = 1 or active = 0);

      # ------------ user_student_group --------------------------------------------------
        user_student_group:
          sql:
            insert: >-
              INSERT INTO reporting.user_student_group ( student_group_id, user_login)
                SELECT
                  susg.student_group_id,
                  susg.user_login
                FROM staging.staging_user_student_group susg
                  LEFT JOIN reporting.user_student_group rusg
                    ON (rusg.student_group_id = susg.student_group_id AND rusg.user_login = susg.user_login)
                WHERE rusg.student_group_id IS NULL;

            deleteAsPartOfParentUpdate: >-
              DELETE rsug FROM reporting.user_student_group rsug
                 WHERE student_group_id in (select id from staging.staging_student_group where deleted = 0 and active = 1)
                    AND NOT EXISTS(SELECT student_group_id FROM staging.staging_user_student_group
                                     WHERE student_group_id = rsug.student_group_id AND user_login = rsug.user_login);

            delete: >-
              DELETE from reporting.user_student_group
                WHERE student_group_id IN
                  (SELECT id FROM staging.staging_student_group WHERE deleted = 1 or active = 0);

      # ------------ student_group --------------------------------------------------
        student_group:
          sql:
            insert: >-
              INSERT INTO reporting.student_group (id, name, school_id, school_year, subject_id, creator, created, import_id)
                SELECT
                  ssg.id,
                  ssg.name,
                  ssg.school_id,
                  ssg.school_year,
                  ssg.subject_id,
                  ssg.creator,
                  ssg.created,
                  ssg.import_id
                FROM staging.staging_student_group ssg
                  LEFT JOIN reporting.student_group rsg ON rsg.id = ssg.id
                WHERE rsg.id IS NULL AND ssg.deleted = 0 AND ssg.active = 1;

            update: >-
              UPDATE reporting.student_group rsg
                JOIN staging.staging_student_group ssg ON ssg.id = rsg.id
              SET
                rsg.name = ssg.name,
                rsg.school_id = ssg.school_id,
                rsg.school_year = ssg.school_year,
                rsg.subject_id = ssg.subject_id,
                rsg.creator = ssg.creator,
                rsg.created = ssg.created,
                rsg.import_id = ssg.import_id
              WHERE ssg.deleted = 0 AND ssg.active = 1;

            delete: >-
              DELETE FROM reporting.student_group
                WHERE id IN
                  (SELECT id FROM staging.staging_student_group WHERE deleted = 1 or active = 0);

      # ############## School/District ###################################################################
      # ------------ school ------------------------------------------------------------------------------
        school:
          sql:
            insert: >-
              INSERT INTO reporting.school (id, natural_id, name, district_id, import_id)
               SELECT
                 ss.id,
                 ss.natural_id,
                 ss.name,
                 ss.district_id,
                 ss.import_id
               FROM staging.staging_school ss
                 LEFT JOIN reporting.school rs ON rs.id = ss.id
               WHERE rs.id IS NULL AND ss.deleted = 0;

            update: >-
              UPDATE reporting.school rs
                JOIN staging.staging_school ss ON ss.id = rs.id
              SET rs.name = ss.name,
                rs.district_id = ss.district_id,
                rs.import_id = ss.import_id
              WHERE ss.deleted = 0;

            delete: >-
              DELETE FROM reporting.school WHERE id IN (SELECT id FROM staging.staging_school WHERE deleted = 1);

      # ------------ district ------------------------------------------------------------------------------
        district:
          sql:
            insert: >-
              INSERT INTO reporting.district(id, natural_id,name)
                SELECT
                  sd.id,
                  sd.natural_id,
                  sd.name
                FROM staging.staging_district sd
                  LEFT JOIN reporting.district rd ON rd.id = sd.id
                WHERE rd.id IS NULL;

            update: >-
              UPDATE reporting.district d
                JOIN staging.staging_district sd ON sd.id = d.id
              SET d.name = sd.name;

            delete: >-
              DELETE rd FROM reporting.district rd
                WHERE id in (SELECT district_id from staging.staging_school WHERE deleted = 1)
                    AND NOT EXISTS(SELECT id from reporting.school WHERE district_id = rd.id);

      # ############## Student  ###################################################################
      # ------------ student_ethnicity -----------------------------------------------------------------------
        student_ethnicity:
          sql:
            insert: >-
              INSERT INTO reporting.student_ethnicity (student_id, ethnicity_id)
                SELECT
                  sue.student_id,
                  sue.ethnicity_id
                FROM staging.staging_student_ethnicity sue
                  LEFT JOIN reporting.student_ethnicity rse
                    ON (rse.student_id = sue.student_id AND rse.ethnicity_id = sue.ethnicity_id)
                WHERE rse.student_id IS NULL;

            deleteAsPartOfParentUpdate: >-
             DELETE rse FROM reporting.student_ethnicity rse
                WHERE student_id in (select student_id from staging.staging_student where deleted = 0)
                     AND NOT EXISTS(SELECT student_id FROM staging.staging_student_ethnicity
                            WHERE student_id = rse.student_id AND ethnicity_id = rse.ethnicity_id);

            delete: >-
              DELETE FROM reporting.student_ethnicity
                WHERE student_id IN (SELECT id FROM staging.staging_student WHERE deleted = 1);

      # ------------ student -----------------------------------------------------------------------
        student:
          sql:
            insert: >-
              INSERT INTO reporting.student (id, ssid, last_or_surname, first_name, middle_name, gender_id, first_entry_into_us_school_at,
                                             lep_entry_at, lep_exit_at, birthday, import_id)
                SELECT
                  ss.id,
                  ss.ssid,
                  ss.last_or_surname,
                  ss.first_name,
                  ss.middle_name,
                  ss.gender_id,
                  ss.first_entry_into_us_school_at,
                  ss.lep_entry_at,
                  ss.lep_exit_at,
                  ss.birthday,
                  ss.import_id
                FROM staging.staging_student ss
                  LEFT JOIN reporting.student rs ON rs.id = ss.id
                WHERE rs.id IS NULL and ss.deleted = 0;

            update: >-
              UPDATE reporting.student rs
                JOIN staging.staging_student ss ON ss.id = rs.id
              SET
                rs.last_or_surname = ss.last_or_surname,
                rs.first_name = ss.first_name,
                rs.middle_name = ss.middle_name,
                rs.gender_id = ss.gender_id,
                rs.first_entry_into_us_school_at = ss.first_entry_into_us_school_at,
                rs.lep_entry_at = ss.lep_entry_at,
                rs.lep_exit_at = ss.lep_exit_at,
                rs.birthday = ss.birthday,
                rs.import_id = ss.import_id
              WHERE ss.deleted = 0

            delete: >-
              DELETE FROM reporting.student
                WHERE id in (SELECT id FROM staging.staging_student WHERE deleted = 1);

      # ############## Assessment  ###################################################################
      # ------------ asmt_score -----------------------------------------------------------------------
        asmt_score:
          sql:
            insert: >-
              INSERT INTO reporting.asmt_score ( asmt_id, cut_point_1, cut_point_2, cut_point_3, min_score, max_score)
                SELECT
                  sas.asmt_id,
                  sas.cut_point_1,
                  sas.cut_point_2,
                  sas.cut_point_3,
                  sas.min_score,
                  sas.max_score
                FROM staging.staging_asmt_score sas
                  LEFT JOIN reporting.asmt_score ras ON ras.asmt_id = sas.asmt_id
                WHERE ras.asmt_id IS NULL;

            update: >-
              UPDATE reporting.asmt_score ras
                JOIN staging.staging_asmt_score sas ON ras.asmt_id = sas.asmt_id
              SET
                ras.cut_point_1 = sas.cut_point_1,
                ras.cut_point_2 = sas.cut_point_2,
                ras.cut_point_3 = sas.cut_point_3,
                ras.min_score   = sas.min_score,
                ras.max_score   = sas.max_score;

            deleteAsPartOfParentUpdate: >-
              DELETE rs FROM reporting.asmt_score rs
                WHERE rs.asmt_id in (select asmt_id from staging.staging_asmt where deleted = 0)
                    AND NOT EXISTS(SELECT asmt_id FROM staging.staging_asmt_score WHERE asmt_id = rs.asmt_id);

            delete: >-
              DELETE FROM reporting.asmt_score
                WHERE asmt_id IN (SELECT id FROM staging.staging_asmt WHERE deleted = 1);

      # ------------ item -----------------------------------------------------------------------
        item:
          sql:
            insert: >-
              INSERT INTO reporting.item ( id, claim_id, target_id, natural_id, asmt_id, math_practice, allow_calc, dok_id,
                                           difficulty, max_points)
                SELECT
                  si.id,
                  si.claim_id,
                  si.target_id,
                  si.natural_id,
                  si.asmt_id,
                  si.math_practice,
                  si.allow_calc,
                  si.dok_id,
                  si.difficulty,
                  si.max_points
                FROM staging.staging_item si
                  LEFT JOIN reporting.item ri ON ri.id = si.id
                WHERE ri.id IS NULL;

            update: >-
              UPDATE reporting.item ri
                JOIN staging.staging_item si ON ri.id = si.id
              SET
                ri.claim_id      = si.claim_id,
                ri.target_id     = si.target_id,
                ri.asmt_id       = si.asmt_id,
                ri.math_practice = si.math_practice,
                ri.allow_calc    = si.allow_calc,
                ri.dok_id        = si.dok_id,
                ri.difficulty    = si.difficulty,
                ri.max_points    = si.max_points;

            deleteAsPartOfParentUpdate: >-
              DELETE ri FROM reporting.item ri
                WHERE ri.asmt_id in (select id from staging.staging_asmt where deleted = 0)
                    AND  NOT EXISTS(SELECT id FROM staging.staging_item WHERE id = ri.id);

            delete: >-
              DELETE FROM reporting.item
                WHERE asmt_id IN (SELECT id FROM staging.staging_asmt WHERE deleted = 1);

      # ------------ asmt -----------------------------------------------------------------------
        asmt:
          sql:
            insert: >-
              INSERT INTO reporting.asmt (id, natural_id, grade_id, type_id, subject_id, school_year, name,
                                          label, version, import_id)
                SELECT
                  sa.id,
                  sa.natural_id,
                  sa.grade_id,
                  sa.type_id,
                  sa.subject_id,
                  sa.school_year,
                  sa.name,
                  sa.label,
                  sa.version,
                  sa.import_id
                FROM staging.staging_asmt sa
                  LEFT JOIN reporting.asmt ra ON ra.id = sa.id
                WHERE ra.id IS NULL and sa.deleted = 0;

            update: >-
              UPDATE reporting.asmt ra
                JOIN staging.staging_asmt sa ON sa.id = ra.id
              SET
                ra.grade_id    = sa.grade_id,
                ra.type_id     = sa.type_id,
                ra.subject_id  = sa.subject_id,
                ra.school_year = sa.school_year,
                ra.name        = sa.name,
                ra.label       = sa.label,
                ra.version     = sa.version,
                ra.import_id   = sa.import_id
              WHERE sa.deleted = 0;

            delete: >-
                DELETE FROM reporting.asmt
                  WHERE id IN (SELECT id FROM staging.staging_asmt WHERE deleted = 1);