package org.opentestsystem.rdw.ingest.migrate.reporting.step;

import org.opentestsystem.rdw.ingest.common.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlCopyWarehouseToStagingRepository;
import org.opentestsystem.rdw.migrate.common.config.MigrateWarehouseToStagingSqlConfiguration;
import org.opentestsystem.rdw.migrate.common.step.SqlListExecutionStep;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;

/**
 * Configuration for batch steps responsible for moving the data from the warehouse to staging
 */
@Configuration
public class WarehouseToStagingStepsConfig {
    private final StepBuilderFactory stepBuilderFactory;
    private final SqlCopyWarehouseToStagingRepository repository;
    private final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration;
    private final SqlListExecutionRepository sqlListExecutionRepository;

    static final String StageCodesStepName = "stageCodesStep";
    static final String StageOrganizationsStepName = "stageOrganizationsStep";
    static final String StageEmbargoStepName = "stageEmbargoStep";
    static final String StageGroupsStepName = "stageGroupsStep";
    static final String StagePackageStepName = "stagePackageStep";
    static final String StageExamStep = "stageExamStep";
    static final String stepTruncateStageName = "stepTruncateStage";

    @Autowired
    public WarehouseToStagingStepsConfig(final StepBuilderFactory stepBuilderFactory,
                                         final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration,
                                         final SqlCopyWarehouseToStagingRepository repository,
                                         final SqlListExecutionRepository sqlListExecutionRepository) {

        this.stepBuilderFactory = stepBuilderFactory;
        this.warehouseToStagingSqlConfiguration = warehouseToStagingSqlConfiguration;
        this.repository = repository;
        this.sqlListExecutionRepository = sqlListExecutionRepository;
    }

    // Code entities, in the order to be staged due to the dependencies noted below
    static final List<String> codesEntities = newArrayList("common_core_standard",
            "grade", "completeness", "administration_condition", "ethnicity", "gender", "accommodation",
            "school_year",
            "claim", "depth_of_knowledge", "math_practice", "item_trait_score",
            "target", //depends on claim
            "accommodation_translation" // depends on accommodation
    );

    @Bean
    public Step stageCodesStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        for (final String entity : codesEntities) {
            sqlsBuilder.addNext(entity);
        }

        return stepBuilderFactory.get(StageCodesStepName)
                .tasklet(new SqlCopyCodesExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step stageOrganizationsStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        sqlsBuilder.addNext("district_group")
                .addNext("district_group_by_update_import_id")
                .addNext("district")
                .addNext("district_by_update_import_id")
                .addNext("school_group")
                .addNext("school_group_by_update_import_id")
                .addNext("school")
                .addNext("school_by_update_import_id");

        return stepBuilderFactory.get(StageOrganizationsStepName)
                .tasklet(new SqlCopyExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step stageEmbargoStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        sqlsBuilder.addNext("district_embargo");

        return stepBuilderFactory.get(StageEmbargoStepName)
                .tasklet(new SqlCopyEmbargoExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step stageGroupsStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        sqlsBuilder.addNext("student")
                .addNext("student_by_update_import_id")
                .addNext("student_ethnicity")
                .addNext("student_ethnicity_by_update_import_id")
                .addNext("student_group")
                .addNext("student_group_by_update_import_id")
                .addNext("student_group_membership")
                .addNext("user_student_group")
                .addNext("user_student_group_by_update_import_id");

        return stepBuilderFactory.get(StageGroupsStepName)
                .tasklet(new SqlCopyExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step stagePackageStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        sqlsBuilder.addNext("asmt")
                .addNext("asmt_by_update_import_id")
                .addNext("asmt_score")
                .addNext("asmt_score_by_update_import_id")
                .addNext("item")
                .addNext("item_by_update_import_id")
                .addNext("item_common_core_standard")
                .addNext("item_common_core_standard_by_update_import_id")
                .addNext("item_other_target")
                .addNext("item_other_target_by_update_import_id");

        return stepBuilderFactory.get(StagePackageStepName)
                .tasklet(new SqlCopyExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step stageExamStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities())
                .addNext("exam")
                .addNext("exam_by_update_import_id")
                .addNext("exam_item")
                .addNext("exam_item_by_update_import_id")
                .addNext("exam_available_accommodation")
                .addNext("exam_available_accommodation_by_update_import_id")
                .addNext("exam_claim_score")
                .addNext("exam_claim_score_by_update_import_id");

        return stepBuilderFactory.get(StageExamStep)
                .tasklet(new SqlCopyExecutionStep(repository, sqlsBuilder.build()))
                .build();
    }

    @Bean
    public Step truncateBeforeStageStep() {
        return stepBuilderFactory.get(stepTruncateStageName + "Before")
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        warehouseToStagingSqlConfiguration.getTruncateStageList())).build();
    }

    @Bean
    public Step truncateAfterStageStep() {
        return stepBuilderFactory.get(stepTruncateStageName + "After")
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        warehouseToStagingSqlConfiguration.getTruncateStageList())).build();
    }
}
