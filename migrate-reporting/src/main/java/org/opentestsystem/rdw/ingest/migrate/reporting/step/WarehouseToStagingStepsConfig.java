package org.opentestsystem.rdw.ingest.migrate.reporting.step;

import org.opentestsystem.rdw.ingest.migrate.reporting.MigrateWarehouseToStagingSqlConfiguration;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlCopyWarehouseToStagingRepository;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.CODES;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.EXAM;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.ORGANIZATION;

/**
 * Configuration for batch steps responsible for moving the data from staging to reporting
 */
@Configuration
public class WarehouseToStagingStepsConfig {
    private final StepBuilderFactory stepBuilderFactory;
    private final SqlCopyWarehouseToStagingRepository repository;
    private final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration;

    public static final String StageCodesStepName = "stageCodesStep";
    public static final String StageOrganizationsStepName = "stageOrganizationsStep";


    @Autowired
    public WarehouseToStagingStepsConfig(final StepBuilderFactory stepBuilderFactory,
                                         final MigrateWarehouseToStagingSqlConfiguration warehouseToStagingSqlConfiguration,
                                         final SqlCopyWarehouseToStagingRepository repository) {

        this.stepBuilderFactory = stepBuilderFactory;
        this.warehouseToStagingSqlConfiguration = warehouseToStagingSqlConfiguration;
        this.repository = repository;
    }

    // Code entities, in the order to be staged due to the dependencies noted below
    private static final List<String> codesEntities = newArrayList( "common_core_standard",
            "grade", "completeness", "administration_condition", "ethnicity", "gender", "accommodation",
            "claim", "depth_of_knowledge", "math_practice", "item_trait_score",
            "target", //depends on claim
            "item_difficulty_cuts", //depends on grade
            "language",
            "accommodation_translation" // depends on accommodation and language
    );

    @Bean
    public Step stageCodesStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        for (final String entity : codesEntities) {
            sqlsBuilder.addNext(entity);
        }

        return stepBuilderFactory.get(StageCodesStepName)
                .tasklet(new SqlCopyExecutionStep(newArrayList(CODES),
                        repository,
                        sqlsBuilder.build())
                ).build();
    }

    @Bean
    public Step stageOrganizationsStep() {
        final SqlCopyBuilder sqlsBuilder = new SqlCopyBuilder(warehouseToStagingSqlConfiguration.getEntities());

        sqlsBuilder.addNext("district").addNext("school");

        return stepBuilderFactory.get(StageOrganizationsStepName)
                .tasklet(new SqlCopyExecutionStep(newArrayList(EXAM, ORGANIZATION),
                        repository,
                        sqlsBuilder.build())
                ).build();
    }



}
