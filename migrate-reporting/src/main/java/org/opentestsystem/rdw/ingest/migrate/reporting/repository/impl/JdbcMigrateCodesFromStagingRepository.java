package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.opentestsystem.rdw.ingest.migrate.reporting.repository.MigrateCodesFromStagingRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

/**
 * Jdbc implementation of {@link MigrateCodesFromStagingRepository}.
 */
@Repository
class JdbcMigrateCodesFromStagingRepository implements MigrateCodesFromStagingRepository {

    @Autowired
    @Qualifier("reportingJdbcTemplate")
    private NamedParameterJdbcTemplate jdbcTemplate;

    @Autowired
    private MigrateStagingToWarehouseSqlConfiguration sqls;

    private final String[] codes = {"gender", "accommodation", "subject_claim_score", "item_difficulty_cuts", "administration_condition",
            "claim", "math_practice", "ethnicity", "completeness", "depth_of_knowledge", "item_trait_score", "target"};

    @Transactional
    @Override
    public void upsertCodes() {

        for (final String code : codes) {
            jdbcTemplate
                    .getJdbcOperations()
                    .execute(sqls.getEntities().get(code).getUpdate());

            jdbcTemplate
                    .getJdbcOperations()
                    .execute(sqls.getEntities().get(code).getInsert());
        }
    }

    @Transactional
    @Override
    public void deleteCodes() {
        for (final String code : codes) {
            jdbcTemplate
                    .getJdbcOperations()
                    .execute(sqls.getEntities().get(code).getDelete());

        }
    }
}