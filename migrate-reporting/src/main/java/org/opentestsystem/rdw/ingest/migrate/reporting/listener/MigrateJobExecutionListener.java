package org.opentestsystem.rdw.ingest.migrate.reporting.listener;

import org.opentestsystem.rdw.ingest.migrate.reporting.MigrateStatus;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.ReportingMigrateRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.batch.core.JobExecution;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.listener.JobExecutionListenerSupport;
import org.springframework.beans.factory.annotation.Autowired;

import static org.opentestsystem.rdw.ingest.migrate.reporting.JobParams.fistImportId;
import static org.opentestsystem.rdw.ingest.migrate.reporting.JobParams.lastImportId;
import static org.springframework.batch.core.ExitStatus.COMPLETED;
import static org.springframework.batch.core.ExitStatus.FAILED;

/**
 * MigrateJobExecutionListener
 * Called when the job is complete.
 */
public class MigrateJobExecutionListener extends JobExecutionListenerSupport {

    private static final Logger logger = LoggerFactory.getLogger(MigrateJobExecutionListener.class);
    private ReportingMigrateRepository reportingMigrateRepository;

    @Autowired
    void setReportingMigrateRepository(final ReportingMigrateRepository reportingMigrateRepository) {
        this.reportingMigrateRepository = reportingMigrateRepository;
    }


    @Override
    public void beforeJob(final JobExecution jobExecution) {
        JobParameters jobParameters = jobExecution.getJobParameters();
        reportingMigrateRepository.create(jobExecution.getJobId(), MigrateStatus.STARTED, jobParameters.getLong(fistImportId), jobParameters.getLong(lastImportId));
        logger.info("Migrate Job id " + jobExecution.getJobId() + "] is launched]");
    }

    @Override
    public void afterJob(final JobExecution jobExecution) {
        //TODO: handled other job exit status
        final MigrateStatus status = jobExecution.getExitStatus().equals(COMPLETED) ? MigrateStatus.COMPLETED :
                jobExecution.getExitStatus().equals(FAILED) ? MigrateStatus.FAILED : MigrateStatus.ABANDONED;

        reportingMigrateRepository.updateStatusById(jobExecution.getJobId(), status);
        logger.info("Migrate Job id " + jobExecution.getJobId() + "] is complete with status [" + jobExecution.getExitStatus() + "]");
    }
}
