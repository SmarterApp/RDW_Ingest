package org.opentestsystem.rdw.ingest.migrate.reporting.step;

import com.google.common.collect.Lists;
import org.opentestsystem.rdw.ingest.migrate.reporting.MigrateStagingToWarehouseSqlConfiguration;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlListExecutionRepository;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.CODES;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.EXAM;
import static org.opentestsystem.rdw.ingest.common.model.ImportContent.PACKAGE;

/**
 * Configuration for batch steps responsible for moving the data from staging to reporting
 */
@Configuration
public class StagingToReportingStepsConfig {
    private final StepBuilderFactory stepBuilderFactory;
    private final SqlListExecutionRepository sqlListExecutionRepository;
    private final MigrateStagingToWarehouseSqlConfiguration stagingToWarehouseSqlConfiguration;

    public static final String upsertCodesStepName = "upsertCodesStep";
    public static final String deleteCodesStepName = "deleteCodesStep";
    public static final String deleteEntitiesStepName = "deleteEntitiesStep";
    public static final String upsertOrganizationsStepName = "upsertOrganizationsStep";
    public static final String upsertAsmtsStepName = "upsertAsmtsStep";

    @Autowired
    public StagingToReportingStepsConfig(final StepBuilderFactory stepBuilderFactory,
                                         final MigrateStagingToWarehouseSqlConfiguration stagingToWarehouseSqlConfiguration,
                                         final SqlListExecutionRepository sqlListExecutionRepository) {

        this.stepBuilderFactory = stepBuilderFactory;
        this.stagingToWarehouseSqlConfiguration = stagingToWarehouseSqlConfiguration;
        this.sqlListExecutionRepository = sqlListExecutionRepository;
    }

    @Bean
    public Step deleteEntitiesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToWarehouseSqlConfiguration.getEntities());
        // main entities in the order to be migrated due to the dependencies
        final List<String> entities = newArrayList(
                "district",
                "school",
                "asmt",
                "item",
                "asmt_score",
                "student",
                "student_ethnicity",
                "student_group",
                "user_student_group",
                "student_group_membership",
                "exam",
                "exam_item",
                "exam_available_accommodation",
                "iab_exam",
                "iab_exam_item",
                "iab_exam_available_accommodation");

        for (final String entity : Lists.reverse(entities)) {
            sqlsBuilder.addNext(entity, "delete");
        }
        return stepBuilderFactory.get(deleteEntitiesStepName)
                //TODO: add SCHOOL and GROUPS when they are defined
                .tasklet(new SqlListExecutionStep(newArrayList(PACKAGE, EXAM),
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertOrganizationsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToWarehouseSqlConfiguration.getEntities());
        sqlsBuilder.addNext("district", "update")
                .addNext("district", "insert")
                .addNext("school", "update")
                .addNext("school", "insert");

        return stepBuilderFactory.get(upsertOrganizationsStepName)
                //TODO: add SCHOOL
                .tasklet(new SqlListExecutionStep(newArrayList(EXAM),
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertAsmtsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToWarehouseSqlConfiguration.getEntities());
        sqlsBuilder.addNext("asmt", "update")
                .addNext("asmt", "insert")
                .addNext("item", "update")
                .addNext("item", "insert")
                .addNext("item", "deleteAsPartOfParentUpdate")
                .addNext("asmt_score", "update")
                .addNext("asmt_score", "insert")
                .addNext("asmt_score", "deleteAsPartOfParentUpdate");

        return stepBuilderFactory.get(upsertAsmtsStepName)
                //TODO: discuss how we want to handle 'stubbed out' asmt
                .tasklet(new SqlListExecutionStep(newArrayList(EXAM, PACKAGE),
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }


    // Code entities, in the order to be migrated due to the dependencies noted below
    static final List<String> codesEntities = newArrayList(
            "grade", "completeness", "administration_condition", "ethnicity", "gender", "accommodation",
            "claim", "depth_of_knowledge", "math_practice", "item_trait_score",
            "target", //depends on claim
            "item_difficulty_cuts" //depends on grade
    );

    @Bean
    public Step upsertCodesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToWarehouseSqlConfiguration.getEntities());
        for (final String entity : codesEntities) {
            sqlsBuilder.addNext(entity, "update").addNext(entity, "insert");
        }
        return stepBuilderFactory.get(upsertCodesStepName)
                .tasklet(new SqlListExecutionStep(newArrayList(CODES),
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step deleteCodesStep() {
        //delete has to be in the reverse order from the insert
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToWarehouseSqlConfiguration.getEntities());
        for (final String entity : Lists.reverse(codesEntities)) {
            sqlsBuilder.addNext(entity, "delete");
        }
        return stepBuilderFactory.get(deleteCodesStepName)
                .tasklet(new SqlListExecutionStep(newArrayList(CODES),
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }
}
