package org.opentestsystem.rdw.ingest.migrate.reporting.step;

import com.google.common.collect.Lists;
import org.opentestsystem.rdw.ingest.common.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.common.util.SqlListBuilder;
import org.opentestsystem.rdw.migrate.common.config.MigrateStagingToReportingSqlConfiguration;
import org.opentestsystem.rdw.migrate.common.step.SqlListCodesExecutionStep;
import org.opentestsystem.rdw.migrate.common.step.SqlListExecutionStep;
import org.springframework.batch.core.Step;
import org.springframework.batch.core.configuration.annotation.StepBuilderFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

import static com.google.common.collect.Lists.newArrayList;

/**
 * Configuration for batch steps responsible for moving the data from staging to reporting
 */
@Configuration
public class StagingToReportingStepsConfig {
    private final StepBuilderFactory stepBuilderFactory;
    private final SqlListExecutionRepository sqlListExecutionRepository;
    private final MigrateStagingToReportingSqlConfiguration stagingToReportingSqlConfiguration;

    static final String upsertCodesStepName = "upsertCodesStep";
    static final String deleteCodesStepName = "deleteCodesStep";
    static final String deleteEntitiesStepName = "deleteEntitiesStep";
    static final String upsertOrganizationsStepName = "upsertOrganizationsStep";
    static final String upsertSubjectsStepName = "upsertSubjectsStep";
    static final String updateEmbargoStepName = "updateEmbargoStep";
    static final String upsertAsmtsStepName = "upsertAsmtsStep";
    static final String upsertNormsStepName = "upsertNormsStep";
    static final String upsertStudentsAndGroupsStepName = "upsertStudentsAndGroupsStep";
    static final String upsertExamsStepName = "upsertExamsStep";

    @Autowired
    public StagingToReportingStepsConfig(final StepBuilderFactory stepBuilderFactory,
                                         final MigrateStagingToReportingSqlConfiguration stagingToReportingSqlConfiguration,
                                         final SqlListExecutionRepository sqlListExecutionRepository) {

        this.stepBuilderFactory = stepBuilderFactory;
        this.stagingToReportingSqlConfiguration = stagingToReportingSqlConfiguration;
        this.sqlListExecutionRepository = sqlListExecutionRepository;
    }

    @Bean
    public Step deleteEntitiesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        // main entities in the order to be migrated due to the dependencies
        final List<String> entities = newArrayList(
                "district_group",
                "district",
                "school_group",
                "school",
                "asmt",
                "item",
                "item_other_target",
                "item_common_core_standard",
                "asmt_score",
                "asmt_target",
                "percentile",
                "percentile_score",
                "student",
                "student_ethnicity",
                "student_group",
                "user_student_group",
                "student_group_membership",
                "exam",
                "exam_item",
                "exam_target_score",
                "exam_available_accommodation");

        for (final String entity : Lists.reverse(entities)) {
            sqlsBuilder.addNext(entity, "delete");
        }
        return stepBuilderFactory.get(deleteEntitiesStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertSubjectsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("subject", "update")
                .addNext("subject", "insert")
                .addNext("subject_asmt_type", "deleteAsPartOfParentUpdate")
                .addNext("subject_asmt_type", "insert")
                .addNext("subject_asmt_type", "update")
                .addNext("subject_claim_score", "deleteAsPartOfParentUpdate")
                .addNext("subject_claim_score", "insert")
                .addNext("subject_claim_score", "update")
                .addNext("subject_translation", "deleteAsPartOfParentUpdate")
                .addNext("subject_translation", "insert")
                .addNext("subject_translation", "update")
                .addNext("target", "deleteAsPartOfParentUpdate") //target depends on claim
                .addNext("claim", "deleteAsPartOfParentUpdate")
                .addNext("claim", "insert")
                .addNext("target", "insert")
                .addNext("common_core_standard", "deleteAsPartOfParentUpdate")
                .addNext("common_core_standard", "insert")
                .addNext("depth_of_knowledge", "deleteAsPartOfParentUpdate")
                .addNext("depth_of_knowledge", "insert")
                .addNext("depth_of_knowledge", "update");

        return stepBuilderFactory.get(upsertSubjectsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertOrganizationsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("district_group", "update")
                .addNext("district_group", "insert")
                .addNext("district", "update")
                .addNext("district", "insert")
                .addNext("school_group", "update")
                .addNext("school_group", "insert")
                .addNext("school", "update")
                .addNext("school", "insert");

        return stepBuilderFactory.get(upsertOrganizationsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step updateEmbargoStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("school_embargo", "update");

        return stepBuilderFactory.get(updateEmbargoStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertStudentsAndGroupsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("student", "update")
                .addNext("student", "insert")
                .addNext("student_ethnicity", "insert")
                .addNext("student_ethnicity", "deleteAsPartOfParentUpdate")
                .addNext("student_group", "update")
                .addNext("student_group", "insert")
                .addNext("user_student_group", "insert")
                .addNext("user_student_group", "deleteAsPartOfParentUpdate")
                .addNext("student_group_membership", "insert")
                .addNext("student_group_membership", "deleteAsPartOfParentUpdate");

        return stepBuilderFactory.get(upsertStudentsAndGroupsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertAsmtsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("asmt", "update")
                .addNext("asmt", "insert")
                .addNext("asmt_score", "update")
                .addNext("asmt_score", "insert")
                .addNext("asmt_score", "deleteAsPartOfParentUpdate")
                .addNext("item", "update")
                .addNext("item", "insert")
                .addNext("item", "deleteAsPartOfParentUpdate")
                .addNext("item_common_core_standard", "insert")
                .addNext("item_common_core_standard", "deleteAsPartOfParentUpdate")
                .addNext("item_other_target", "insert")
                .addNext("item_other_target", "deleteAsPartOfParentUpdate")
                .addNext("asmt_target", "deleteAsPartOfParentUpdate")
                .addNext("asmt_target", "insert")
                .addNext("asmt_target", "insertIncluded");

        return stepBuilderFactory.get(upsertAsmtsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertNormsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("percentile", "update")
                .addNext("percentile", "insert")
                .addNext("percentile_score", "deleteAsPartOfParentUpdate")
                .addNext("percentile_score", "insert");

        return stepBuilderFactory.get(upsertNormsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step upsertExamsStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        sqlsBuilder.addNext("exam", "update")
                .addNext("exam", "insert")
                .addNext("exam_item", "update")
                .addNext("exam_item", "insert")
                .addNext("exam_item", "deleteAsPartOfParentUpdate")
                .addNext("exam_target_score", "update")
                .addNext("exam_target_score", "insert")
                .addNext("exam_target_score", "deleteAsPartOfParentUpdate")
                .addNext("exam_available_accommodation", "insert")
                .addNext("exam_available_accommodation", "deleteAsPartOfParentUpdate");


        return stepBuilderFactory.get(upsertExamsStepName)
                .tasklet(new SqlListExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    // Code entities, in the order to be migrated due to the dependencies noted below
    static final List<String> codesEntities = newArrayList(
            "grade", "elas", "completeness", "administration_condition", "ethnicity", "gender",
            "accommodation", "school_year", "math_practice", "accommodation_translation"
    );

    @Bean
    public Step upsertCodesStep() {
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        for (final String entity : codesEntities) {
            sqlsBuilder.addNext(entity, "update").addNext(entity, "insert");
        }
        return stepBuilderFactory.get(upsertCodesStepName)
                .tasklet(new SqlListCodesExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

    @Bean
    public Step deleteCodesStep() {
        //delete has to be in the reverse order from the insert
        final SqlListBuilder sqlsBuilder = new SqlListBuilder(stagingToReportingSqlConfiguration.getEntities());
        for (final String entity : Lists.reverse(codesEntities)) {
            sqlsBuilder.addNext(entity, "delete");
        }
        return stepBuilderFactory.get(deleteCodesStepName)
                .tasklet(new SqlListCodesExecutionStep(
                        sqlListExecutionRepository,
                        sqlsBuilder.build())).build();
    }

}
