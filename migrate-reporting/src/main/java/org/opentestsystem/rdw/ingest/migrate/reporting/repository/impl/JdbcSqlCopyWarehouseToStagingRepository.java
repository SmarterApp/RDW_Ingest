package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.opentestsystem.rdw.ingest.migrate.reporting.MigrateBatch;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlCopyWarehouseToStagingRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.step.SqlCopyStatements;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Map;

/**
 * Jdbc implementation of {@link SqlListExecutionRepository}.
 */
@Repository
class JdbcSqlCopyWarehouseToStagingRepository implements SqlCopyWarehouseToStagingRepository {

    private final NamedParameterJdbcTemplate reportingJdbcTemplate;
    private final NamedParameterJdbcTemplate warehouseJdbcTemplate;

    @Autowired
    public JdbcSqlCopyWarehouseToStagingRepository(NamedParameterJdbcTemplate reportingJdbcTemplate,
                                                   NamedParameterJdbcTemplate warehouseJdbcTemplate) {
        this.reportingJdbcTemplate = reportingJdbcTemplate;
        this.warehouseJdbcTemplate = warehouseJdbcTemplate;
    }

    @Transactional
    @Override
    public void execute(final List<SqlCopyStatements> copyStatementsList,
                        final MigrateBatch migrateBatch) {

        for (SqlCopyStatements sqlCopyStatements : copyStatementsList) {
            copyEntity(sqlCopyStatements.getWarehouseRead(),
                    sqlCopyStatements.getStagingInsert(),
                    migrateBatch);
        }
    }

    private void copyEntity(final String warehouseReadSql,
                            final String stagingInsertSql,
                            final MigrateBatch migrateBatch) {

        final List<Map<String, Object>> result = warehouseJdbcTemplate.queryForList(warehouseReadSql,
                new MapSqlParameterSource("start_import_id", migrateBatch.getMigrate().getFirstImportId())
                        .addValue("end_import_id", migrateBatch.getMigrate().getLastImportId()));

        if (result.isEmpty()) return;

        final MapSqlParameterSource[] stagingParams = new MapSqlParameterSource[result.size()];
        int i = 0;
        for (final Map<String, Object> row : result) {

            final MapSqlParameterSource parameterSource = new MapSqlParameterSource();
            for (final String col : row.keySet()) {
                parameterSource.addValue(col, row.get(col));
            }
            parameterSource.addValue("migrate_id", migrateBatch.getMigrate().getId());
            stagingParams[i++] = parameterSource;
        }
        reportingJdbcTemplate.batchUpdate(stagingInsertSql, stagingParams);
    }
}