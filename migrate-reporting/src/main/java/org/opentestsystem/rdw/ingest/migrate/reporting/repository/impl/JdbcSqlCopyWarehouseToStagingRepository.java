package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import com.google.common.base.Stopwatch;
import org.opentestsystem.rdw.ingest.migrate.reporting.MigrateBatch;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlCopyWarehouseToStagingRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.step.SqlCopyStatements;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Map;

import static java.lang.Math.min;

/**
 * Jdbc implementation of {@link SqlListExecutionRepository}.
 */
@Repository
class JdbcSqlCopyWarehouseToStagingRepository implements SqlCopyWarehouseToStagingRepository {
    private static final Logger logger = LoggerFactory.getLogger(JdbcSqlCopyWarehouseToStagingRepository.class);

    private final NamedParameterJdbcTemplate reportingJdbcTemplate;
    private final NamedParameterJdbcTemplate warehouseJdbcTemplate;

    @Autowired
    public JdbcSqlCopyWarehouseToStagingRepository(final NamedParameterJdbcTemplate reportingJdbcTemplate,
                                                   final NamedParameterJdbcTemplate warehouseJdbcTemplate) {
        this.reportingJdbcTemplate = reportingJdbcTemplate;
        this.warehouseJdbcTemplate = warehouseJdbcTemplate;
    }

    @Transactional
    @Override
    public void execute(final List<SqlCopyStatements> copyStatementsList,
                        final MigrateBatch migrateBatch) {

        for (final SqlCopyStatements sqlCopyStatements : copyStatementsList) {
            copyEntity(sqlCopyStatements.getWarehouseRead(),
                    sqlCopyStatements.getStagingInsert(),
                    migrateBatch);
        }
    }

    private void copyEntity(final String warehouseReadSql,
                            final String stagingInsertSql,
                            final MigrateBatch migrateBatch) {

        final Stopwatch stopwatch = Stopwatch.createStarted();
        final List<Map<String, Object>> result = warehouseJdbcTemplate.queryForList(warehouseReadSql,
                new MapSqlParameterSource("start_import_id", migrateBatch.getMigrate().getFirstImportId())
                        .addValue("end_import_id", migrateBatch.getMigrate().getLastImportId()));

        logger.debug("read from warehouse {} in {}",
                warehouseReadSql.substring(0, min(warehouseReadSql.length(), 80)).replaceAll("\n", ""), stopwatch.toString());
        stopwatch.reset().start();

        if (result.isEmpty()) {
            logger.debug("empty result");
            return;
        }

        final MapSqlParameterSource[] stagingParams = new MapSqlParameterSource[result.size()];
        int i = 0;
        for (final Map<String, Object> row : result) {

            final MapSqlParameterSource parameterSource = new MapSqlParameterSource();
            for (final String col : row.keySet()) {
                parameterSource.addValue(col, row.get(col));
            }
            parameterSource.addValue("migrate_id", migrateBatch.getMigrate().getId());
            stagingParams[i++] = parameterSource;
        }
        logger.debug("copy into batch params in {}", stopwatch.toString());
        stopwatch.reset().start();

        reportingJdbcTemplate.batchUpdate(stagingInsertSql, stagingParams);
        logger.debug("write into staging {} in {}",
                stagingInsertSql.substring(0, min(stagingInsertSql.length(), 80)).replaceAll("\n", ""), stopwatch.toString());
    }
}