package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlCopyWarehouseToStagingRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.step.SqlCopyStatements;
import org.opentestsystem.rdw.migrate.common.config.MigrateWarehouseToStagingSqlConfiguration;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Import;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.test.context.jdbc.SqlConfig;
import org.springframework.test.context.jdbc.SqlGroup;

import java.time.Instant;
import java.util.List;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.context.jdbc.Sql.ExecutionPhase.AFTER_TEST_METHOD;
import static org.springframework.test.context.jdbc.Sql.ExecutionPhase.BEFORE_TEST_METHOD;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTable;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;


@Import({MigrateWarehouseToStagingSqlConfiguration.class})
public class JdbcSqlCopyWarehouseToStagingRepositoryIT extends RepositoryIT {

    @Autowired
    private MigrateWarehouseToStagingSqlConfiguration sqlConfig;

    @Autowired
    private SqlCopyWarehouseToStagingRepository repository;

    @Autowired
    private JdbcTemplate reportingJdbcTemplate;

    @Test
    @SqlGroup({
            @Sql(executionPhase = BEFORE_TEST_METHOD, config = @SqlConfig(dataSource = "warehouseDatasource"),
                    statements = {"INSERT INTO import (id, status, content, contentType, digest) VALUES ( -99, 0, 1, 'type', 'digest')",
                            "INSERT INTO district (id, name, natural_id) VALUES (-22, 'Sample District 1', 'DistrictNaturalId');",
                            "INSERT INTO school (id, district_id, name, natural_id, import_id, update_import_id, created, updated) VALUES " +
                                    "(-27, -22, 'Sample School 1', 'SchoolNaturalId', 1, 1, '2017-07-18 19:45:33.966000', '2017-07-18 19:46:33.966000');"}),

            @Sql(executionPhase = AFTER_TEST_METHOD, config = @SqlConfig(dataSource = "warehouseDatasource"),
                    statements = {"DELETE FROM school;",
                            "DELETE FROM district WHERE id = -22;",
                            "DELETE FROM import WHERE id = -99;"})
    })
    public void itShouldCopy() {

        assertThat(countRowsInTable(reportingJdbcTemplate, "staging_district")).isEqualTo(0);

        List<SqlCopyStatements> copyStatementsList = newArrayList();
        copyStatementsList.add(new SqlCopyStatements(sqlConfig.getEntities().get("district").getSql().get("warehouseRead"),
                sqlConfig.getEntities().get("district").getSql().get("stagingInsert")));

        repository.execute(copyStatementsList, Instant.parse("2017-07-18T19:45:33.965Z"), Instant.parse("2017-07-18T19:45:33.966Z"), 1);

        assertThat(countRowsInTableWhere(reportingJdbcTemplate, "staging_district", "id=-22")).isEqualTo(1);
    }
}