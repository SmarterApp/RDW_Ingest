package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.SqlListExecutionRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.jdbc.Sql;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;


@Sql(scripts = {"classpath:MigrateCodesFromStagingSetup.sql"})
public class JdbcReportingRepositoryIT extends RepositoryIT {
    @Autowired
    SqlListExecutionRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Sql(statements = "INSERT INTO `reporting-test`.item_trait_score (id, dimension) VALUES (-1, 'test1')")
    @Test
    public void itShouldExecuteQueriesInTheGivenOrder() {
        assertThat(countRowsInTableWhere(jdbcTemplate, "`reporting-test`.item_trait_score", "dimension = 'update'")).isEqualTo(0);

        repository.execute(newArrayList(
                "UPDATE `reporting-test`.item_trait_score set dimension = 'update' WHERE id = -1",
                "DELETE FROM `reporting-test`.item_trait_score WHERE dimension = 'update'"));

        assertThat(countRowsInTableWhere(jdbcTemplate, "`reporting-test`.item_trait_score", "id = -1")).isEqualTo(0);
    }
}