package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.MigrateImportRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.jdbc.Sql;

import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;

@Sql(scripts = {"classpath:MigrateImportFromWarehouseSetup.sql"})
public class JdbcMigrateImportRepositoryIT extends RepositoryIT {

    @Autowired
    private MigrateImportRepository repository;

    @Test
    public void itShouldFindMaxImportId() {
        final Long defaultMaxImportId = -991L;
        final Optional<Long> max = repository.findMaxImportId();
        assertThat(max)
                .isPresent()
                .hasValue(defaultMaxImportId);
    }

    @Sql(statements = "DELETE FROM warehouse_test.import")
    @Test
    public void itShouldFindNothingForMaxImportId() {
        final Optional<Long> max = repository.findMaxImportId();
        assertThat(max).isEmpty();
    }

    @Test
    public void itShouldFindMinImportId() {
        final Long defaultMinImportId = -1010L;
        final Optional<Long> min = repository.findMinImportId();
        assertThat(min)
                .isPresent()
                .hasValue(defaultMinImportId);
    }

    @Sql(statements = "DELETE FROM warehouse_test.import")
    @Test
    public void itShouldFindNothingForMinImportId() {
        final Optional<Long> min = repository.findMinImportId();
        assertThat(min).isEmpty();
    }

    @Test
    public void itShouldFindLastMigratedImportId() {
        final Long defaultLastMigratedImportId = -1001L;
        final Optional<Long> last = repository.findLastMigratedImportId();
        assertThat(last)
                .isPresent()
                .hasValue(defaultLastMigratedImportId);
    }

    @Sql(statements = "DELETE FROM reporting_test.migrate")
    @Test
    public void itShouldFindNothingForLastMigratedImportId() {
        final Optional<Long> last = repository.findLastMigratedImportId();
        assertThat(last)
                .isEmpty();
    }

}