package org.opentestsystem.rdw.ingest.migrate.reporting;


import org.junit.Before;
import org.junit.Test;
import org.mockito.ArgumentCaptor;
import org.springframework.batch.core.Job;
import org.springframework.batch.core.JobParameters;
import org.springframework.batch.core.JobParametersInvalidException;
import org.springframework.batch.core.launch.JobLauncher;
import org.springframework.batch.core.repository.JobExecutionAlreadyRunningException;
import org.springframework.batch.core.repository.JobInstanceAlreadyCompleteException;
import org.springframework.batch.core.repository.JobRestartException;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

public class MigrateReportingJobRunnerTest {

    private JobLauncher jobLauncher;
    private Job job;
    private MigrateReportingJobRunner reportingJobRunner;

    @Before
    public void setUp() {
        jobLauncher = mock(JobLauncher.class);
        job = mock(Job.class);
        reportingJobRunner = new MigrateReportingJobRunner(jobLauncher, job);
    }

    @Test
    public void isShouldLaunchJob() throws JobParametersInvalidException, JobExecutionAlreadyRunningException, JobRestartException, JobInstanceAlreadyCompleteException {
        final ArgumentCaptor<Job> jobArgumentCaptor = ArgumentCaptor.forClass(Job.class);
        final ArgumentCaptor<JobParameters> jobParametersArgumentCaptor = ArgumentCaptor.forClass(JobParameters.class);

        reportingJobRunner.run();

        verify(jobLauncher).run(jobArgumentCaptor.capture(), jobParametersArgumentCaptor.capture());
        assertThat(jobArgumentCaptor.getValue()).isEqualTo(job);
        final JobParameters jobParameters = jobParametersArgumentCaptor.getValue();
        assertThat(jobParameters.getParameters()).containsKey("time");
    }

    @Test
    public void isShouldHandleExceptions() throws JobParametersInvalidException, JobExecutionAlreadyRunningException, JobRestartException, JobInstanceAlreadyCompleteException {
        when(jobLauncher.run(any(), any())).thenThrow(new RuntimeException());

        reportingJobRunner.run();

        verify(jobLauncher).run(any(), any());
    }
}