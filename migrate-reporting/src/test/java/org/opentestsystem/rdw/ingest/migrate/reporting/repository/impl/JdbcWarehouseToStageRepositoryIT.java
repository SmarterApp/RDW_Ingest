package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.WarehouseToStageRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;

import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;

public class JdbcWarehouseToStageRepositoryIT extends RepositoryIT {

    @Autowired
    private WarehouseToStageRepository repository;

    @Autowired
    private NamedParameterJdbcTemplate warehouseJdbcTemplate;

    @Autowired
    private NamedParameterJdbcTemplate reportingJdbcTemplate;

    @Test
    public void shouldFindWarehouseSubjects() throws Exception {
        final List<Map<String, Object>> subjects = repository.findWarehouseSubjects();
        assertThat(countRowsInTable(warehouseJdbcTemplate, "subject")).isEqualTo(subjects.size());
    }

    @Test
    public void shouldFindReportingSubjects() throws Exception {
        final List<Map<String, Object>> subjects = repository.findReportingSubjects();
        assertThat(countRowsInTable(reportingJdbcTemplate, "subject")).isEqualTo(subjects.size());
    }

    @Test
    public void shouldFindWarehouseAsmtTypes() throws Exception {
        final List<Map<String, Object>> asmtTypes = repository.findWarehouseAsmtTypes();
        assertThat(countRowsInTable(warehouseJdbcTemplate, "asmt_type")).isEqualTo(asmtTypes.size());
    }

    @Test
    public void shouldFindReportingAsmtTypes() throws Exception {
        final List<Map<String, Object>> asmtTypes = repository.findReportingAsmtTypes();
        assertThat(countRowsInTable(reportingJdbcTemplate, "asmt_type")).isEqualTo(asmtTypes.size());
    }

    @Test
    public void shouldFindWarehouseSubjectClaimScores() throws Exception {
        final List<Map<String, Object>> subjectClaimScores = repository.findWarehouseSubjectClaimScores();
        assertThat(countRowsInTable(warehouseJdbcTemplate, "subject_claim_score")).isEqualTo(subjectClaimScores.size());
    }

    @Test
    public void shouldFindReportingSubjectClaimScores() throws Exception {
        final List<Map<String, Object>> subjectClaimScores = repository.findReportingSubjectClaimScores();
        assertThat(countRowsInTable(reportingJdbcTemplate, "subject_claim_score"))
                .isEqualTo(subjectClaimScores.size());
    }

    static private Integer countRowsInTable(final NamedParameterJdbcTemplate jdbcTemplate, final String table) {
        return jdbcTemplate.getJdbcOperations().queryForObject("SELECT COUNT(0) FROM " + table, Integer.class);
    }
}