package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.common.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.jdbc.Sql;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;

public class JdbcSqlListExecutionRepositoryIT extends RepositoryIT {
    @Autowired
    SqlListExecutionRepository repository;

    @Autowired
    private JdbcTemplate reportingJdbcTemplate;

    @Sql(statements = "INSERT INTO school_year (year) VALUES (1996)")
    @Test
    public void itShouldExecuteQueriesInTheGivenOrder() {
        assertThat(countRowsInTableWhere(reportingJdbcTemplate, "school_year", "year = 1997")).isEqualTo(0);

        repository.execute(newArrayList(
                "UPDATE school_year set year = 1997 WHERE year = 1996",
                "INSERT INTO school_year (year) VALUES (1996)"));

        assertThat(countRowsInTableWhere(reportingJdbcTemplate, "school_year", "year = 1996 or year = 1997")).isEqualTo(2);
    }
}
