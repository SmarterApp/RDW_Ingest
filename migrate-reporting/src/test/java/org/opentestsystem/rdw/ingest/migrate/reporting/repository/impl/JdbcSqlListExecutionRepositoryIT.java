package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.common.repository.SqlListExecutionRepository;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.jdbc.Sql;

import static com.google.common.collect.Lists.newArrayList;
import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;


@Sql(scripts = {"classpath:MigrateCodesFromStagingSetup.sql"})
public class JdbcSqlListExecutionRepositoryIT extends RepositoryIT {
    @Autowired
    SqlListExecutionRepository repository;

    @Autowired
    private JdbcTemplate reportingJdbcTemplate;

    @Sql(statements = "INSERT INTO item_trait_score (id, dimension) VALUES (-1, 'test1')")
    @Test
    public void itShouldExecuteQueriesInTheGivenOrder() {
        assertThat(countRowsInTableWhere(reportingJdbcTemplate, "item_trait_score", "dimension = 'update'")).isEqualTo(0);

        repository.execute(newArrayList(
                "UPDATE item_trait_score set dimension = 'update' WHERE id = -1",
                "DELETE FROM item_trait_score WHERE dimension = 'update'"));

        assertThat(countRowsInTableWhere(reportingJdbcTemplate, "item_trait_score", "id = -1")).isEqualTo(0);
    }
}