package org.opentestsystem.rdw.ingest.migrate.reporting;

import org.springframework.jdbc.core.JdbcTemplate;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTableWhere;

/**
 * A helper class that counts rows in a table before the test and
 * can be later used to compare the results after the test
 */
public class TableTestCountHelper {
    final private String tableName;
    final private String where;
    final private int countBefore;
    final private int expectedCountChangeAfterTest;
    final private JdbcTemplate jdbcTemplate;

    /**
     * Constructor
     *
     * @param jdbcTemplate the {@link JdbcTemplate}
     * @param tableName the name of the table to count rows
     * @param expectedCountChangeAfterTest the expected change to the count after a test
     * @param where the where clause to use in the count. It is the same clause that is used in the before and after a test
     */
    public TableTestCountHelper(final JdbcTemplate jdbcTemplate,
                                final String tableName,
                                final int expectedCountChangeAfterTest,
                                final String where) {
        this.where = where;
        this.tableName = tableName;
        this.expectedCountChangeAfterTest = expectedCountChangeAfterTest;
        this.countBefore = countRowsInTableWhere(jdbcTemplate, this.tableName, where);
        this.jdbcTemplate = jdbcTemplate;
    }

    public void verify() {
        assertThat(countRowsInTableWhere(jdbcTemplate, tableName, where))
                .as("check TABLE: %s WHERE: ", tableName, where ).isEqualTo(countBefore + expectedCountChangeAfterTest);
    }

    /**
     * A helper method to verify all counts
     *
     * @param counts
     */
    public static void verifyTableCountsAfterTest(final List<TableTestCountHelper> counts) {
        for (final TableTestCountHelper tableTestCount : counts) {
            tableTestCount.verify();
        }
    }
}
