package org.opentestsystem.rdw.ingest.migrate.reporting.repository.impl;

import org.junit.Test;
import org.opentestsystem.rdw.ingest.migrate.reporting.RepositoryIT;
import org.opentestsystem.rdw.ingest.migrate.reporting.repository.MigrateCodesFromStagingRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.jdbc.Sql;

import static org.assertj.core.api.Assertions.assertThat;
import static org.springframework.test.jdbc.JdbcTestUtils.countRowsInTable;

@ContextConfiguration(classes = JdbcMigrateCodesFromStagingRepository.class)
@Sql(scripts = {"classpath:MigrateCodesFromStagingSetup.sql"})
public class JdbcMigrateCodesFromStagingRepositoryIT extends RepositoryIT {

    @Autowired
    MigrateCodesFromStagingRepository repository;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    @Test
    public void itShouldUpsert() {
        final int completenessCountBefore = countRowsInTable(jdbcTemplate, "`reporting-test`.completeness");
        repository.upsertCodes();
        assertThat(countRowsInTable(jdbcTemplate, "`reporting-test`.completeness")).isEqualTo(completenessCountBefore + 3);

        //TODO: add more codes and tests
    }
}